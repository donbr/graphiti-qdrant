{
  "title": "Agent User Interaction (AG-UI)",
  "source_url": null,
  "content": "Example of using Pydantic AI agents with the [AG-UI Dojo](https://github.com/ag-ui-protocol/ag-ui/tree/main/apps/dojo) example app.\n\nSee the [AG-UI docs](../../ui/ag-ui/) for more information about the AG-UI integration.\n\nDemonstrates:\n\n- [AG-UI](../../ui/ag-ui/)\n- [Tools](../../tools/)\n\n## Prerequisites\n\n- An [OpenAI API key](https://help.openai.com/en/articles/4936850-where-do-i-find-my-openai-api-key)\n\n## Running the Example\n\nWith [dependencies installed and environment variables set](../setup/#usage) you will need two command line windows.\n\n### Pydantic AI AG-UI backend\n\nSetup your OpenAI API Key\n\n```bash\nexport OPENAI_API_KEY=<your api key>\n\n```\n\nStart the Pydantic AI AG-UI example backend.\n\n```bash\npython -m pydantic_ai_examples.ag_ui\n\n```\n\n```bash\nuv run -m pydantic_ai_examples.ag_ui\n\n```\n\n### AG-UI Dojo example frontend\n\nNext run the AG-UI Dojo example frontend.\n\n1. Clone the [AG-UI repository](https://github.com/ag-ui-protocol/ag-ui)\n\n   ```shell\n   git clone https://github.com/ag-ui-protocol/ag-ui.git\n\n   ```\n\n1. Change into to the `ag-ui/typescript-sdk` directory\n\n   ```shell\n   cd ag-ui/sdks/typescript\n\n   ```\n\n1. Run the Dojo app following the [official instructions](https://github.com/ag-ui-protocol/ag-ui/tree/main/apps/dojo#development-setup)\n\n1. Visit <http://localhost:3000/pydantic-ai>\n\n1. Select View `Pydantic AI` from the sidebar\n\n## Feature Examples\n\n### Agentic Chat\n\nThis demonstrates a basic agent interaction including Pydantic AI server side tools and AG-UI client side tools.\n\nIf you've [run the example](#running-the-example), you can view it at <http://localhost:3000/pydantic-ai/feature/agentic_chat>.\n\n#### Agent Tools\n\n- `time` - Pydantic AI tool to check the current time for a time zone\n- `background` - AG-UI tool to set the background color of the client window\n\n#### Agent Prompts\n\n```text\nWhat is the time in New York?\n\n```\n\n```text\nChange the background to blue\n\n```\n\nA complex example which mixes both AG-UI and Pydantic AI tools:\n\n```text\nPerform the following steps, waiting for the response of each step before continuing:\n1. Get the time\n2. Set the background to red\n3. Get the time\n4. Report how long the background set took by diffing the two times\n\n```\n\n#### Agentic Chat - Code\n\n[Learn about Gateway](../../gateway) [ag_ui/api/agentic_chat.py](https://github.com/pydantic/pydantic-ai/blob/main/examples/pydantic_ai_examples/ag_ui/api/agentic_chat.py)\n\n```python\n\"\"\"Agentic Chat feature.\"\"\"\n\nfrom __future__ import annotations\n\nfrom datetime import datetime\nfrom zoneinfo import ZoneInfo\n\nfrom pydantic_ai import Agent\nfrom pydantic_ai.ui.ag_ui.app import AGUIApp\n\nagent = Agent('gateway/openai:gpt-5-mini')\n\n\n@agent.tool_plain\nasync def current_time(timezone: str = 'UTC') -> str:\n    \"\"\"Get the current time in ISO format.\n\n    Args:\n        timezone: The timezone to use.\n\n    Returns:\n        The current time in ISO format string.\n    \"\"\"\n    tz: ZoneInfo = ZoneInfo(timezone)\n    return datetime.now(tz=tz).isoformat()\n\n\napp = AGUIApp(agent)\n\n```\n\n[ag_ui/api/agentic_chat.py](https://github.com/pydantic/pydantic-ai/blob/main/examples/pydantic_ai_examples/ag_ui/api/agentic_chat.py)\n\n```python\n\"\"\"Agentic Chat feature.\"\"\"\n\nfrom __future__ import annotations\n\nfrom datetime import datetime\nfrom zoneinfo import ZoneInfo\n\nfrom pydantic_ai import Agent\nfrom pydantic_ai.ui.ag_ui.app import AGUIApp\n\nagent = Agent('openai:gpt-5-mini')\n\n\n@agent.tool_plain\nasync def current_time(timezone: str = 'UTC') -> str:\n    \"\"\"Get the current time in ISO format.\n\n    Args:\n        timezone: The timezone to use.\n\n    Returns:\n        The current time in ISO format string.\n    \"\"\"\n    tz: ZoneInfo = ZoneInfo(timezone)\n    return datetime.now(tz=tz).isoformat()\n\n\napp = AGUIApp(agent)\n\n```\n\n### Agentic Generative UI\n\nDemonstrates a long running task where the agent sends updates to the frontend to let the user know what's happening.\n\nIf you've [run the example](#running-the-example), you can view it at <http://localhost:3000/pydantic-ai/feature/agentic_generative_ui>.\n\n#### Plan Prompts\n\n```text\nCreate a plan for breakfast and execute it\n\n```\n\n#### Agentic Generative UI - Code\n\n[Learn about Gateway](../../gateway) [ag_ui/api/agentic_generative_ui.py](https://github.com/pydantic/pydantic-ai/blob/main/examples/pydantic_ai_examples/ag_ui/api/agentic_generative_ui.py)\n\n```python\n\"\"\"Agentic Generative UI feature.\"\"\"\n\nfrom __future__ import annotations\n\nfrom textwrap import dedent\nfrom typing import Any, Literal\n\nfrom pydantic import BaseModel, Field\n\nfrom ag_ui.core import EventType, StateDeltaEvent, StateSnapshotEvent\nfrom pydantic_ai import Agent\nfrom pydantic_ai.ui.ag_ui.app import AGUIApp\n\nStepStatus = Literal['pending', 'completed']\n\n\nclass Step(BaseModel):\n    \"\"\"Represents a step in a plan.\"\"\"\n\n    description: str = Field(description='The description of the step')\n    status: StepStatus = Field(\n        default='pending',\n        description='The status of the step (e.g., pending, completed)',\n    )\n\n\nclass Plan(BaseModel):\n    \"\"\"Represents a plan with multiple steps.\"\"\"\n\n    steps: list[Step] = Field(default_factory=list, description='The steps in the plan')\n\n\nclass JSONPatchOp(BaseModel):\n    \"\"\"A class representing a JSON Patch operation (RFC 6902).\"\"\"\n\n    op: Literal['add', 'remove', 'replace', 'move', 'copy', 'test'] = Field(\n        description='The operation to perform: add, remove, replace, move, copy, or test',\n    )\n    path: str = Field(description='JSON Pointer (RFC 6901) to the target location')\n    value: Any = Field(\n        default=None,\n        description='The value to apply (for add, replace operations)',\n    )\n    from_: str | None = Field(\n        default=None,\n        alias='from',\n        description='Source path (for move, copy operations)',\n    )\n\n\nagent = Agent(\n    'gateway/openai:gpt-5-mini',\n    instructions=dedent(\n        \"\"\"\n        When planning use tools only, without any other messages.\n        IMPORTANT:\n        - Use the `create_plan` tool to set the initial state of the steps\n        - Use the `update_plan_step` tool to update the status of each step\n        - Do NOT repeat the plan or summarise it in a message\n        - Do NOT confirm the creation or updates in a message\n        - Do NOT ask the user for additional information or next steps\n\n        Only one plan can be active at a time, so do not call the `create_plan` tool\n        again until all the steps in current plan are completed.\n        \"\"\"\n    ),\n)\n\n\n@agent.tool_plain\nasync def create_plan(steps: list[str]) -> StateSnapshotEvent:\n    \"\"\"Create a plan with multiple steps.\n\n    Args:\n        steps: List of step descriptions to create the plan.\n\n    Returns:\n        StateSnapshotEvent containing the initial state of the steps.\n    \"\"\"\n    plan: Plan = Plan(\n        steps=[Step(description=step) for step in steps],\n    )\n    return StateSnapshotEvent(\n        type=EventType.STATE_SNAPSHOT,\n        snapshot=plan.model_dump(),\n    )\n\n\n@agent.tool_plain\nasync def update_plan_step(\n    index: int, description: str | None = None, status: StepStatus | None = None\n) -> StateDeltaEvent:\n    \"\"\"Update the plan with new steps or changes.\n\n    Args:\n        index: The index of the step to update.\n        description: The new description for the step.\n        status: The new status for the step.\n\n    Returns:\n        StateDeltaEvent containing the changes made to the plan.\n    \"\"\"\n    changes: list[JSONPatchOp] = []\n    if description is not None:\n        changes.append(\n            JSONPatchOp(\n                op='replace', path=f'/steps/{index}/description', value=description\n            )\n        )\n    if status is not None:\n        changes.append(\n            JSONPatchOp(op='replace', path=f'/steps/{index}/status', value=status)\n        )\n    return StateDeltaEvent(\n        type=EventType.STATE_DELTA,\n        delta=changes,\n    )\n\n\napp = AGUIApp(agent)\n\n```\n\n[ag_ui/api/agentic_generative_ui.py](https://github.com/pydantic/pydantic-ai/blob/main/examples/pydantic_ai_examples/ag_ui/api/agentic_generative_ui.py)\n\n```python\n\"\"\"Agentic Generative UI feature.\"\"\"\n\nfrom __future__ import annotations\n\nfrom textwrap import dedent\nfrom typing import Any, Literal\n\nfrom pydantic import BaseModel, Field\n\nfrom ag_ui.core import EventType, StateDeltaEvent, StateSnapshotEvent\nfrom pydantic_ai import Agent\nfrom pydantic_ai.ui.ag_ui.app import AGUIApp\n\nStepStatus = Literal['pending', 'completed']\n\n\nclass Step(BaseModel):\n    \"\"\"Represents a step in a plan.\"\"\"\n\n    description: str = Field(description='The description of the step')\n    status: StepStatus = Field(\n        default='pending',\n        description='The status of the step (e.g., pending, completed)',\n    )\n\n\nclass Plan(BaseModel):\n    \"\"\"Represents a plan with multiple steps.\"\"\"\n\n    steps: list[Step] = Field(default_factory=list, description='The steps in the plan')\n\n\nclass JSONPatchOp(BaseModel):\n    \"\"\"A class representing a JSON Patch operation (RFC 6902).\"\"\"\n\n    op: Literal['add', 'remove', 'replace', 'move', 'copy', 'test'] = Field(\n        description='The operation to perform: add, remove, replace, move, copy, or test',\n    )\n    path: str = Field(description='JSON Pointer (RFC 6901) to the target location')\n    value: Any = Field(\n        default=None,\n        description='The value to apply (for add, replace operations)',\n    )\n    from_: str | None = Field(\n        default=None,\n        alias='from',\n        description='Source path (for move, copy operations)',\n    )\n\n\nagent = Agent(\n    'openai:gpt-5-mini',\n    instructions=dedent(\n        \"\"\"\n        When planning use tools only, without any other messages.\n        IMPORTANT:\n        - Use the `create_plan` tool to set the initial state of the steps\n        - Use the `update_plan_step` tool to update the status of each step\n        - Do NOT repeat the plan or summarise it in a message\n        - Do NOT confirm the creation or updates in a message\n        - Do NOT ask the user for additional information or next steps\n\n        Only one plan can be active at a time, so do not call the `create_plan` tool\n        again until all the steps in current plan are completed.\n        \"\"\"\n    ),\n)\n\n\n@agent.tool_plain\nasync def create_plan(steps: list[str]) -> StateSnapshotEvent:\n    \"\"\"Create a plan with multiple steps.\n\n    Args:\n        steps: List of step descriptions to create the plan.\n\n    Returns:\n        StateSnapshotEvent containing the initial state of the steps.\n    \"\"\"\n    plan: Plan = Plan(\n        steps=[Step(description=step) for step in steps],\n    )\n    return StateSnapshotEvent(\n        type=EventType.STATE_SNAPSHOT,\n        snapshot=plan.model_dump(),\n    )\n\n\n@agent.tool_plain\nasync def update_plan_step(\n    index: int, description: str | None = None, status: StepStatus | None = None\n) -> StateDeltaEvent:\n    \"\"\"Update the plan with new steps or changes.\n\n    Args:\n        index: The index of the step to update.\n        description: The new description for the step.\n        status: The new status for the step.\n\n    Returns:\n        StateDeltaEvent containing the changes made to the plan.\n    \"\"\"\n    changes: list[JSONPatchOp] = []\n    if description is not None:\n        changes.append(\n            JSONPatchOp(\n                op='replace', path=f'/steps/{index}/description', value=description\n            )\n        )\n    if status is not None:\n        changes.append(\n            JSONPatchOp(op='replace', path=f'/steps/{index}/status', value=status)\n        )\n    return StateDeltaEvent(\n        type=EventType.STATE_DELTA,\n        delta=changes,\n    )\n\n\napp = AGUIApp(agent)\n\n```\n\n### Human in the Loop\n\nDemonstrates simple human in the loop workflow where the agent comes up with a plan and the user can approve it using checkboxes.\n\n#### Task Planning Tools\n\n- `generate_task_steps` - AG-UI tool to generate and confirm steps\n\n#### Task Planning Prompt\n\n```text\nGenerate a list of steps for cleaning a car for me to review\n\n```\n\n#### Human in the Loop - Code\n\n[Learn about Gateway](../../gateway) [ag_ui/api/human_in_the_loop.py](https://github.com/pydantic/pydantic-ai/blob/main/examples/pydantic_ai_examples/ag_ui/api/human_in_the_loop.py)\n\n```python\n\"\"\"Human in the Loop Feature.\n\nNo special handling is required for this feature.\n\"\"\"\n\nfrom __future__ import annotations\n\nfrom textwrap import dedent\n\nfrom pydantic_ai import Agent\nfrom pydantic_ai.ui.ag_ui.app import AGUIApp\n\nagent = Agent(\n    'gateway/openai:gpt-5-mini',\n    instructions=dedent(\n        \"\"\"\n        When planning tasks use tools only, without any other messages.\n        IMPORTANT:\n        - Use the `generate_task_steps` tool to display the suggested steps to the user\n        - Never repeat the plan, or send a message detailing steps\n        - If accepted, confirm the creation of the plan and the number of selected (enabled) steps only\n        - If not accepted, ask the user for more information, DO NOT use the `generate_task_steps` tool again\n        \"\"\"\n    ),\n)\n\napp = AGUIApp(agent)\n\n```\n\n[ag_ui/api/human_in_the_loop.py](https://github.com/pydantic/pydantic-ai/blob/main/examples/pydantic_ai_examples/ag_ui/api/human_in_the_loop.py)\n\n```python\n\"\"\"Human in the Loop Feature.\n\nNo special handling is required for this feature.\n\"\"\"\n\nfrom __future__ import annotations\n\nfrom textwrap import dedent\n\nfrom pydantic_ai import Agent\nfrom pydantic_ai.ui.ag_ui.app import AGUIApp\n\nagent = Agent(\n    'openai:gpt-5-mini',\n    instructions=dedent(\n        \"\"\"\n        When planning tasks use tools only, without any other messages.\n        IMPORTANT:\n        - Use the `generate_task_steps` tool to display the suggested steps to the user\n        - Never repeat the plan, or send a message detailing steps\n        - If accepted, confirm the creation of the plan and the number of selected (enabled) steps only\n        - If not accepted, ask the user for more information, DO NOT use the `generate_task_steps` tool again\n        \"\"\"\n    ),\n)\n\napp = AGUIApp(agent)\n\n```\n\n### Predictive State Updates\n\nDemonstrates how to use the predictive state updates feature to update the state of the UI based on agent responses, including user interaction via user confirmation.\n\nIf you've [run the example](#running-the-example), you can view it at <http://localhost:3000/pydantic-ai/feature/predictive_state_updates>.\n\n#### Story Tools\n\n- `write_document` - AG-UI tool to write the document to a window\n- `document_predict_state` - Pydantic AI tool that enables document state prediction for the `write_document` tool\n\nThis also shows how to use custom instructions based on shared state information.\n\n#### Story Example\n\nStarting document text\n\n```markdown\nBruce was a good dog,\n\n```\n\nAgent prompt\n\n```text\nHelp me complete my story about bruce the dog, is should be no longer than a sentence.\n\n```\n\n#### Predictive State Updates - Code\n\n[Learn about Gateway](../../gateway) [ag_ui/api/predictive_state_updates.py](https://github.com/pydantic/pydantic-ai/blob/main/examples/pydantic_ai_examples/ag_ui/api/predictive_state_updates.py)\n\n```python\n\"\"\"Predictive State feature.\"\"\"\n\nfrom __future__ import annotations\n\nfrom textwrap import dedent\n\nfrom pydantic import BaseModel\n\nfrom ag_ui.core import CustomEvent, EventType\nfrom pydantic_ai import Agent, RunContext\nfrom pydantic_ai.ui import StateDeps\nfrom pydantic_ai.ui.ag_ui.app import AGUIApp\n\n\nclass DocumentState(BaseModel):\n    \"\"\"State for the document being written.\"\"\"\n\n    document: str = ''\n\n\nagent = Agent('gateway/openai:gpt-5-mini', deps_type=StateDeps[DocumentState])\n\n\n### Tools which return AG-UI events will be sent to the client as part of the\n### event stream, single events and iterables of events are supported.\n@agent.tool_plain\nasync def document_predict_state() -> list[CustomEvent]:\n    \"\"\"Enable document state prediction.\n\n    Returns:\n        CustomEvent containing the event to enable state prediction.\n    \"\"\"\n    return [\n        CustomEvent(\n            type=EventType.CUSTOM,\n            name='PredictState',\n            value=[\n                {\n                    'state_key': 'document',\n                    'tool': 'write_document',\n                    'tool_argument': 'document',\n                },\n            ],\n        ),\n    ]\n\n\n@agent.instructions()\nasync def story_instructions(ctx: RunContext[StateDeps[DocumentState]]) -> str:\n    \"\"\"Provide instructions for writing document if present.\n\n    Args:\n        ctx: The run context containing document state information.\n\n    Returns:\n        Instructions string for the document writing agent.\n    \"\"\"\n    return dedent(\n        f\"\"\"You are a helpful assistant for writing documents.\n\n        Before you start writing, you MUST call the `document_predict_state`\n        tool to enable state prediction.\n\n        To present the document to the user for review, you MUST use the\n        `write_document` tool.\n\n        When you have written the document, DO NOT repeat it as a message.\n        If accepted briefly summarize the changes you made, 2 sentences\n        max, otherwise ask the user to clarify what they want to change.\n\n        This is the current document:\n\n        {ctx.deps.state.document}\n        \"\"\"\n    )\n\n\napp = AGUIApp(agent, deps=StateDeps(DocumentState()))\n\n```\n\n[ag_ui/api/predictive_state_updates.py](https://github.com/pydantic/pydantic-ai/blob/main/examples/pydantic_ai_examples/ag_ui/api/predictive_state_updates.py)\n\n```python\n\"\"\"Predictive State feature.\"\"\"\n\nfrom __future__ import annotations\n\nfrom textwrap import dedent\n\nfrom pydantic import BaseModel\n\nfrom ag_ui.core import CustomEvent, EventType\nfrom pydantic_ai import Agent, RunContext\nfrom pydantic_ai.ui import StateDeps\nfrom pydantic_ai.ui.ag_ui.app import AGUIApp\n\n\nclass DocumentState(BaseModel):\n    \"\"\"State for the document being written.\"\"\"\n\n    document: str = ''\n\n\nagent = Agent('openai:gpt-5-mini', deps_type=StateDeps[DocumentState])\n\n\n### Tools which return AG-UI events will be sent to the client as part of the\n### event stream, single events and iterables of events are supported.\n@agent.tool_plain\nasync def document_predict_state() -> list[CustomEvent]:\n    \"\"\"Enable document state prediction.\n\n    Returns:\n        CustomEvent containing the event to enable state prediction.\n    \"\"\"\n    return [\n        CustomEvent(\n            type=EventType.CUSTOM,\n            name='PredictState',\n            value=[\n                {\n                    'state_key': 'document',\n                    'tool': 'write_document',\n                    'tool_argument': 'document',\n                },\n            ],\n        ),\n    ]\n\n\n@agent.instructions()\nasync def story_instructions(ctx: RunContext[StateDeps[DocumentState]]) -> str:\n    \"\"\"Provide instructions for writing document if present.\n\n    Args:\n        ctx: The run context containing document state information.\n\n    Returns:\n        Instructions string for the document writing agent.\n    \"\"\"\n    return dedent(\n        f\"\"\"You are a helpful assistant for writing documents.\n\n        Before you start writing, you MUST call the `document_predict_state`\n        tool to enable state prediction.\n\n        To present the document to the user for review, you MUST use the\n        `write_document` tool.\n\n        When you have written the document, DO NOT repeat it as a message.\n        If accepted briefly summarize the changes you made, 2 sentences\n        max, otherwise ask the user to clarify what they want to change.\n\n        This is the current document:\n\n        {ctx.deps.state.document}\n        \"\"\"\n    )\n\n\napp = AGUIApp(agent, deps=StateDeps(DocumentState()))\n\n```\n\n### Shared State\n\nDemonstrates how to use the shared state between the UI and the agent.\n\nState sent to the agent is detected by a function based instruction. This then validates the data using a custom pydantic model before using to create the instructions for the agent to follow and send to the client using a AG-UI tool.\n\nIf you've [run the example](#running-the-example), you can view it at <http://localhost:3000/pydantic-ai/feature/shared_state>.\n\n#### Recipe Tools\n\n- `display_recipe` - AG-UI tool to display the recipe in a graphical format\n\n#### Recipe Example\n\n1. Customise the basic settings of your recipe\n1. Click `Improve with AI`\n\n#### Shared State - Code\n\n[Learn about Gateway](../../gateway) [ag_ui/api/shared_state.py](https://github.com/pydantic/pydantic-ai/blob/main/examples/pydantic_ai_examples/ag_ui/api/shared_state.py)\n\n```python\n\"\"\"Shared State feature.\"\"\"\n\nfrom __future__ import annotations\n\nfrom enum import Enum\nfrom textwrap import dedent\n\nfrom pydantic import BaseModel, Field\n\nfrom ag_ui.core import EventType, StateSnapshotEvent\nfrom pydantic_ai import Agent, RunContext\nfrom pydantic_ai.ui import StateDeps\nfrom pydantic_ai.ui.ag_ui.app import AGUIApp\n\n\nclass SkillLevel(str, Enum):\n    \"\"\"The level of skill required for the recipe.\"\"\"\n\n    BEGINNER = 'Beginner'\n    INTERMEDIATE = 'Intermediate'\n    ADVANCED = 'Advanced'\n\n\nclass SpecialPreferences(str, Enum):\n    \"\"\"Special preferences for the recipe.\"\"\"\n\n    HIGH_PROTEIN = 'High Protein'\n    LOW_CARB = 'Low Carb'\n    SPICY = 'Spicy'\n    BUDGET_FRIENDLY = 'Budget-Friendly'\n    ONE_POT_MEAL = 'One-Pot Meal'\n    VEGETARIAN = 'Vegetarian'\n    VEGAN = 'Vegan'\n\n\nclass CookingTime(str, Enum):\n    \"\"\"The cooking time of the recipe.\"\"\"\n\n    FIVE_MIN = '5 min'\n    FIFTEEN_MIN = '15 min'\n    THIRTY_MIN = '30 min'\n    FORTY_FIVE_MIN = '45 min'\n    SIXTY_PLUS_MIN = '60+ min'\n\n\nclass Ingredient(BaseModel):\n    \"\"\"A class representing an ingredient in a recipe.\"\"\"\n\n    icon: str = Field(\n        default='ingredient',\n        description=\"The icon emoji (not emoji code like '\\x1f35e', but the actual emoji like ðŸ¥•) of the ingredient\",\n    )\n    name: str\n    amount: str\n\n\nclass Recipe(BaseModel):\n    \"\"\"A class representing a recipe.\"\"\"\n\n    skill_level: SkillLevel = Field(\n        default=SkillLevel.BEGINNER,\n        description='The skill level required for the recipe',\n    )\n    special_preferences: list[SpecialPreferences] = Field(\n        default_factory=list,\n        description='Any special preferences for the recipe',\n    )\n    cooking_time: CookingTime = Field(\n        default=CookingTime.FIVE_MIN, description='The cooking time of the recipe'\n    )\n    ingredients: list[Ingredient] = Field(\n        default_factory=list,\n        description='Ingredients for the recipe',\n    )\n    instructions: list[str] = Field(\n        default_factory=list, description='Instructions for the recipe'\n    )\n\n\nclass RecipeSnapshot(BaseModel):\n    \"\"\"A class representing the state of the recipe.\"\"\"\n\n    recipe: Recipe = Field(\n        default_factory=Recipe, description='The current state of the recipe'\n    )\n\n\nagent = Agent('gateway/openai:gpt-5-mini', deps_type=StateDeps[RecipeSnapshot])\n\n\n@agent.tool_plain\nasync def display_recipe(recipe: Recipe) -> StateSnapshotEvent:\n    \"\"\"Display the recipe to the user.\n\n    Args:\n        recipe: The recipe to display.\n\n    Returns:\n        StateSnapshotEvent containing the recipe snapshot.\n    \"\"\"\n    return StateSnapshotEvent(\n        type=EventType.STATE_SNAPSHOT,\n        snapshot={'recipe': recipe},\n    )\n\n\n@agent.instructions\nasync def recipe_instructions(ctx: RunContext[StateDeps[RecipeSnapshot]]) -> str:\n    \"\"\"Instructions for the recipe generation agent.\n\n    Args:\n        ctx: The run context containing recipe state information.\n\n    Returns:\n        Instructions string for the recipe generation agent.\n    \"\"\"\n    return dedent(\n        f\"\"\"\n        You are a helpful assistant for creating recipes.\n\n        IMPORTANT:\n        - Create a complete recipe using the existing ingredients\n        - Append new ingredients to the existing ones\n        - Use the `display_recipe` tool to present the recipe to the user\n        - Do NOT repeat the recipe in the message, use the tool instead\n        - Do NOT run the `display_recipe` tool multiple times in a row\n\n        Once you have created the updated recipe and displayed it to the user,\n        summarise the changes in one sentence, don't describe the recipe in\n        detail or send it as a message to the user.\n\n        The current state of the recipe is:\n\n        {ctx.deps.state.recipe.model_dump_json(indent=2)}\n        \"\"\",\n    )\n\n\napp = AGUIApp(agent, deps=StateDeps(RecipeSnapshot()))\n\n```\n\n[ag_ui/api/shared_state.py](https://github.com/pydantic/pydantic-ai/blob/main/examples/pydantic_ai_examples/ag_ui/api/shared_state.py)\n\n```python\n\"\"\"Shared State feature.\"\"\"\n\nfrom __future__ import annotations\n\nfrom enum import Enum\nfrom textwrap import dedent\n\nfrom pydantic import BaseModel, Field\n\nfrom ag_ui.core import EventType, StateSnapshotEvent\nfrom pydantic_ai import Agent, RunContext\nfrom pydantic_ai.ui import StateDeps\nfrom pydantic_ai.ui.ag_ui.app import AGUIApp\n\n\nclass SkillLevel(str, Enum):\n    \"\"\"The level of skill required for the recipe.\"\"\"\n\n    BEGINNER = 'Beginner'\n    INTERMEDIATE = 'Intermediate'\n    ADVANCED = 'Advanced'\n\n\nclass SpecialPreferences(str, Enum):\n    \"\"\"Special preferences for the recipe.\"\"\"\n\n    HIGH_PROTEIN = 'High Protein'\n    LOW_CARB = 'Low Carb'\n    SPICY = 'Spicy'\n    BUDGET_FRIENDLY = 'Budget-Friendly'\n    ONE_POT_MEAL = 'One-Pot Meal'\n    VEGETARIAN = 'Vegetarian'\n    VEGAN = 'Vegan'\n\n\nclass CookingTime(str, Enum):\n    \"\"\"The cooking time of the recipe.\"\"\"\n\n    FIVE_MIN = '5 min'\n    FIFTEEN_MIN = '15 min'\n    THIRTY_MIN = '30 min'\n    FORTY_FIVE_MIN = '45 min'\n    SIXTY_PLUS_MIN = '60+ min'\n\n\nclass Ingredient(BaseModel):\n    \"\"\"A class representing an ingredient in a recipe.\"\"\"\n\n    icon: str = Field(\n        default='ingredient',\n        description=\"The icon emoji (not emoji code like '\\x1f35e', but the actual emoji like ðŸ¥•) of the ingredient\",\n    )\n    name: str\n    amount: str\n\n\nclass Recipe(BaseModel):\n    \"\"\"A class representing a recipe.\"\"\"\n\n    skill_level: SkillLevel = Field(\n        default=SkillLevel.BEGINNER,\n        description='The skill level required for the recipe',\n    )\n    special_preferences: list[SpecialPreferences] = Field(\n        default_factory=list,\n        description='Any special preferences for the recipe',\n    )\n    cooking_time: CookingTime = Field(\n        default=CookingTime.FIVE_MIN, description='The cooking time of the recipe'\n    )\n    ingredients: list[Ingredient] = Field(\n        default_factory=list,\n        description='Ingredients for the recipe',\n    )\n    instructions: list[str] = Field(\n        default_factory=list, description='Instructions for the recipe'\n    )\n\n\nclass RecipeSnapshot(BaseModel):\n    \"\"\"A class representing the state of the recipe.\"\"\"\n\n    recipe: Recipe = Field(\n        default_factory=Recipe, description='The current state of the recipe'\n    )\n\n\nagent = Agent('openai:gpt-5-mini', deps_type=StateDeps[RecipeSnapshot])\n\n\n@agent.tool_plain\nasync def display_recipe(recipe: Recipe) -> StateSnapshotEvent:\n    \"\"\"Display the recipe to the user.\n\n    Args:\n        recipe: The recipe to display.\n\n    Returns:\n        StateSnapshotEvent containing the recipe snapshot.\n    \"\"\"\n    return StateSnapshotEvent(\n        type=EventType.STATE_SNAPSHOT,\n        snapshot={'recipe': recipe},\n    )\n\n\n@agent.instructions\nasync def recipe_instructions(ctx: RunContext[StateDeps[RecipeSnapshot]]) -> str:\n    \"\"\"Instructions for the recipe generation agent.\n\n    Args:\n        ctx: The run context containing recipe state information.\n\n    Returns:\n        Instructions string for the recipe generation agent.\n    \"\"\"\n    return dedent(\n        f\"\"\"\n        You are a helpful assistant for creating recipes.\n\n        IMPORTANT:\n        - Create a complete recipe using the existing ingredients\n        - Append new ingredients to the existing ones\n        - Use the `display_recipe` tool to present the recipe to the user\n        - Do NOT repeat the recipe in the message, use the tool instead\n        - Do NOT run the `display_recipe` tool multiple times in a row\n\n        Once you have created the updated recipe and displayed it to the user,\n        summarise the changes in one sentence, don't describe the recipe in\n        detail or send it as a message to the user.\n\n        The current state of the recipe is:\n\n        {ctx.deps.state.recipe.model_dump_json(indent=2)}\n        \"\"\",\n    )\n\n\napp = AGUIApp(agent, deps=StateDeps(RecipeSnapshot()))\n\n```\n\n### Tool Based Generative UI\n\nDemonstrates customised rendering for tool output with used confirmation.\n\nIf you've [run the example](#running-the-example), you can view it at <http://localhost:3000/pydantic-ai/feature/tool_based_generative_ui>.\n\n#### Haiku Tools\n\n- `generate_haiku` - AG-UI tool to display a haiku in English and Japanese\n\n#### Haiku Prompt\n\n```text\nGenerate a haiku about formula 1\n\n```\n\n#### Tool Based Generative UI - Code\n\n[Learn about Gateway](../../gateway) [ag_ui/api/tool_based_generative_ui.py](https://github.com/pydantic/pydantic-ai/blob/main/examples/pydantic_ai_examples/ag_ui/api/tool_based_generative_ui.py)\n\n```python\n\"\"\"Tool Based Generative UI feature.\n\nNo special handling is required for this feature.\n\"\"\"\n\nfrom __future__ import annotations\n\nfrom pydantic_ai import Agent\nfrom pydantic_ai.ui.ag_ui.app import AGUIApp\n\nagent = Agent('gateway/openai:gpt-5-mini')\napp = AGUIApp(agent)\n\n```\n\n[ag_ui/api/tool_based_generative_ui.py](https://github.com/pydantic/pydantic-ai/blob/main/examples/pydantic_ai_examples/ag_ui/api/tool_based_generative_ui.py)\n\n```python\n\"\"\"Tool Based Generative UI feature.\n\nNo special handling is required for this feature.\n\"\"\"\n\nfrom __future__ import annotations\n\nfrom pydantic_ai import Agent\nfrom pydantic_ai.ui.ag_ui.app import AGUIApp\n\nagent = Agent('openai:gpt-5-mini')\napp = AGUIApp(agent)\n\n```\n\nSmall but complete example of using Pydantic AI to build a support agent for a bank.\n\nDemonstrates:\n\n- [dynamic system prompt](../../agents/#system-prompts)\n- [structured `output_type`](../../output/#structured-output)\n- [tools](../../tools/)\n\n## Running the Example\n\nWith [dependencies installed and environment variables set](../setup/#usage), run:\n\n```bash\npython -m pydantic_ai_examples.bank_support\n\n```\n\n```bash\nuv run -m pydantic_ai_examples.bank_support\n\n```\n\n(or `PYDANTIC_AI_MODEL=gemini-2.5-flash ...`)\n\n## Example Code\n\n[Learn about Gateway](../../gateway) [bank_support.py](https://github.com/pydantic/pydantic-ai/blob/main/examples/pydantic_ai_examples/bank_support.py)\n\n```python\n\"\"\"Small but complete example of using Pydantic AI to build a support agent for a bank.\n\nRun with:\n\n    uv run -m pydantic_ai_examples.bank_support\n\"\"\"\n\nfrom dataclasses import dataclass\n\nfrom pydantic import BaseModel\n\nfrom pydantic_ai import Agent, RunContext\n\n\nclass DatabaseConn:\n    \"\"\"This is a fake database for example purposes.\n\n    In reality, you'd be connecting to an external database\n    (e.g. PostgreSQL) to get information about customers.\n    \"\"\"\n\n    @classmethod\n    async def customer_name(cls, *, id: int) -> str | None:\n        if id == 123:\n            return 'John'\n\n    @classmethod\n    async def customer_balance(cls, *, id: int, include_pending: bool) -> float:\n        if id == 123:\n            if include_pending:\n                return 123.45\n            else:\n                return 100.00\n        else:\n            raise ValueError('Customer not found')\n\n\n@dataclass\nclass SupportDependencies:\n    customer_id: int\n    db: DatabaseConn\n\n\nclass SupportOutput(BaseModel):\n    support_advice: str\n    \"\"\"Advice returned to the customer\"\"\"\n    block_card: bool\n    \"\"\"Whether to block their card or not\"\"\"\n    risk: int\n    \"\"\"Risk level of query\"\"\"\n\n\nsupport_agent = Agent(\n    'gateway/openai:gpt-5',\n    deps_type=SupportDependencies,\n    output_type=SupportOutput,\n    instructions=(\n        'You are a support agent in our bank, give the '\n        'customer support and judge the risk level of their query. '\n        \"Reply using the customer's name.\"\n    ),\n)\n\n\n@support_agent.instructions\nasync def add_customer_name(ctx: RunContext[SupportDependencies]) -> str:\n    customer_name = await ctx.deps.db.customer_name(id=ctx.deps.customer_id)\n    return f\"The customer's name is {customer_name!r}\"\n\n\n@support_agent.tool\nasync def customer_balance(\n    ctx: RunContext[SupportDependencies], include_pending: bool\n) -> str:\n    \"\"\"Returns the customer's current account balance.\"\"\"\n    balance = await ctx.deps.db.customer_balance(\n        id=ctx.deps.customer_id,\n        include_pending=include_pending,\n    )\n    return f'${balance:.2f}'\n\n\nif __name__ == '__main__':\n    deps = SupportDependencies(customer_id=123, db=DatabaseConn())\n    result = support_agent.run_sync('What is my balance?', deps=deps)\n    print(result.output)\n    \"\"\"\n    support_advice='Hello John, your current account balance, including pending transactions, is $123.45.' block_card=False risk=1\n    \"\"\"\n\n    result = support_agent.run_sync('I just lost my card!', deps=deps)\n    print(result.output)\n    \"\"\"\n    support_advice=\"I'm sorry to hear that, John. We are temporarily blocking your card to prevent unauthorized transactions.\" block_card=True risk=8\n    \"\"\"\n\n```\n\n[bank_support.py](https://github.com/pydantic/pydantic-ai/blob/main/examples/pydantic_ai_examples/bank_support.py)\n\n```python\n\"\"\"Small but complete example of using Pydantic AI to build a support agent for a bank.\n\nRun with:\n\n    uv run -m pydantic_ai_examples.bank_support\n\"\"\"\n\nfrom dataclasses import dataclass\n\nfrom pydantic import BaseModel\n\nfrom pydantic_ai import Agent, RunContext\n\n\nclass DatabaseConn:\n    \"\"\"This is a fake database for example purposes.\n\n    In reality, you'd be connecting to an external database\n    (e.g. PostgreSQL) to get information about customers.\n    \"\"\"\n\n    @classmethod\n    async def customer_name(cls, *, id: int) -> str | None:\n        if id == 123:\n            return 'John'\n\n    @classmethod\n    async def customer_balance(cls, *, id: int, include_pending: bool) -> float:\n        if id == 123:\n            if include_pending:\n                return 123.45\n            else:\n                return 100.00\n        else:\n            raise ValueError('Customer not found')\n\n\n@dataclass\nclass SupportDependencies:\n    customer_id: int\n    db: DatabaseConn\n\n\nclass SupportOutput(BaseModel):\n    support_advice: str\n    \"\"\"Advice returned to the customer\"\"\"\n    block_card: bool\n    \"\"\"Whether to block their card or not\"\"\"\n    risk: int\n    \"\"\"Risk level of query\"\"\"\n\n\nsupport_agent = Agent(\n    'openai:gpt-5',\n    deps_type=SupportDependencies,\n    output_type=SupportOutput,\n    instructions=(\n        'You are a support agent in our bank, give the '\n        'customer support and judge the risk level of their query. '\n        \"Reply using the customer's name.\"\n    ),\n)\n\n\n@support_agent.instructions\nasync def add_customer_name(ctx: RunContext[SupportDependencies]) -> str:\n    customer_name = await ctx.deps.db.customer_name(id=ctx.deps.customer_id)\n    return f\"The customer's name is {customer_name!r}\"\n\n\n@support_agent.tool\nasync def customer_balance(\n    ctx: RunContext[SupportDependencies], include_pending: bool\n) -> str:\n    \"\"\"Returns the customer's current account balance.\"\"\"\n    balance = await ctx.deps.db.customer_balance(\n        id=ctx.deps.customer_id,\n        include_pending=include_pending,\n    )\n    return f'${balance:.2f}'\n\n\nif __name__ == '__main__':\n    deps = SupportDependencies(customer_id=123, db=DatabaseConn())\n    result = support_agent.run_sync('What is my balance?', deps=deps)\n    print(result.output)\n    \"\"\"\n    support_advice='Hello John, your current account balance, including pending transactions, is $123.45.' block_card=False risk=1\n    \"\"\"\n\n    result = support_agent.run_sync('I just lost my card!', deps=deps)\n    print(result.output)\n    \"\"\"\n    support_advice=\"I'm sorry to hear that, John. We are temporarily blocking your card to prevent unauthorized transactions.\" block_card=True risk=8\n    \"\"\"\n\n```",
  "content_length": 35783
}