{
  "title": "How to handle model rate limits",
  "source_url": "https://docs.langchain.com/langsmith/rate-limiting",
  "content": "A common issue when running large evaluation jobs is running into third-party API rate limits, usually from model providers. There are a few ways to deal with rate limits.\n\n## Using `langchain` RateLimiters (Python only)\n\nIf you're using `langchain` Python chat models in your application or evaluators, you can add rate limiters to your model(s) that will add client-side control of the frequency with which requests are sent to the model provider API to avoid rate limit errors.\n\n```python  theme={null}\nfrom langchain.chat_models import init_chat_model\nfrom langchain_core.rate_limiters import InMemoryRateLimiter\n\nrate_limiter = InMemoryRateLimiter(\n    requests_per_second=0.1,  # <-- Super slow! We can only make a request once every 10 seconds!!\n    check_every_n_seconds=0.1,  # Wake up every 100 ms to check whether allowed to make a request,\n    max_bucket_size=10,  # Controls the maximum burst size.\n)\n\nmodel = init_chat_model(\"gpt-4o\", rate_limiter=rate_limiter)\n\ndef app(inputs: dict) -> dict:\n    response = model.invoke(...)\n    ...\n\ndef evaluator(inputs: dict, outputs: dict, reference_outputs: dict) -> dict:\n    response = model.invoke(...)\n    ...\n```\n\nSee the [`langchain`](/oss/python/langchain/models#rate-limiting) documentation for more on how to configure rate limiters.\n\n## Retrying with exponential backoff\n\nA very common way to deal with rate limit errors is retrying with exponential backoff. Retrying with exponential backoff means repeatedly retrying failed requests with an (exponentially) increasing wait time between each retry. This continues until either the request succeeds or a maximum number of requests is made.\n\n#### With `langchain`\n\nIf you're using `langchain` components you can add retries to all model calls with the `.with_retry(...)` / `.withRetry()` method:\n\n<CodeGroup>\n  ```python Python theme={null}\n  from langchain import init_chat_model\n\n  model_with_retry = init_chat_model(\"gpt-4o-mini\").with_retry(stop_after_attempt=6)\n  ```\n\n  ```typescript TypeScript theme={null}\n  import { initChatModel } from \"langchain\";\n\n  const model = await initChatModel(\"gpt-4o\", {\n      modelProvider: \"openai\",\n  });\n\n  const modelWithRetry = model.withRetry({ stopAfterAttept: 2 });\n  ```\n</CodeGroup>\n\nSee the `langchain` [Python](https://reference.langchain.com/python/langchain_core/language_models/#langchain_core.language_models.BaseChatModel.with_retry) and [JS](https://v03.api.js.langchain.com/classes/_langchain_core.language_models_chat_models.BaseChatModel.html#withRetry) API references for more.\n\n#### Without `langchain`\n\nIf you're not using `langchain` you can use other libraries like `tenacity` (Python) or `backoff` (Python) to implement retries with exponential backoff, or you can implement it from scratch. See some examples of how to do this in the [OpenAI docs](https://platform.openai.com/docs/guides/rate-limits#retrying-with-exponential-backoff).\n\n## Limiting `max_concurrency`\n\nLimiting the number of concurrent calls you're making to your application and evaluators is another way to decrease the frequency of model calls you're making, and in that way avoid rate limit errors. `max_concurrency` can be set directly on the [evaluate()](https://docs.smith.langchain.com/reference/python/evaluation/langsmith.evaluation._runner.evaluate) / [aevaluate()](https://docs.smith.langchain.com/reference/python/evaluation/langsmith.evaluation._arunner.aevaluate) functions. This parallelizes evaluation by effectively splitting the dataset across threads.\n\n<CodeGroup>\n  ```python Python theme={null}\n  from langsmith import aevaluate\n\n  results = await aevaluate(\n      ...\n      max_concurrency=4,\n  )\n  ```\n\n  ```typescript TypeScript theme={null}\n  import { evaluate } from \"langsmith/evaluation\";\n\n  await evaluate(..., {\n    ...,\n    maxConcurrency: 4,\n  });\n  ```\n</CodeGroup>\n\n***\n\n<Callout icon=\"pen-to-square\" iconType=\"regular\">\n  [Edit the source of this page on GitHub.](https://github.com/langchain-ai/docs/edit/main/src/langsmith/rate-limiting.mdx)\n</Callout>\n\n<Tip icon=\"terminal\" iconType=\"regular\">\n  [Connect these docs programmatically](/use-these-docs) to Claude, VSCode, and more via MCP for real-time answers.\n</Tip>",
  "content_length": 4200
}