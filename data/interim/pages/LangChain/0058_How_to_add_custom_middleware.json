{
  "title": "How to add custom middleware",
  "source_url": "https://docs.langchain.com/langsmith/custom-middleware",
  "content": "When deploying agents to LangSmith, you can add custom middleware to your server to handle concerns like logging request metrics, injecting or checking headers, and enforcing security policies without modifying core server logic. This works the same way as [adding custom routes](/langsmith/custom-routes). You just need to provide your own [`Starlette`](https://www.starlette.io/applications/) app (including [`FastAPI`](https://fastapi.tiangolo.com/), [`FastHTML`](https://fastht.ml/) and other compatible apps).\n\nAdding middleware lets you intercept and modify requests and responses globally across your deployment, whether they're hitting your custom endpoints or the built-in LangSmith APIs.\n\nBelow is an example using FastAPI.\n\n<Note>\n  \"Python only\"\n  We currently only support custom middleware in Python deployments with `langgraph-api>=0.0.26`.\n</Note>\n\n## Create app\n\nStarting from an **existing** LangSmith application, add the following middleware code to your `webapp.py` file. If you are starting from scratch, you can create a new app from a template using the CLI.\n\n```bash  theme={null}\nlanggraph new --template=new-langgraph-project-python my_new_project\n```\n\nOnce you have a LangGraph project, add the following app code:\n\n```python {highlight={5}} theme={null}\n# ./src/agent/webapp.py\nfrom fastapi import FastAPI, Request\nfrom starlette.middleware.base import BaseHTTPMiddleware\n\napp = FastAPI()\n\nclass CustomHeaderMiddleware(BaseHTTPMiddleware):\n    async def dispatch(self, request: Request, call_next):\n        response = await call_next(request)\n        response.headers['X-Custom-Header'] = 'Hello from middleware!'\n        return response\n\n# Add the middleware to the app\napp.add_middleware(CustomHeaderMiddleware)\n```\n\n## Configure `langgraph.json`\n\nAdd the following to your `langgraph.json` configuration file. Make sure the path points to the `webapp.py` file you created above.\n\n```json  theme={null}\n{\n  \"dependencies\": [\".\"],\n  \"graphs\": {\n    \"agent\": \"./src/agent/graph.py:graph\"\n  },\n  \"env\": \".env\",\n  \"http\": {\n    \"app\": \"./src/agent/webapp.py:app\"\n  }\n  // Other configuration options like auth, store, etc.\n}\n```\n\n### Customize middleware ordering\n\nBy default, custom middleware runs before authentication logic. To run custom middleware *after* authentication, set `middleware_order` to `auth_first` in your `http` configuration. (This customization is supported starting with API server v0.4.35 and later.)\n\n```json  theme={null}\n{\n  \"dependencies\": [\".\"],\n  \"graphs\": {\n    \"agent\": \"./src/agent/graph.py:graph\"\n  },\n  \"env\": \".env\",\n  \"http\": {\n    \"app\": \"./src/agent/webapp.py:app\",\n    \"middleware_order\": \"auth_first\"\n  },\n  \"auth\": {\n    \"path\": \"./auth.py:my_auth\"\n  }\n}\n```\n\n## Start server\n\nTest the server out locally:\n\n```bash  theme={null}\nlanggraph dev --no-browser\n```\n\nNow any request to your server will include the custom header `X-Custom-Header` in its response.\n\n## Deploying\n\nYou can deploy this app as-is to cloud or to your self-hosted platform.\n\n## Next steps\n\nNow that you've added custom middleware to your deployment, you can use similar techniques to add [custom routes](/langsmith/custom-routes) or define [custom lifespan events](/langsmith/custom-lifespan) to further customize your server's behavior.\n\n***\n\n<Callout icon=\"pen-to-square\" iconType=\"regular\">\n  [Edit the source of this page on GitHub.](https://github.com/langchain-ai/docs/edit/main/src/langsmith/custom-middleware.mdx)\n</Callout>\n\n<Tip icon=\"terminal\" iconType=\"regular\">\n  [Connect these docs programmatically](/use-these-docs) to Claude, VSCode, and more via MCP for real-time answers.\n</Tip>",
  "content_length": 3637
}