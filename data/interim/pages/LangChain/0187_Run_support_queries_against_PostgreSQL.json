{
  "title": "Run support queries against PostgreSQL",
  "source_url": "https://docs.langchain.com/langsmith/script-running-pg-support-queries",
  "content": "This Helm repository contains queries to produce output that the LangSmith UI does not currently support directly (e.g. obtaining trace counts for multiple organizations in a single query).\n\nThis command takes a postgres connection string that contains an embedded name and password (which can be passed in from a call to a secrets manager) and executes a query from an input file. In the example below, we are using the `pg_get_trace_counts_daily.sql` input file in the `support_queries/postgres` directory.\n\n## Prerequisites\n\nEnsure you have the following tools/items ready.\n\n1. kubectl\n\n   * [https://kubernetes.io/docs/tasks/tools/](https://kubernetes.io/docs/tasks/tools/)\n\n2. PostgreSQL client\n\n   * [https://www.postgresql.org/download/](https://www.postgresql.org/download/)\n\n3. PostgreSQL database connection:\n\n   * Host\n   * Port\n   * Username\n     * If using the bundled version, this is `postgres`\n   * Password\n     * If using the bundled version, this is `postgres`\n   * Database name\n     * If using the bundled version, this is `postgres`\n\n4. Connectivity to the PostgreSQL database from the machine you will be running the migration script on.\n\n   * If you are using the bundled version, you may need to port forward the postgresql service to your local machine.\n   * Run `kubectl port-forward svc/langsmith-postgres 5432:5432` to port forward the postgresql service to your local machine.\n\n5. The script to run a support query\n\n   * You can download the script from [here](https://github.com/langchain-ai/helm/blob/main/charts/langsmith/scripts/run_support_query_pg.sh)\n\n## Running the query script\n\nRun the following command to run the desired query:\n\n```bash  theme={null}\nsh run_support_query_pg.sh <postgres_url> --input path/to/query.sql\n```\n\nFor example, if you are using the bundled version with port-forwarding, the command might look like:\n\n```bash  theme={null}\nsh run_support_query_pg.sh \"postgres://postgres:postgres@localhost:5432/postgres\" --input support_queries/pg_get_trace_counts_daily.sql\n```\n\nwhich will output the count of daily traces by workspace ID and organization ID. To extract this to a file add the flag `--output path/to/file.csv`\n\n## Export usage data\n\n<Note>\n  Exporting usage data requires running Helm chart version 0.11.4 or later.\n</Note>\n\n### Get customer information\n\nYou need to retrieve your customer information from the LangSmith API before running the export scripts. This information is required as input for the export scripts.\n\n```bash  theme={null}\ncurl https://<langsmith_url>/api/v1/info\n# if configured with a subdomain / path prefix:\ncurl http://<langsmith_url/prefix/api/v1/info\n```\n\nThis will return a JSON response containing your customer information:\n\n```json  theme={null}\n{\n  \"version\": \"0.11.4\",\n  \"license_expiration_time\": \"2026-08-18T19:14:34Z\",\n  \"customer_info\": {\n    \"customer_id\": \"<id>\",\n    \"customer_name\": \"<name>\"\n  }\n}\n```\n\nExtract the `customer_id` and `customer_name` from this response to use as input for the export scripts.\n\n### Process the API response with jq\n\nYou can use [jq](https://jqlang.org/download) to parse the JSON response and set bash variables for use in your scripts:\n\n```bash  theme={null}\n# Get the API response and extract customer information\nexport LANGSMITH_URL=\"<your_langsmith_url>\"\nresponse=$(curl -s $LANGSMITH_URL/api/v1/info)\n\n# Extract customer_id and customer_name using jq\nexport CUSTOMER_ID=$(echo \"$response\" | jq -r '.customer_info.customer_id')\nexport CUSTOMER_NAME=$(echo \"$response\" | jq -r '.customer_info.customer_name')\n\n# Verify the variables are set\necho \"Customer ID: $CUSTOMER_ID\"\necho \"Customer Name: $CUSTOMER_NAME\"\n```\n\nYou can then use these environment variables in your export scripts or other commands.\n\nIf you don't have `jq`, run these commands to set the environment variables based on the curl output:\n\n```bash  theme={null}\ncurl -s $LANGSMITH_URL/api/v1/info\nexport CUSTOMER_ID=\"<id>\"\nexport CUSTOMER_NAME=\"<name>\"\n```\n\n### Initial export\n\nThese scripts export usage data to a CSV for reporting to LangChain. They additionally track the export by assigning a backfill ID and timestamp.\n\nTo export LangSmith trace usage:\n\n```bash  theme={null}\n# Get customer information from the API\nexport LANGSMITH_URL=\"<your_langsmith_url>\"\nexport response=$(curl -s $LANGSMITH_URL/api/v1/info)\nexport CUSTOMER_ID=$(echo \"$response\" | jq -r '.customer_info.customer_id') && echo \"Customer ID: $CUSTOMER_ID\"\nexport CUSTOMER_NAME=$(echo \"$response\" | jq -r '.customer_info.customer_name') && echo \"Customer name: $CUSTOMER_NAME\"\n\n# Run the export script with customer information as variables\nsh run_support_query_pg.sh <postgres_url> \\\n  --input support_queries/postgres/pg_usage_traces_backfill_export.sql \\\n  --output ls_export.csv \\\n  -v customer_id=$CUSTOMER_ID \\\n  -v customer_name=$CUSTOMER_NAME\n```\n\nTo export LangSmith usage:\n\n```bash  theme={null}\nsh run_support_query_pg.sh <postgres_url> \\\n  --input support_queries/postgres/pg_usage_nodes_backfill_export.sql \\\n  --output lgp_export.csv \\\n  -v customer_id=$CUSTOMER_ID \\\n  -v customer_name=$CUSTOMER_NAME\n```\n\n### Status update\n\nThese scripts update the status of usage events in your installation to reflect that the events have been successfully processed by LangChain.\n\nThe scripts require passing in the corresponding `backfill_id`, which will be confirmed by your LangChain rep.\n\nTo update LangSmith trace usage:\n\n```bash  theme={null}\nsh run_support_query_pg.sh <postgres_url> --input support_queries/postgres/pg_usage_traces_backfill_update.sql --output export.csv -v backfill_id=<backfill_id>\n```\n\nTo update LangSmith usage:\n\n```bash  theme={null}\nsh run_support_query_pg.sh <postgres_url> --input support_queries/postgres/pg_usage_nodes_backfill_update.sql --output export.csv -v backfill_id=<backfill_id>\n```\n\n***\n\n<Callout icon=\"pen-to-square\" iconType=\"regular\">\n  [Edit the source of this page on GitHub.](https://github.com/langchain-ai/docs/edit/main/src/langsmith/script-running-pg-support-queries.mdx)\n</Callout>\n\n<Tip icon=\"terminal\" iconType=\"regular\">\n  [Connect these docs programmatically](/use-these-docs) to Claude, VSCode, and more via MCP for real-time answers.\n</Tip>",
  "content_length": 6193
}