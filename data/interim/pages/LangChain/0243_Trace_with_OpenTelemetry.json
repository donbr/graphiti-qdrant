{
  "title": "Trace with OpenTelemetry",
  "source_url": "https://docs.langchain.com/langsmith/trace-with-opentelemetry",
  "content": "LangSmith supports OpenTelemetry-based tracing, allowing you to send traces from any OpenTelemetry-compatible application. This guide covers both automatic instrumentation for LangChain applications and manual instrumentation for other frameworks.\n\nLearn how to trace your LLM applications using OpenTelemetry with LangSmith.\n\n<Note>\n  Update the LangSmith URL appropriately for self-hosted installations or organizations in the EU region in the requests below. For the EU region, use `eu.api.smith.langchain.com`.\n</Note>\n\n## Trace a LangChain application\n\nIf you're using LangChain or LangGraph, use the built-in integration to trace your application:\n\n1. Install the LangSmith package with OpenTelemetry support:\n\n   <CodeGroup>\n     ```bash pip theme={null}\n     pip install \"langsmith[otel]\"\n     pip install langchain\n     ```\n   </CodeGroup>\n\n   <Info>\n     Requires Python SDK version `langsmith>=0.3.18`. We recommend `langsmith>=0.4.25` to benefit from important OpenTelemetry fixes.\n   </Info>\n\n2. In your LangChain/LangGraph App, enable the OpenTelemetry integration by setting the `LANGSMITH_OTEL_ENABLED` environment variable:\n\n   <CodeGroup>\n     ```bash Shell theme={null}\n     LANGSMITH_OTEL_ENABLED=true\n     LANGSMITH_TRACING=true\n     LANGSMITH_ENDPOINT=https://api.smith.langchain.com\n     LANGSMITH_API_KEY=<your_langsmith_api_key>\n     # For LangSmith API keys linked to multiple workspaces, set the LANGSMITH_WORKSPACE_ID environment variable to specify which workspace to use.\n     ```\n   </CodeGroup>\n\n3. Create a LangChain application with tracing. For example:\n\n   ```python  theme={null}\n   import os\n   from langchain_openai import ChatOpenAI\n   from langchain_core.prompts import ChatPromptTemplate\n\n   # Create a chain\n   prompt = ChatPromptTemplate.from_template(\"Tell me a joke about {topic}\")\n   model = ChatOpenAI()\n   chain = prompt | model\n\n   # Run the chain\n   result = chain.invoke({\"topic\": \"programming\"})\n   print(result.content)\n   ```\n\n4. View the traces in your LangSmith dashboard ([example](https://smith.langchain.com/public/a762af6c-b67d-4f22-90a0-728df16baeba/r)) once your application runs.\n\n## Trace a non-LangChain application\n\nFor non-LangChain applications or custom instrumentation, you can trace your application in LangSmith with a standard OpenTelemetry client. (We recommend **langsmith ≥ 0.4.25**.)\n\n1. Install the OpenTelemetry SDK, OpenTelemetry exporter packages, as well as the OpenAI package:\n\n   <CodeGroup>\n     ```bash pip theme={null}\n     pip install openai\n     pip install opentelemetry-sdk\n     pip install opentelemetry-exporter-otlp\n     ```\n   </CodeGroup>\n\n2. Setup environment variables for the endpoint, substitute your specific values:\n\n   <CodeGroup>\n     ```bash Shell theme={null}\n     OTEL_EXPORTER_OTLP_ENDPOINT=https://api.smith.langchain.com/otel\n     OTEL_EXPORTER_OTLP_HEADERS=\"x-api-key=<your langsmith api key>\"\n     ```\n   </CodeGroup>\n\n   <Note>\n     Depending on how your otel exporter is configured, you may need to append `/v1/traces` to the endpoint if you are only sending traces.\n   </Note>\n\n   <Note>\n     If you're self-hosting LangSmith, replace the base endpoint with your LangSmith api endpoint and append `/api/v1`. For example: `OTEL_EXPORTER_OTLP_ENDPOINT=https://ai-company.com/api/v1/otel`\n   </Note>\n\n   Optional: Specify a custom project name other than \"default\":\n\n   <CodeGroup>\n     ```bash Shell theme={null}\n     OTEL_EXPORTER_OTLP_ENDPOINT=https://api.smith.langchain.com/otel\n     OTEL_EXPORTER_OTLP_HEADERS=\"x-api-key=<your langsmith api key>,Langsmith-Project=<project name>\"\n     ```\n   </CodeGroup>\n\n3. Log a trace.\n\n   This code sets up an OTEL tracer and exporter that will send traces to LangSmith. It then calls OpenAI and sends the required OpenTelemetry attributes.\n\n   ```python  theme={null}\n   from openai import OpenAI\n   from opentelemetry import trace\n   from opentelemetry.sdk.trace import TracerProvider\n   from opentelemetry.sdk.trace.export import (\n       BatchSpanProcessor,\n   )\n   from opentelemetry.exporter.otlp.proto.http.trace_exporter import OTLPSpanExporter\n\n   client = OpenAI(api_key=os.getenv(\"OPENAI_API_KEY\"))\n\n   otlp_exporter = OTLPSpanExporter(\n       timeout=10,\n   )\n\n   trace.set_tracer_provider(TracerProvider())\n   trace.get_tracer_provider().add_span_processor(\n       BatchSpanProcessor(otlp_exporter)\n   )\n\n   tracer = trace.get_tracer(__name__)\n\n   def call_openai():\n       model = \"gpt-4o-mini\"\n       with tracer.start_as_current_span(\"call_open_ai\") as span:\n           span.set_attribute(\"langsmith.span.kind\", \"LLM\")\n           span.set_attribute(\"langsmith.metadata.user_id\", \"user_123\")\n           span.set_attribute(\"gen_ai.system\", \"OpenAI\")\n           span.set_attribute(\"gen_ai.request.model\", model)\n           span.set_attribute(\"llm.request.type\", \"chat\")\n\n           messages = [\n               {\"role\": \"system\", \"content\": \"You are a helpful assistant.\"},\n               {\n                   \"role\": \"user\",\n                   \"content\": \"Write a haiku about recursion in programming.\"\n               }\n           ]\n\n           for i, message in enumerate(messages):\n               span.set_attribute(f\"gen_ai.prompt.{i}.content\", str(message[\"content\"]))\n               span.set_attribute(f\"gen_ai.prompt.{i}.role\", str(message[\"role\"]))\n\n           completion = client.chat.completions.create(\n               model=model,\n               messages=messages\n           )\n\n           span.set_attribute(\"gen_ai.response.model\", completion.model)\n           span.set_attribute(\"gen_ai.completion.0.content\", str(completion.choices[0].message.content))\n           span.set_attribute(\"gen_ai.completion.0.role\", \"assistant\")\n           span.set_attribute(\"gen_ai.usage.prompt_tokens\", completion.usage.prompt_tokens)\n           span.set_attribute(\"gen_ai.usage.completion_tokens\", completion.usage.completion_tokens)\n           span.set_attribute(\"gen_ai.usage.total_tokens\", completion.usage.total_tokens)\n\n           return completion.choices[0].message\n\n   if __name__ == \"__main__\":\n       call_openai()\n   ```\n\n4. View the trace in your LangSmith dashboard ([example](https://smith.langchain.com/public/4f2890b1-f105-44aa-a6cf-c777dcc27a37/r)).\n\n## Send traces to an alternate provider\n\nWhile LangSmith is the default destination for OpenTelemetry traces, you can also configure OpenTelemetry to send traces to other observability platforms.\n\n<Info>\n  Available in LangSmith Python SDK **≥ 0.4.1**. We recommend **≥ 0.4.25** for fixes that improve OTEL export and hybrid fan-out stability.\n</Info>\n\n### Use environment variables for global configuration\n\nBy default, the LangSmith OpenTelemetry exporter will send data to the LangSmith API OTEL endpoint, but this can be customized by setting standard OTEL environment variables:\n\n```bash  theme={null}\nOTEL_EXPORTER_OTLP_ENDPOINT: Override the endpoint URL\nOTEL_EXPORTER_OTLP_HEADERS: Add custom headers (LangSmith API keys and Project are added automatically)\nOTEL_SERVICE_NAME: Set a custom service name (defaults to \"langsmith\")\n```\n\nLangSmith uses the HTTP trace exporter by default. If you'd like to use your own tracing provider, you can either:\n\n1. Set the OTEL environment variables as shown above, or\n2. Set a global trace provider before initializing LangChain components, which LangSmith will detect and use instead of creating its own.\n\n### Configure alternate OTLP endpoints\n\nTo send traces to a different provider, configure the OTLP exporter with your provider's endpoint:\n\n```python  theme={null}\nimport os\nfrom opentelemetry import trace\nfrom opentelemetry.sdk.trace import TracerProvider\nfrom opentelemetry.sdk.trace.export import BatchSpanProcessor\nfrom opentelemetry.exporter.otlp.proto.http.trace_exporter import OTLPSpanExporter\nfrom langchain_openai import ChatOpenAI\nfrom langchain_core.prompts import ChatPromptTemplate\n\n# Set environment variables for LangChain\nos.environ[\"LANGSMITH_OTEL_ENABLED\"] = \"true\"\nos.environ[\"LANGSMITH_TRACING\"] = \"true\"\n\n# Configure the OTLP exporter for your custom endpoint\nprovider = TracerProvider()\notlp_exporter = OTLPSpanExporter(\n    # Change to your provider's endpoint\n    endpoint=\"https://otel.your-provider.com/v1/traces\",\n    # Add any required headers for authentication\n    headers={\"api-key\": \"your-api-key\"}\n)\nprocessor = BatchSpanProcessor(otlp_exporter)\nprovider.add_span_processor(processor)\ntrace.set_tracer_provider(provider)\n\n# Create and run a LangChain application\nprompt = ChatPromptTemplate.from_template(\"Tell me a joke about {topic}\")\nmodel = ChatOpenAI()\nchain = prompt | model\nresult = chain.invoke({\"topic\": \"programming\"})\nprint(result.content)\n```\n\n<Info>\n  Hybrid tracing is available in version **≥ 0.4.1**. To send traces **only** to your OTEL endpoint, set:\n\n  `LANGSMITH_OTEL_ONLY=\"true\"`\n  (Recommendation: use **langsmith ≥ 0.4.25**.)\n</Info>\n\n## Supported OpenTelemetry attribute and event mapping\n\nWhen sending traces to LangSmith via OpenTelemetry, the following attributes are mapped to LangSmith fields:\n\n### Core LangSmith attributes\n\n| OpenTelemetry attribute        | LangSmith field  | Notes                                                                        |\n| ------------------------------ | ---------------- | ---------------------------------------------------------------------------- |\n| `langsmith.trace.name`         | Run name         | Overrides the span name for the run                                          |\n| `langsmith.span.kind`          | Run type         | Values: `llm`, `chain`, `tool`, `retriever`, `embedding`, `prompt`, `parser` |\n| `langsmith.trace.session_id`   | Session ID       | Session identifier for related traces                                        |\n| `langsmith.trace.session_name` | Session name     | Name of the session                                                          |\n| `langsmith.span.tags`          | Tags             | Custom tags attached to the span (comma-separated)                           |\n| `langsmith.metadata.{key}`     | `metadata.{key}` | Custom metadata with langsmith prefix                                        |\n\n### GenAI standard attributes\n\n| OpenTelemetry attribute                 | LangSmith field               | Notes                                                         |\n| --------------------------------------- | ----------------------------- | ------------------------------------------------------------- |\n| `gen_ai.system`                         | `metadata.ls_provider`        | The GenAI system (e.g., \"openai\", \"anthropic\")                |\n| `gen_ai.operation.name`                 | Run type                      | Maps \"chat\"/\"completion\" to \"llm\", \"embedding\" to \"embedding\" |\n| `gen_ai.prompt`                         | `inputs`                      | The input prompt sent to the model                            |\n| `gen_ai.completion`                     | `outputs`                     | The output generated by the model                             |\n| `gen_ai.prompt.{n}.role`                | `inputs.messages[n].role`     | Role for the nth input message                                |\n| `gen_ai.prompt.{n}.content`             | `inputs.messages[n].content`  | Content for the nth input message                             |\n| `gen_ai.prompt.{n}.message.role`        | `inputs.messages[n].role`     | Alternative format for role                                   |\n| `gen_ai.prompt.{n}.message.content`     | `inputs.messages[n].content`  | Alternative format for content                                |\n| `gen_ai.completion.{n}.role`            | `outputs.messages[n].role`    | Role for the nth output message                               |\n| `gen_ai.completion.{n}.content`         | `outputs.messages[n].content` | Content for the nth output message                            |\n| `gen_ai.completion.{n}.message.role`    | `outputs.messages[n].role`    | Alternative format for role                                   |\n| `gen_ai.completion.{n}.message.content` | `outputs.messages[n].content` | Alternative format for content                                |\n| `gen_ai.input.messages`                 | `inputs.messages`             | Array of input messages                                       |\n| `gen_ai.output.messages`                | `outputs.messages`            | Array of output messages                                      |\n| `gen_ai.tool.name`                      | `invocation_params.tool_name` | Tool name, also sets run type to \"tool\"                       |\n\n### GenAI request parameters\n\n| OpenTelemetry attribute            | LangSmith field                       | Notes                                   |\n| ---------------------------------- | ------------------------------------- | --------------------------------------- |\n| `gen_ai.request.model`             | `invocation_params.model`             | The model name used for the request     |\n| `gen_ai.response.model`            | `invocation_params.model`             | The model name returned in the response |\n| `gen_ai.request.temperature`       | `invocation_params.temperature`       | Temperature setting                     |\n| `gen_ai.request.top_p`             | `invocation_params.top_p`             | Top-p sampling setting                  |\n| `gen_ai.request.max_tokens`        | `invocation_params.max_tokens`        | Maximum tokens setting                  |\n| `gen_ai.request.frequency_penalty` | `invocation_params.frequency_penalty` | Frequency penalty setting               |\n| `gen_ai.request.presence_penalty`  | `invocation_params.presence_penalty`  | Presence penalty setting                |\n| `gen_ai.request.seed`              | `invocation_params.seed`              | Random seed used for generation         |\n| `gen_ai.request.stop_sequences`    | `invocation_params.stop`              | Sequences that stop generation          |\n| `gen_ai.request.top_k`             | `invocation_params.top_k`             | Top-k sampling parameter                |\n| `gen_ai.request.encoding_formats`  | `invocation_params.encoding_formats`  | Output encoding formats                 |\n\n### GenAI usage metrics\n\n| OpenTelemetry attribute                 | LangSmith field                   | Notes                                     |\n| --------------------------------------- | --------------------------------- | ----------------------------------------- |\n| `gen_ai.usage.input_tokens`             | `usage_metadata.input_tokens`     | Number of input tokens used               |\n| `gen_ai.usage.output_tokens`            | `usage_metadata.output_tokens`    | Number of output tokens used              |\n| `gen_ai.usage.total_tokens`             | `usage_metadata.total_tokens`     | Total number of tokens used               |\n| `gen_ai.usage.prompt_tokens`            | `usage_metadata.input_tokens`     | Number of input tokens used (deprecated)  |\n| `gen_ai.usage.completion_tokens`        | `usage_metadata.output_tokens`    | Number of output tokens used (deprecated) |\n| `gen_ai.usage.details.reasoning_tokens` | `usage_metadata.reasoning_tokens` | Number of reasoning tokens used           |\n\n### TraceLoop attributes\n\n| OpenTelemetry attribute                  | LangSmith field  | Notes                                            |\n| ---------------------------------------- | ---------------- | ------------------------------------------------ |\n| `traceloop.entity.input`                 | `inputs`         | Full input value from TraceLoop                  |\n| `traceloop.entity.output`                | `outputs`        | Full output value from TraceLoop                 |\n| `traceloop.entity.name`                  | Run name         | Entity name from TraceLoop                       |\n| `traceloop.span.kind`                    | Run type         | Maps to LangSmith run types                      |\n| `traceloop.llm.request.type`             | Run type         | \"embedding\" maps to \"embedding\", others to \"llm\" |\n| `traceloop.association.properties.{key}` | `metadata.{key}` | Custom metadata with traceloop prefix            |\n\n### OpenInference attributes\n\n| OpenTelemetry attribute   | LangSmith field          | Notes                                     |\n| ------------------------- | ------------------------ | ----------------------------------------- |\n| `input.value`             | `inputs`                 | Full input value, can be string or JSON   |\n| `output.value`            | `outputs`                | Full output value, can be string or JSON  |\n| `openinference.span.kind` | Run type                 | Maps various kinds to LangSmith run types |\n| `llm.system`              | `metadata.ls_provider`   | LLM system provider                       |\n| `llm.model_name`          | `metadata.ls_model_name` | Model name from OpenInference             |\n| `tool.name`               | Run name                 | Tool name when span kind is \"TOOL\"        |\n| `metadata`                | `metadata.*`             | JSON string of metadata to be merged      |\n\n### LLM attributes\n\n| OpenTelemetry attribute      | LangSmith field                       | Notes                                |\n| ---------------------------- | ------------------------------------- | ------------------------------------ |\n| `llm.input_messages`         | `inputs.messages`                     | Input messages                       |\n| `llm.output_messages`        | `outputs.messages`                    | Output messages                      |\n| `llm.token_count.prompt`     | `usage_metadata.input_tokens`         | Prompt token count                   |\n| `llm.token_count.completion` | `usage_metadata.output_tokens`        | Completion token count               |\n| `llm.token_count.total`      | `usage_metadata.total_tokens`         | Total token count                    |\n| `llm.usage.total_tokens`     | `usage_metadata.total_tokens`         | Alternative total token count        |\n| `llm.invocation_parameters`  | `invocation_params.*`                 | JSON string of invocation parameters |\n| `llm.presence_penalty`       | `invocation_params.presence_penalty`  | Presence penalty                     |\n| `llm.frequency_penalty`      | `invocation_params.frequency_penalty` | Frequency penalty                    |\n| `llm.request.functions`      | `invocation_params.functions`         | Function definitions                 |\n\n### Prompt template attributes\n\n| OpenTelemetry attribute         | LangSmith field | Notes                                            |\n| ------------------------------- | --------------- | ------------------------------------------------ |\n| `llm.prompt_template.variables` | Run type        | Sets run type to \"prompt\", used with input.value |\n\n### Retriever attributes\n\n| OpenTelemetry attribute                     | LangSmith field                     | Notes                                         |\n| ------------------------------------------- | ----------------------------------- | --------------------------------------------- |\n| `retrieval.documents.{n}.document.content`  | `outputs.documents[n].page_content` | Content of the nth retrieved document         |\n| `retrieval.documents.{n}.document.metadata` | `outputs.documents[n].metadata`     | Metadata of the nth retrieved document (JSON) |\n\n### Tool attributes\n\n| OpenTelemetry attribute | LangSmith field                    | Notes                                     |\n| ----------------------- | ---------------------------------- | ----------------------------------------- |\n| `tools`                 | `invocation_params.tools`          | Array of tool definitions                 |\n| `tool_arguments`        | `invocation_params.tool_arguments` | Tool arguments as JSON or key-value pairs |\n\n### Logfire attributes\n\n| OpenTelemetry attribute | LangSmith field    | Notes                                            |\n| ----------------------- | ------------------ | ------------------------------------------------ |\n| `prompt`                | `inputs`           | Logfire prompt input                             |\n| `all_messages_events`   | `outputs`          | Logfire message events output                    |\n| `events`                | `inputs`/`outputs` | Logfire events array, splits input/choice events |\n\n### OpenTelemetry event mapping\n\n| Event name                  | LangSmith field      | Notes                                                            |\n| --------------------------- | -------------------- | ---------------------------------------------------------------- |\n| `gen_ai.content.prompt`     | `inputs`             | Extracts prompt content from event attributes                    |\n| `gen_ai.content.completion` | `outputs`            | Extracts completion content from event attributes                |\n| `gen_ai.system.message`     | `inputs.messages[]`  | System message in conversation                                   |\n| `gen_ai.user.message`       | `inputs.messages[]`  | User message in conversation                                     |\n| `gen_ai.assistant.message`  | `outputs.messages[]` | Assistant message in conversation                                |\n| `gen_ai.tool.message`       | `outputs.messages[]` | Tool response message                                            |\n| `gen_ai.choice`             | `outputs`            | Model choice/response with finish reason                         |\n| `exception`                 | `status`, `error`    | Sets status to \"error\" and extracts exception message/stacktrace |\n\n#### Event attribute extraction\n\nFor message events, the following attributes are extracted:\n\n* `content` → message content\n* `role` → message role\n* `id` → tool\\_call\\_id (for tool messages)\n* `gen_ai.event.content` → full message JSON\n\nFor choice events:\n\n* `finish_reason` → choice finish reason\n* `message.content` → choice message content\n* `message.role` → choice message role\n* `tool_calls.{n}.id` → tool call ID\n* `tool_calls.{n}.function.name` → tool function name\n* `tool_calls.{n}.function.arguments` → tool function arguments\n* `tool_calls.{n}.type` → tool call type\n\nFor exception events:\n\n* `exception.message` → error message\n* `exception.stacktrace` → error stacktrace (appended to message)\n\n## Implementation examples\n\n### Trace using the LangSmith SDK\n\nUse the LangSmith SDK's OpenTelemetry helper to configure export:\n\n```python  theme={null}\nimport asyncio\nfrom langsmith.integrations.otel import configure\nfrom google.adk import Runner\nfrom google.adk.agents import LlmAgent\nfrom google.adk.sessions import InMemorySessionService\nfrom google.genai import types\n\n# Configure LangSmith OpenTelemetry export (no OTEL env vars or headers needed)\nconfigure(project_name=\"adk-otel-demo\")\n\n\nasync def main():\n    agent = LlmAgent(\n        name=\"travel_assistant\",\n        model=\"gemini-2.5-flash-lite\",\n        instruction=\"You are a helpful travel assistant.\",\n    )\n\n    session_service = InMemorySessionService()\n    runner = Runner(app_name=\"travel_app\", agent=agent, session_service=session_service)\n\n    user_id = \"user_123\"\n    session_id = \"session_abc\"\n    await session_service.create_session(app_name=\"travel_app\", user_id=user_id, session_id=session_id)\n\n    new_message = types.Content(parts=[types.Part(text=\"Hi! Recommend a weekend trip to Paris.\")], role=\"user\")\n\n    for event in runner.run(user_id=user_id, session_id=session_id, new_message=new_message):\n        print(event)\n\n\nif __name__ == \"__main__\":\n    asyncio.run(main())\n```\n\n<Note>\n  You do not need to set OTEL environment variables or exporters. `configure()` wires them for LangSmith automatically; instrumentors (like `GoogleADKInstrumentor`) create the spans.\n</Note>\n\n5. View the trace in your LangSmith dashboard ([example](https://smith.langchain.com/public/106f5bed-edca-4357-91a5-80089252c9ed/r)).\n\n## Advanced configuration\n\n### Use OpenTelemetry Collector for fan-out\n\nFor more advanced scenarios, you can use the OpenTelemetry Collector to fan out your telemetry data to multiple destinations. This is a more scalable approach than configuring multiple exporters in your application code.\n\n1. [Install the OpenTelemetry Collector](https://opentelemetry.io/docs/collector/getting-started/) for your environment.\n\n2. Create a configuration file (e.g., `otel-collector-config.yaml`) that exports to multiple destinations:\n\n   ```yaml  theme={null}\n   receivers:\n     otlp:\n       protocols:\n         grpc:\n           endpoint: 0.0.0.0:4317\n         http:\n           endpoint: 0.0.0.0:4318\n\n   processors:\n     batch:\n\n   exporters:\n     otlphttp/langsmith:\n       endpoint: https://api.smith.langchain.com/otel/v1/traces\n       headers:\n         x-api-key: ${env:LANGSMITH_API_KEY}\n         Langsmith-Project: my_project\n     otlphttp/other_provider:\n       endpoint: https://otel.your-provider.com/v1/traces\n       headers:\n         api-key: ${env:OTHER_PROVIDER_API_KEY}\n\n   service:\n     pipelines:\n       traces:\n         receivers: [otlp]\n         processors: [batch]\n         exporters: [otlphttp/langsmith, otlphttp/other_provider]\n   ```\n\n3. Configure your application to send to the collector:\n\n   ```python  theme={null}\n   import os\n   from opentelemetry import trace\n   from opentelemetry.sdk.trace import TracerProvider\n   from opentelemetry.sdk.trace.export import BatchSpanProcessor\n   from opentelemetry.exporter.otlp.proto.http.trace_exporter import OTLPSpanExporter\n   from langchain_openai import ChatOpenAI\n   from langchain_core.prompts import ChatPromptTemplate\n\n   # Point to your local OpenTelemetry Collector\n   otlp_exporter = OTLPSpanExporter(\n       endpoint=\"http://localhost:4318/v1/traces\"\n   )\n   provider = TracerProvider()\n   processor = BatchSpanProcessor(otlp_exporter)\n   provider.add_span_processor(processor)\n   trace.set_tracer_provider(provider)\n\n   # Set environment variables for LangChain\n   os.environ[\"LANGSMITH_OTEL_ENABLED\"] = \"true\"\n   os.environ[\"LANGSMITH_TRACING\"] = \"true\"\n\n   # Create and run a LangChain application\n   prompt = ChatPromptTemplate.from_template(\"Tell me a joke about {topic}\")\n   model = ChatOpenAI()\n   chain = prompt | model\n   result = chain.invoke({\"topic\": \"programming\"})\n   print(result.content)\n   ```\n\nThis approach offers several advantages:\n\n* Centralized configuration for all your telemetry destinations\n* Reduced overhead in your application code\n* Better scalability and resilience\n* Ability to add or remove destinations without changing application code\n\n### Distributed tracing with LangChain and OpenTelemetry\n\nDistributed tracing is essential when your LLM application spans multiple services or processes. OpenTelemetry's context propagation capabilities ensure that traces remain connected across service boundaries.\n\n#### Context propagation in distributed tracing\n\nIn distributed systems, context propagation passes trace metadata between services so that related spans are linked to the same trace:\n\n* **Trace ID**: A unique identifier for the entire trace\n* **Span ID**: A unique identifier for the current span\n* **Sampling Decision**: Indicates whether this trace should be sampled\n\n#### Set up distributed tracing with LangChain\n\nTo enable distributed tracing across multiple services:\n\n```python  theme={null}\nimport os\nfrom opentelemetry import trace\nfrom opentelemetry.propagate import inject, extract\nfrom opentelemetry.sdk.trace import TracerProvider\nfrom opentelemetry.sdk.trace.export import BatchSpanProcessor\nfrom opentelemetry.exporter.otlp.proto.http.trace_exporter import OTLPSpanExporter\nimport requests\nfrom langchain_openai import ChatOpenAI\nfrom langchain_core.prompts import ChatPromptTemplate\n\n# Set up OpenTelemetry trace provider\nprovider = TracerProvider()\notlp_exporter = OTLPSpanExporter(\n    endpoint=\"https://api.smith.langchain.com/otel/v1/traces\",\n    headers={\"x-api-key\": os.getenv(\"LANGSMITH_API_KEY\"), \"Langsmith-Project\": \"my_project\"}\n)\nprocessor = BatchSpanProcessor(otlp_exporter)\nprovider.add_span_processor(processor)\ntrace.set_tracer_provider(provider)\ntracer = trace.get_tracer(__name__)\n\n# Service A: Create a span and propagate context to Service B\ndef service_a():\n    with tracer.start_as_current_span(\"service_a_operation\") as span:\n        # Create a chain\n        prompt = ChatPromptTemplate.from_template(\"Summarize: {text}\")\n        model = ChatOpenAI()\n        chain = prompt | model\n\n        # Run the chain\n        result = chain.invoke({\"text\": \"OpenTelemetry is an observability framework\"})\n\n        # Propagate context to Service B\n        headers = {}\n        inject(headers)  # Inject trace context into headers\n\n        # Call Service B with the trace context\n        response = requests.post(\n            \"http://service-b.example.com/process\",\n            headers=headers,\n            json={\"summary\": result.content}\n        )\n        return response.json()\n\n# Service B: Extract the context and continue the trace\nfrom flask import Flask, request, jsonify\n\napp = Flask(__name__)\n\n@app.route(\"/process\", methods=[\"POST\"])\ndef service_b_endpoint():\n    # Extract the trace context from the request headers\n    context = extract(request.headers)\n    with tracer.start_as_current_span(\"service_b_operation\", context=context) as span:\n        data = request.json\n        summary = data.get(\"summary\", \"\")\n\n        # Process the summary with another LLM chain\n        prompt = ChatPromptTemplate.from_template(\"Analyze the sentiment of: {text}\")\n        model = ChatOpenAI()\n        chain = prompt | model\n        result = chain.invoke({\"text\": summary})\n\n        return jsonify({\"analysis\": result.content})\n\nif __name__ == \"__main__\":\n    app.run(port=5000)\n```\n\n***\n\n<Callout icon=\"pen-to-square\" iconType=\"regular\">\n  [Edit the source of this page on GitHub.](https://github.com/langchain-ai/docs/edit/main/src/langsmith/trace-with-opentelemetry.mdx)\n</Callout>\n\n<Tip icon=\"terminal\" iconType=\"regular\">\n  [Connect these docs programmatically](/use-these-docs) to Claude, VSCode, and more via MCP for real-time answers.\n</Tip>",
  "content_length": 30062
}