{
  "title": "How to add custom lifespan events",
  "source_url": "https://docs.langchain.com/langsmith/custom-lifespan",
  "content": "When deploying agents to LangSmith, you often need to initialize resources like database connections when your server starts up, and ensure they're properly closed when it shuts down. Lifespan events let you hook into your server's startup and shutdown sequence to handle these critical setup and teardown tasks.\n\nThis works the same way as [adding custom routes](/langsmith/custom-routes). You just need to provide your own [`Starlette`](https://www.starlette.io/applications/) app (including [`FastAPI`](https://fastapi.tiangolo.com/), [`FastHTML`](https://fastht.ml/) and other compatible apps).\n\nBelow is an example using FastAPI.\n\n<Note>\n  \"Python only\"\n  We currently only support custom lifespan events in Python deployments with `langgraph-api>=0.0.26`.\n</Note>\n\n## Create app\n\nStarting from an **existing** LangSmith application, add the following lifespan code to your `webapp.py` file. If you are starting from scratch, you can create a new app from a template using the CLI.\n\n```bash  theme={null}\nlanggraph new --template=new-langgraph-project-python my_new_project\n```\n\nOnce you have a LangGraph project, add the following app code:\n\n```python {highlight={19}} theme={null}\n# ./src/agent/webapp.py\nfrom contextlib import asynccontextmanager\nfrom fastapi import FastAPI\nfrom sqlalchemy.ext.asyncio import create_async_engine, AsyncSession\nfrom sqlalchemy.orm import sessionmaker\n\n@asynccontextmanager\nasync def lifespan(app: FastAPI):\n    # for example...\n    engine = create_async_engine(\"postgresql+asyncpg://user:pass@localhost/db\")\n    # Create reusable session factory\n    async_session = sessionmaker(engine, class_=AsyncSession)\n    # Store in app state\n    app.state.db_session = async_session\n    yield\n    # Clean up connections\n    await engine.dispose()\n\napp = FastAPI(lifespan=lifespan)\n\n# ... can add custom routes if needed.\n```\n\n## Configure `langgraph.json`\n\nAdd the following to your `langgraph.json` configuration file. Make sure the path points to the `webapp.py` file you created above.\n\n```json  theme={null}\n{\n  \"dependencies\": [\".\"],\n  \"graphs\": {\n    \"agent\": \"./src/agent/graph.py:graph\"\n  },\n  \"env\": \".env\",\n  \"http\": {\n    \"app\": \"./src/agent/webapp.py:app\"\n  }\n  // Other configuration options like auth, store, etc.\n}\n```\n\n## Start server\n\nTest the server out locally:\n\n```bash  theme={null}\nlanggraph dev --no-browser\n```\n\nYou should see your startup message printed when the server starts, and your cleanup message when you stop it with `Ctrl+C`.\n\n## Deploying\n\nYou can deploy your app as-is to cloud or to your self-hosted platform.\n\n## Next steps\n\nNow that you've added lifespan events to your deployment, you can use similar techniques to add [custom routes](/langsmith/custom-routes) or [custom middleware](/langsmith/custom-middleware) to further customize your server's behavior.\n\n***\n\n<Callout icon=\"pen-to-square\" iconType=\"regular\">\n  [Edit the source of this page on GitHub.](https://github.com/langchain-ai/docs/edit/main/src/langsmith/custom-lifespan.mdx)\n</Callout>\n\n<Tip icon=\"terminal\" iconType=\"regular\">\n  [Connect these docs programmatically](/use-these-docs) to Claude, VSCode, and more via MCP for real-time answers.\n</Tip>",
  "content_length": 3189
}