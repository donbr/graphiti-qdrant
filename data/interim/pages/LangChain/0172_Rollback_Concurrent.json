{
  "title": "Rollback Concurrent",
  "source_url": "https://docs.langchain.com/langsmith/rollback-concurrent",
  "content": "This guide assumes knowledge of what double-texting is, which you can learn about in the [double-texting conceptual guide](/langsmith/double-texting).\n\nThe guide covers the `rollback` option for double texting, which interrupts the prior run of the graph and starts a new one with the double-text. This option is very similar to the `interrupt` option, but in this case the first run is completely deleted from the database and cannot be restarted. Below is a quick example of using the `rollback` option.\n\n## Setup\n\nFirst, we will define a quick helper function for printing out JS and CURL model outputs (you can skip this if using Python):\n\n<Tabs>\n  <Tab title=\"Javascript\">\n    ```js  theme={null}\n    function prettyPrint(m) {\n      const padded = \" \" + m['type'] + \" \";\n      const sepLen = Math.floor((80 - padded.length) / 2);\n      const sep = \"=\".repeat(sepLen);\n      const secondSep = sep + (padded.length % 2 ? \"=\" : \"\");\n\n      console.log(`${sep}${padded}${secondSep}`);\n      console.log(\"\\n\\n\");\n      console.log(m.content);\n    }\n    ```\n  </Tab>\n\n  <Tab title=\"CURL\">\n    ```bash  theme={null}\n    # PLACE THIS IN A FILE CALLED pretty_print.sh\n    pretty_print() {\n      local type=\"$1\"\n      local content=\"$2\"\n      local padded=\" $type \"\n      local total_width=80\n      local sep_len=$(( (total_width - ${#padded}) / 2 ))\n      local sep=$(printf '=%.0s' $(eval \"echo {1..\"${sep_len}\"}\"))\n      local second_sep=$sep\n      if (( (total_width - ${#padded}) % 2 )); then\n        second_sep=\"${second_sep}=\"\n      fi\n\n      echo \"${sep}${padded}${second_sep}\"\n      echo\n      echo \"$content\"\n    }\n    ```\n  </Tab>\n</Tabs>\n\nNow, let's import our required packages and instantiate our client, assistant, and thread.\n\n<Tabs>\n  <Tab title=\"Python\">\n    ```python  theme={null}\n    import asyncio\n\n    import httpx\n    from langchain_core.messages import convert_to_messages\n    from langgraph_sdk import get_client\n\n    client = get_client(url=<DEPLOYMENT_URL>)\n    # Using the graph deployed with the name \"agent\"\n    assistant_id = \"agent\"\n    thread = await client.threads.create()\n    ```\n  </Tab>\n\n  <Tab title=\"Javascript\">\n    ```js  theme={null}\n    import { Client } from \"@langchain/langgraph-sdk\";\n\n    const client = new Client({ apiUrl: <DEPLOYMENT_URL> });\n    // Using the graph deployed with the name \"agent\"\n    const assistantId = \"agent\";\n    const thread = await client.threads.create();\n    ```\n  </Tab>\n\n  <Tab title=\"CURL\">\n    ```bash  theme={null}\n    curl --request POST \\\n      --url <DEPLOYMENT_URL>/threads \\\n      --header 'Content-Type: application/json' \\\n      --data '{}'\n    ```\n  </Tab>\n</Tabs>\n\n## Create runs\n\nNow let's run a thread with the multitask parameter set to \"rollback\":\n\n<Tabs>\n  <Tab title=\"Python\">\n    ```python  theme={null}\n    # the first run will be rolled back\n    rolled_back_run = await client.runs.create(\n        thread[\"thread_id\"],\n        assistant_id,\n        input={\"messages\": [{\"role\": \"user\", \"content\": \"what's the weather in sf?\"}]},\n    )\n    run = await client.runs.create(\n        thread[\"thread_id\"],\n        assistant_id,\n        input={\"messages\": [{\"role\": \"user\", \"content\": \"what's the weather in nyc?\"}]},\n        multitask_strategy=\"rollback\",\n    )\n    # wait until the second run completes\n    await client.runs.join(thread[\"thread_id\"], run[\"run_id\"])\n    ```\n  </Tab>\n\n  <Tab title=\"Javascript\">\n    ```js  theme={null}\n    // the first run will be interrupted\n    let rolledBackRun = await client.runs.create(\n      thread[\"thread_id\"],\n      assistantId,\n      { input: { messages: [{ role: \"human\", content: \"what's the weather in sf?\" }] } }\n    );\n\n    let run = await client.runs.create(\n      thread[\"thread_id\"],\n      assistant_id,\n      {\n        input: { messages: [{ role: \"human\", content: \"what's the weather in nyc?\" }] },\n        multitaskStrategy: \"rollback\"\n      }\n    );\n\n    // wait until the second run completes\n    await client.runs.join(thread[\"thread_id\"], run[\"run_id\"]);\n    ```\n  </Tab>\n\n  <Tab title=\"CURL\">\n    ```bash  theme={null}\n    curl --request POST \\\n    --url <DEPLOY<ENT_URL>>/threads/<THREAD_ID>/runs \\\n    --header 'Content-Type: application/json' \\\n    --data \"{\n      \\\"assistant_id\\\": \\\"agent\\\",\n      \\\"input\\\": {\\\"messages\\\": [{\\\"role\\\": \\\"human\\\", \\\"content\\\": \\\"what\\'s the weather in sf?\\\"}]},\n    }\" && curl --request POST \\\n    --url <DEPLOY<ENT_URL>>/threads/<THREAD_ID>/runs \\\n    --header 'Content-Type: application/json' \\\n    --data \"{\n      \\\"assistant_id\\\": \\\"agent\\\",\n      \\\"input\\\": {\\\"messages\\\": [{\\\"role\\\": \\\"human\\\", \\\"content\\\": \\\"what\\'s the weather in nyc?\\\"}]},\n      \\\"multitask_strategy\\\": \\\"rollback\\\"\n    }\" && curl --request GET \\\n    --url <DEPLOYMENT_URL>/threads/<THREAD_ID>/runs/<RUN_ID>/join\n    ```\n  </Tab>\n</Tabs>\n\n## View run results\n\nWe can see that the thread has data only from the second run\n\n<Tabs>\n  <Tab title=\"Python\">\n    ```python  theme={null}\n    state = await client.threads.get_state(thread[\"thread_id\"])\n\n    for m in convert_to_messages(state[\"values\"][\"messages\"]):\n        m.pretty_print()\n    ```\n  </Tab>\n\n  <Tab title=\"Javascript\">\n    ```js  theme={null}\n    const state = await client.threads.getState(thread[\"thread_id\"]);\n\n    for (const m of state['values']['messages']) {\n      prettyPrint(m);\n    }\n    ```\n  </Tab>\n\n  <Tab title=\"CURL\">\n    ```bash  theme={null}\n    source pretty_print.sh && curl --request GET \\\n    --url <DEPLOYMENT_URL>/threads/<THREAD_ID>/state | \\\n    jq -c '.values.messages[]' | while read -r element; do\n        type=$(echo \"$element\" | jq -r '.type')\n        content=$(echo \"$element\" | jq -r '.content | if type == \"array\" then tostring else . end')\n        pretty_print \"$type\" \"$content\"\n    done\n    ```\n  </Tab>\n</Tabs>\n\nOutput:\n\n```\n================================ Human Message =================================\n\nwhat's the weather in nyc?\n================================== Ai Message ==================================\n\n[{'id': 'toolu_01JzPqefao1gxwajHQ3Yh3JD', 'input': {'query': 'weather in nyc'}, 'name': 'tavily_search_results_json', 'type': 'tool_use'}]\nTool Calls:\ntavily_search_results_json (toolu_01JzPqefao1gxwajHQ3Yh3JD)\nCall ID: toolu_01JzPqefao1gxwajHQ3Yh3JD\nArgs:\nquery: weather in nyc\n================================= Tool Message =================================\nName: tavily_search_results_json\n\n[{\"url\": \"https://www.weatherapi.com/\", \"content\": \"{'location': {'name': 'New York', 'region': 'New York', 'country': 'United States of America', 'lat': 40.71, 'lon': -74.01, 'tz_id': 'America/New_York', 'localtime_epoch': 1718734479, 'localtime': '2024-06-18 14:14'}, 'current': {'last_updated_epoch': 1718733600, 'last_updated': '2024-06-18 14:00', 'temp_c': 29.4, 'temp_f': 84.9, 'is_day': 1, 'condition': {'text': 'Sunny', 'icon': '//cdn.weatherapi.com/weather/64x64/day/113.png', 'code': 1000}, 'wind_mph': 2.2, 'wind_kph': 3.6, 'wind_degree': 158, 'wind_dir': 'SSE', 'pressure_mb': 1025.0, 'pressure_in': 30.26, 'precip_mm': 0.0, 'precip_in': 0.0, 'humidity': 63, 'cloud': 0, 'feelslike_c': 31.3, 'feelslike_f': 88.3, 'windchill_c': 28.3, 'windchill_f': 82.9, 'heatindex_c': 29.6, 'heatindex_f': 85.3, 'dewpoint_c': 18.4, 'dewpoint_f': 65.2, 'vis_km': 16.0, 'vis_miles': 9.0, 'uv': 7.0, 'gust_mph': 16.5, 'gust_kph': 26.5}}\"}]\n================================== Ai Message ==================================\n\nThe weather API results show that the current weather in New York City is sunny with a temperature of around 85°F (29°C). The wind is light at around 2-3 mph from the south-southeast. Overall it looks like a nice sunny summer day in NYC.\n```\n\nVerify that the original, rolled back run was deleted\n\n<Tabs>\n  <Tab title=\"Python\">\n    ```python  theme={null}\n    try:\n        await client.runs.get(thread[\"thread_id\"], rolled_back_run[\"run_id\"])\n    except httpx.HTTPStatusError as _:\n        print(\"Original run was correctly deleted\")\n    ```\n  </Tab>\n\n  <Tab title=\"Javascript\">\n    ```js  theme={null}\n    try {\n      await client.runs.get(thread[\"thread_id\"], rolledBackRun[\"run_id\"]);\n    } catch (e) {\n      console.log(\"Original run was correctly deleted\");\n    }\n    ```\n  </Tab>\n</Tabs>\n\nOutput:\n\n```\nOriginal run was correctly deleted\n```\n\n***\n\n<Callout icon=\"pen-to-square\" iconType=\"regular\">\n  [Edit the source of this page on GitHub.](https://github.com/langchain-ai/docs/edit/main/src/langsmith/rollback-concurrent.mdx)\n</Callout>\n\n<Tip icon=\"terminal\" iconType=\"regular\">\n  [Connect these docs programmatically](/use-these-docs) to Claude, VSCode, and more via MCP for real-time answers.\n</Tip>",
  "content_length": 8594
}