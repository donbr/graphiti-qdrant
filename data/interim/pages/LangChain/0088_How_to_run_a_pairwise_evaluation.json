{
  "title": "How to run a pairwise evaluation",
  "source_url": "https://docs.langchain.com/langsmith/evaluate-pairwise",
  "content": "<Info>\n  Concept: [Pairwise evaluations](/langsmith/evaluation-concepts#pairwise)\n</Info>\n\nLangSmith supports evaluating **existing** experiments in a comparative manner. Instead of evaluating one output at a time, you can score the output from multiple experiments against each other. In this guide, you'll use [`evaluate()`](https://docs.smith.langchain.com/reference/python/evaluation/langsmith.evaluation._runner.evaluate) with two existing experiments to [define an evaluator](#define-a-pairwise-evaluator) and [run a pairwise evaluation](#run-a-pairwise-evaluation). Finally, you'll use the LangSmith UI to [view the pairwise experiments](#view-pairwise-experiments).\n\n## Prerequisites\n\n* If you haven't already created experiments to compare, check out the [quick start](/langsmith/evaluation-quickstart) or the [how-to guide](/langsmith/evaluate-llm-application) to get started with evaluations.\n* This guide requires `langsmith` Python version `>=0.2.0` or JS version `>=0.2.9`.\n\n<Info>\n  You can also use [`evaluate_comparative()`](https://docs.smith.langchain.com/reference/python/evaluation/langsmith.evaluation._runner.evaluate_comparative) with more than two existing experiments.\n</Info>\n\n## `evaluate()` comparative args\n\nAt its simplest, `evaluate` / `aevaluate` function takes the following arguments:\n\n| Argument     | Description                                                                                                                        |\n| ------------ | ---------------------------------------------------------------------------------------------------------------------------------- |\n| `target`     | A list of the two **existing experiments** you would like to evaluate against each other. These can be uuids or experiment names.  |\n| `evaluators` | A list of the pairwise evaluators that you would like to attach to this evaluation. See the section below for how to define these. |\n\nAlong with these, you can also pass in the following optional args:\n\n| Argument                                 | Description                                                                                                                                                                                                                                                                                                                                                                    |\n| ---------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |\n| `randomize_order` / `randomizeOrder`     | An optional boolean indicating whether the order of the outputs should be randomized for each evaluation. This is a strategy for minimizing positional bias in your prompt: often, the LLM will be biased towards one of the responses based on the order. This should mainly be addressed via prompt engineering, but this is another optional mitigation. Defaults to False. |\n| `experiment_prefix` / `experimentPrefix` | A prefix to be attached to the beginning of the pairwise experiment name. Defaults to None.                                                                                                                                                                                                                                                                                    |\n| `description`                            | A description of the pairwise experiment. Defaults to None.                                                                                                                                                                                                                                                                                                                    |\n| `max_concurrency` / `maxConcurrency`     | The maximum number of concurrent evaluations to run. Defaults to 5.                                                                                                                                                                                                                                                                                                            |\n| `client`                                 | The LangSmith client to use. Defaults to None.                                                                                                                                                                                                                                                                                                                                 |\n| `metadata`                               | Metadata to attach to your pairwise experiment. Defaults to None.                                                                                                                                                                                                                                                                                                              |\n| `load_nested` / `loadNested`             | Whether to load all child runs for the experiment. When False, only the root trace will be passed to your evaluator. Defaults to False.                                                                                                                                                                                                                                        |\n\n## Define a pairwise evaluator\n\nPairwise evaluators are just functions with an expected signature.\n\n### Evaluator args\n\nCustom evaluator functions must have specific argument names. They can take any subset of the following arguments:\n\n* `inputs: dict`: A dictionary of the inputs corresponding to a single example in a dataset.\n* `outputs: list[dict]`: A two-item list of the dict outputs produced by each experiment on the given inputs.\n* `reference_outputs` / `referenceOutputs: dict`: A dictionary of the reference outputs associated with the example, if available.\n* `runs: list[Run]`: A two-item list of the full [Run](/langsmith/run-data-format) objects generated by the two experiments on the given example. Use this if you need access to intermediate steps or metadata about each run.\n* `example: Example`: The full dataset [Example](/langsmith/example-data-format), including the example inputs, outputs (if available), and metadata (if available).\n\nFor most use cases you'll only need `inputs`, `outputs`, and `reference_outputs` / `referenceOutputs`. `runs` and `example` are useful only if you need some extra trace or example metadata outside of the actual inputs and outputs of the application.\n\n### Evaluator output\n\nCustom evaluators are expected to return one of the following types:\n\nPython and JS/TS\n\n* `dict`: dictionary with keys:\n\n  * `key`, which represents the feedback key that will be logged\n  * `scores`, which is a mapping from run ID to score for that run.\n  * `comment`, which is a string. Most commonly used for model reasoning.\n\nCurrently Python only\n\n* `list[int | float | bool]`: a two-item list of scores. The list is assumed to have the same order as the `runs` / `outputs` evaluator args. The evaluator function name is used for the feedback key.\n\nNote that you should choose a feedback key that is distinct from standard feedbacks on your run. We recommend prefixing pairwise feedback keys with `pairwise_` or `ranked_`.\n\n## Run a pairwise evaluation\n\nThe following example uses [a prompt](https://smith.langchain.com/hub/langchain-ai/pairwise-evaluation-2) which asks the LLM to decide which is better between two AI assistant responses. It uses structured output to parse the AI's response: 0, 1, or 2.\n\n<Info>\n  In the Python example below, we are pulling [this structured prompt](https://smith.langchain.com/hub/langchain-ai/pairwise-evaluation-2) from the [LangChain Hub](/langsmith/manage-prompts#public-prompt-hub) and using it with a LangChain chat model wrapper.\n\n  **Usage of LangChain is totally optional.** To illustrate this point, the TypeScript example uses the OpenAI SDK directly.\n</Info>\n\n* Python: Requires `langsmith>=0.2.0`\n* TypeScript: Requires `langsmith>=0.2.9`\n\n<CodeGroup>\n  ```python Python theme={null}\n  from langchain_classic import hub\n  from langchain.chat_models import init_chat_model\n  from langsmith import evaluate\n\n  # See the prompt: https://smith.langchain.com/hub/langchain-ai/pairwise-evaluation-2\n  prompt = hub.pull(\"langchain-ai/pairwise-evaluation-2\")\n  model = init_chat_model(\"gpt-4o\")\n  chain = prompt | model\n\n  def ranked_preference(inputs: dict, outputs: list[dict]) -> list:\n      # Assumes example inputs have a 'question' key and experiment\n      # outputs have an 'answer' key.\n      response = chain.invoke({\n          \"question\": inputs[\"question\"],\n          \"answer_a\": outputs[0].get(\"answer\", \"N/A\"),\n          \"answer_b\": outputs[1].get(\"answer\", \"N/A\"),\n      })\n      if response[\"Preference\"] == 1:\n          scores = [1, 0]\n      elif response[\"Preference\"] == 2:\n          scores = [0, 1]\n      else:\n          scores = [0, 0]\n      return scores\n\n  evaluate(\n      (\"experiment-1\", \"experiment-2\"),  # Replace with the names/IDs of your experiments\n      evaluators=[ranked_preference],\n      randomize_order=True,\n      max_concurrency=4,\n  )\n  ```\n\n  ```typescript TypeScript theme={null}\n  import { evaluate} from \"langsmith/evaluation\";\n  import { Run } from \"langsmith/schemas\";\n  import { wrapOpenAI } from \"langsmith/wrappers\";\n  import OpenAI from \"openai\";\n  import { z } from \"zod\";\n\n  const openai = wrapOpenAI(new OpenAI());\n\n  async function rankedPreference({\n    inputs,\n    runs,\n  }: {\n    inputs: Record<string, any>;\n    runs: Run[];\n  }) {\n    const scores: Record<string, number> = {};\n    const [runA, runB] = runs;\n    if (!runA || !runB) throw new Error(\"Expected at least two runs\");\n\n    const payload = {\n      question: inputs.question,\n      answer_a: runA?.outputs?.output ?? \"N/A\",\n      answer_b: runB?.outputs?.output ?? \"N/A\",\n    };\n\n    const output = await openai.chat.completions.create({\n      model: \"gpt-4-turbo\",\n      messages: [\n        {\n          role: \"system\",\n          content: [\n            \"Please act as an impartial judge and evaluate the quality of the responses provided by two AI assistants to the user question displayed below.\",\n            \"You should choose the assistant that follows the user's instructions and answers the user's question better.\",\n            \"Your evaluation should consider factors such as the helpfulness, relevance, accuracy, depth, creativity, and level of detail of their responses.\",\n            \"Begin your evaluation by comparing the two responses and provide a short explanation.\",\n            \"Avoid any position biases and ensure that the order in which the responses were presented does not influence your decision.\",\n            \"Do not allow the length of the responses to influence your evaluation. Do not favor certain names of the assistants. Be as objective as possible.\",\n          ].join(\" \"),\n        },\n        {\n          role: \"user\",\n          content: [\n            `[User Question] ${payload.question}`,\n            `[The Start of Assistant A's Answer] ${payload.answer_a} [The End of Assistant A's Answer]`,\n            `The Start of Assistant B's Answer] ${payload.answer_b} [The End of Assistant B's Answer]`,\n          ].join(\"\\n\\n\"),\n        },\n      ],\n      tool_choice: {\n        type: \"function\",\n        function: { name: \"Score\" },\n      },\n      tools: [\n        {\n          type: \"function\",\n          function: {\n            name: \"Score\",\n            description: [\n              `After providing your explanation, output your final verdict by strictly following this format:`,\n              `Output \"1\" if Assistant A answer is better based upon the factors above.`,\n              `Output \"2\" if Assistant B answer is better based upon the factors above.`,\n              `Output \"0\" if it is a tie.`,\n            ].join(\" \"),\n            parameters: {\n              type: \"object\",\n              properties: {\n                Preference: {\n                  type: \"integer\",\n                  description: \"Which assistant answer is preferred?\",\n                },\n              },\n            },\n          },\n        },\n      ],\n    });\n\n    const { Preference } = z\n      .object({ Preference: z.number() })\n      .parse(\n        JSON.parse(output.choices[0].message.tool_calls[0].function.arguments)\n      );\n\n    if (Preference === 1) {\n      scores[runA.id] = 1;\n      scores[runB.id] = 0;\n    } else if (Preference === 2) {\n      scores[runA.id] = 0;\n      scores[runB.id] = 1;\n    } else {\n      scores[runA.id] = 0;\n      scores[runB.id] = 0;\n    }\n\n    return { key: \"ranked_preference\", scores };\n  }\n\n  await evaluate([\"earnest-name-40\", \"reflecting-pump-91\"], {\n    evaluators: [rankedPreference],\n  });\n  ```\n</CodeGroup>\n\n## View pairwise experiments\n\nNavigate to the \"Pairwise Experiments\" tab from the dataset page:\n\n<img src=\"https://mintcdn.com/langchain-5e9cc07a/H9jA2WRyA-MV4-H0/langsmith/images/pairwise-from-dataset.png?fit=max&auto=format&n=H9jA2WRyA-MV4-H0&q=85&s=dddf35fd971055d0d94ae4184c91dea3\" alt=\"Pairwise Experiments Tab\" data-og-width=\"3454\" width=\"3454\" data-og-height=\"1912\" height=\"1912\" data-path=\"langsmith/images/pairwise-from-dataset.png\" data-optimize=\"true\" data-opv=\"3\" srcset=\"https://mintcdn.com/langchain-5e9cc07a/H9jA2WRyA-MV4-H0/langsmith/images/pairwise-from-dataset.png?w=280&fit=max&auto=format&n=H9jA2WRyA-MV4-H0&q=85&s=4c1677867b832da9c3b4338a210570f8 280w, https://mintcdn.com/langchain-5e9cc07a/H9jA2WRyA-MV4-H0/langsmith/images/pairwise-from-dataset.png?w=560&fit=max&auto=format&n=H9jA2WRyA-MV4-H0&q=85&s=80d4795bc999156850eb8092e8267c9f 560w, https://mintcdn.com/langchain-5e9cc07a/H9jA2WRyA-MV4-H0/langsmith/images/pairwise-from-dataset.png?w=840&fit=max&auto=format&n=H9jA2WRyA-MV4-H0&q=85&s=ed2e5fb624828fb649bf33473e7dc797 840w, https://mintcdn.com/langchain-5e9cc07a/H9jA2WRyA-MV4-H0/langsmith/images/pairwise-from-dataset.png?w=1100&fit=max&auto=format&n=H9jA2WRyA-MV4-H0&q=85&s=05c2248284b4efb2f5a9f38cffef0b9b 1100w, https://mintcdn.com/langchain-5e9cc07a/H9jA2WRyA-MV4-H0/langsmith/images/pairwise-from-dataset.png?w=1650&fit=max&auto=format&n=H9jA2WRyA-MV4-H0&q=85&s=3014131b2f5ae730aa354afaa7312316 1650w, https://mintcdn.com/langchain-5e9cc07a/H9jA2WRyA-MV4-H0/langsmith/images/pairwise-from-dataset.png?w=2500&fit=max&auto=format&n=H9jA2WRyA-MV4-H0&q=85&s=38c4f707158930cf7d1d155db4021362 2500w\" />\n\nClick on a pairwise experiment that you would like to inspect, and you will be brought to the Comparison View:\n\n<img src=\"https://mintcdn.com/langchain-5e9cc07a/H9jA2WRyA-MV4-H0/langsmith/images/pairwise-comparison-view.png?fit=max&auto=format&n=H9jA2WRyA-MV4-H0&q=85&s=8afa7467faf707c0bb5ede23b007beda\" alt=\"Pairwise Comparison View\" data-og-width=\"3430\" width=\"3430\" data-og-height=\"1886\" height=\"1886\" data-path=\"langsmith/images/pairwise-comparison-view.png\" data-optimize=\"true\" data-opv=\"3\" srcset=\"https://mintcdn.com/langchain-5e9cc07a/H9jA2WRyA-MV4-H0/langsmith/images/pairwise-comparison-view.png?w=280&fit=max&auto=format&n=H9jA2WRyA-MV4-H0&q=85&s=9a837cee527a1bf5dda5a77b8ce16ba6 280w, https://mintcdn.com/langchain-5e9cc07a/H9jA2WRyA-MV4-H0/langsmith/images/pairwise-comparison-view.png?w=560&fit=max&auto=format&n=H9jA2WRyA-MV4-H0&q=85&s=ebb39f8f2fb7a542d2273cfc64c5b4f4 560w, https://mintcdn.com/langchain-5e9cc07a/H9jA2WRyA-MV4-H0/langsmith/images/pairwise-comparison-view.png?w=840&fit=max&auto=format&n=H9jA2WRyA-MV4-H0&q=85&s=2f2de8c570a3e6401ba0220da343b3e0 840w, https://mintcdn.com/langchain-5e9cc07a/H9jA2WRyA-MV4-H0/langsmith/images/pairwise-comparison-view.png?w=1100&fit=max&auto=format&n=H9jA2WRyA-MV4-H0&q=85&s=cf612b4c6938e856b78c7476f8cc6304 1100w, https://mintcdn.com/langchain-5e9cc07a/H9jA2WRyA-MV4-H0/langsmith/images/pairwise-comparison-view.png?w=1650&fit=max&auto=format&n=H9jA2WRyA-MV4-H0&q=85&s=ff05d71cd12f19d0403e6a1e3e64609a 1650w, https://mintcdn.com/langchain-5e9cc07a/H9jA2WRyA-MV4-H0/langsmith/images/pairwise-comparison-view.png?w=2500&fit=max&auto=format&n=H9jA2WRyA-MV4-H0&q=85&s=5674d6403a3070935830983b9e36ac2f 2500w\" />\n\nYou may filter to runs where the first experiment was better or vice versa by clicking the thumbs up/thumbs down buttons in the table header:\n\n<img src=\"https://mintcdn.com/langchain-5e9cc07a/0B2PFrFBMRWNccee/langsmith/images/filter-pairwise.png?fit=max&auto=format&n=0B2PFrFBMRWNccee&q=85&s=677c48099cee9848d2119c154c7b0d88\" alt=\"Pairwise Filtering\" data-og-width=\"3454\" width=\"3454\" data-og-height=\"1914\" height=\"1914\" data-path=\"langsmith/images/filter-pairwise.png\" data-optimize=\"true\" data-opv=\"3\" srcset=\"https://mintcdn.com/langchain-5e9cc07a/0B2PFrFBMRWNccee/langsmith/images/filter-pairwise.png?w=280&fit=max&auto=format&n=0B2PFrFBMRWNccee&q=85&s=1ceff9156ccfdb48f246f41c7e0d16ab 280w, https://mintcdn.com/langchain-5e9cc07a/0B2PFrFBMRWNccee/langsmith/images/filter-pairwise.png?w=560&fit=max&auto=format&n=0B2PFrFBMRWNccee&q=85&s=745f3dc2bed9e3e2d8333df0ff57a43e 560w, https://mintcdn.com/langchain-5e9cc07a/0B2PFrFBMRWNccee/langsmith/images/filter-pairwise.png?w=840&fit=max&auto=format&n=0B2PFrFBMRWNccee&q=85&s=e81f10f544953ee39366866c1f4a5d71 840w, https://mintcdn.com/langchain-5e9cc07a/0B2PFrFBMRWNccee/langsmith/images/filter-pairwise.png?w=1100&fit=max&auto=format&n=0B2PFrFBMRWNccee&q=85&s=3f4af39e4da50d0ad081d03aaf7b238e 1100w, https://mintcdn.com/langchain-5e9cc07a/0B2PFrFBMRWNccee/langsmith/images/filter-pairwise.png?w=1650&fit=max&auto=format&n=0B2PFrFBMRWNccee&q=85&s=63688564868c7a0989c429c6e740e014 1650w, https://mintcdn.com/langchain-5e9cc07a/0B2PFrFBMRWNccee/langsmith/images/filter-pairwise.png?w=2500&fit=max&auto=format&n=0B2PFrFBMRWNccee&q=85&s=527537f492665790aa8380e0d75e7fb3 2500w\" />\n\n***\n\n<Callout icon=\"pen-to-square\" iconType=\"regular\">\n  [Edit the source of this page on GitHub.](https://github.com/langchain-ai/docs/edit/main/src/langsmith/evaluate-pairwise.mdx)\n</Callout>\n\n<Tip icon=\"terminal\" iconType=\"regular\">\n  [Connect these docs programmatically](/use-these-docs) to Claude, VSCode, and more via MCP for real-time answers.\n</Tip>",
  "content_length": 18479
}