{
  "title": "Context editing",
  "source_url": "https://docs.claude.com/en/docs/build-with-claude/context-editing",
  "content": "Automatically manage conversation context as it grows with context editing.\n\n<Note>\n  Context editing is currently in beta with support for tool result clearing and thinking block clearing. To enable it, use the beta header `context-management-2025-06-27` in your API requests.\n\n  Please reach out through our [feedback form](https://forms.gle/YXC2EKGMhjN1c4L88) to share your feedback on this feature.\n</Note>\n\n## Overview\n\nContext editing allows you to automatically manage conversation context as it grows, helping you optimize costs and stay within context window limits. The API provides different strategies for managing context:\n\n* **Tool result clearing** (`clear_tool_uses_20250919`): Automatically clears tool use/result pairs when conversation context exceeds your configured threshold\n* **Thinking block clearing** (`clear_thinking_20251015`): Manages [thinking blocks](/en/docs/build-with-claude/extended-thinking) by clearing older thinking blocks from previous turns\n\nEach strategy can be configured independently and applied together to optimize your specific use case.\n\n## Context editing strategies\n\n### Tool result clearing\n\nThe `clear_tool_uses_20250919` strategy clears tool results when conversation context grows beyond your configured threshold. When activated, the API automatically clears the oldest tool results in chronological order, replacing them with placeholder text to let Claude know the tool result was removed. By default, only tool results are cleared. You can optionally clear both tool results and tool calls (the tool use parameters) by setting `clear_tool_inputs` to true.\n\n### Thinking block clearing\n\nThe `clear_thinking_20251015` strategy manages `thinking` blocks in conversations when extended thinking is enabled. This strategy automatically clears older thinking blocks from previous turns.\n\n<Tip>\n  **Default behavior**: When extended thinking is enabled without configuring the `clear_thinking_20251015` strategy, the API automatically keeps only the thinking blocks from the last assistant turn (equivalent to `keep: {type: \"thinking_turns\", value: 1}`).\n\n  To maximize cache hits, preserve all thinking blocks by setting `keep: \"all\"`.\n</Tip>\n\n<Note>\n  An assistant conversation turn may include multiple content blocks (e.g. when using tools) and multiple thinking blocks (e.g. with [interleaved thinking](/en/docs/build-with-claude/extended-thinking#interleaved-thinking)).\n</Note>\n\n<Tip>\n  **Context editing happens server-side**\n\n  Context editing is applied **server-side** before the prompt reaches Claude. Your client application maintains the full, unmodified conversation historyâ€”you do not need to sync your client state with the edited version. Continue managing your full conversation history locally as you normally would.\n</Tip>\n\n<Tip>\n  **Context editing and prompt caching**\n\n  Context editing's interaction with [prompt caching](/en/docs/build-with-claude/prompt-caching) varies by strategy:\n\n  * **Tool result clearing**: Invalidates cached prompt prefixes when content is cleared. To account for this, we recommend clearing enough tokens to make the cache invalidation worthwhile. Use the `clear_at_least` parameter to ensure a minimum number of tokens is cleared each time. You'll incur cache write costs each time content is cleared, but subsequent requests can reuse the newly cached prefix.\n\n  * **Thinking block clearing**: When thinking blocks are **kept** in context (not cleared), the prompt cache is preserved, enabling cache hits and reducing input token costs. When thinking blocks are **cleared**, the cache is invalidated at the point where clearing occurs. Configure the `keep` parameter based on whether you want to prioritize cache performance or context window availability.\n</Tip>\n\n## Supported models\n\nContext editing is available on:\n\n* Claude Opus 4.1 (`claude-opus-4-1-20250805`)\n* Claude Opus 4 (`claude-opus-4-20250514`)\n* Claude Sonnet 4.5 (`claude-sonnet-4-5-20250929`)\n* Claude Sonnet 4 (`claude-sonnet-4-20250514`)\n* Claude Haiku 4.5 (`claude-haiku-4-5-20251001`)\n\n## Tool result clearing usage\n\nThe simplest way to enable tool result clearing is to specify only the strategy type, as all other [configuration options](#configuration-options-for-tool-result-clearing) will use their default values:\n\n<CodeGroup>\n  ```bash cURL theme={null}\n  curl https://api.anthropic.com/v1/messages \\\n      --header \"x-api-key: $ANTHROPIC_API_KEY\" \\\n      --header \"anthropic-version: 2023-06-01\" \\\n      --header \"content-type: application/json\" \\\n      --header \"anthropic-beta: context-management-2025-06-27\" \\\n      --data '{\n          \"model\": \"claude-sonnet-4-5\",\n          \"max_tokens\": 4096,\n          \"messages\": [\n              {\n                  \"role\": \"user\",\n                  \"content\": \"Search for recent developments in AI\"\n              }\n          ],\n          \"tools\": [\n              {\n                  \"type\": \"web_search_20250305\",\n                  \"name\": \"web_search\"\n              }\n          ],\n          \"context_management\": {\n              \"edits\": [\n                  {\"type\": \"clear_tool_uses_20250919\"}\n              ]\n          }\n      }'\n  ```\n\n  ```python Python theme={null}\n  response = client.beta.messages.create(\n      model=\"claude-sonnet-4-5\",\n      max_tokens=4096,\n      messages=[\n          {\n              \"role\": \"user\",\n              \"content\": \"Search for recent developments in AI\"\n          }\n      ],\n      tools=[\n          {\n              \"type\": \"web_search_20250305\",\n              \"name\": \"web_search\"\n          }\n      ],\n      betas=[\"context-management-2025-06-27\"],\n      context_management={\n          \"edits\": [\n              {\"type\": \"clear_tool_uses_20250919\"}\n          ]\n      }\n  )\n  ```\n\n  ```typescript TypeScript theme={null}\n  import Anthropic from '@anthropic-ai/sdk';\n\n  const anthropic = new Anthropic({\n    apiKey: process.env.ANTHROPIC_API_KEY,\n  });\n\n  const response = await anthropic.beta.messages.create({\n    model: \"claude-sonnet-4-5\",\n    max_tokens: 4096,\n    messages: [\n      {\n        role: \"user\",\n        content: \"Search for recent developments in AI\"\n      }\n    ],\n    tools: [\n      {\n        type: \"web_search_20250305\",\n        name: \"web_search\"\n      }\n    ],\n    context_management: {\n      edits: [\n        { type: \"clear_tool_uses_20250919\" }\n      ]\n    },\n    betas: [\"context-management-2025-06-27\"]\n  });\n  ```\n</CodeGroup>\n\n### Advanced configuration\n\nYou can customize the tool result clearing behavior with additional parameters:\n\n<CodeGroup>\n  ```bash cURL theme={null}\n  curl https://api.anthropic.com/v1/messages \\\n      --header \"x-api-key: $ANTHROPIC_API_KEY\" \\\n      --header \"anthropic-version: 2023-06-01\" \\\n      --header \"content-type: application/json\" \\\n      --header \"anthropic-beta: context-management-2025-06-27\" \\\n      --data '{\n          \"model\": \"claude-sonnet-4-5\",\n          \"max_tokens\": 4096,\n          \"messages\": [\n              {\n                  \"role\": \"user\",\n                  \"content\": \"Create a simple command line calculator app using Python\"\n              }\n          ],\n          \"tools\": [\n              {\n                  \"type\": \"text_editor_20250728\",\n                  \"name\": \"str_replace_based_edit_tool\",\n                  \"max_characters\": 10000\n              },\n              {\n                  \"type\": \"web_search_20250305\",\n                  \"name\": \"web_search\",\n                  \"max_uses\": 3\n              }\n          ],\n          \"context_management\": {\n              \"edits\": [\n                  {\n                      \"type\": \"clear_tool_uses_20250919\",\n                      \"trigger\": {\n                          \"type\": \"input_tokens\",\n                          \"value\": 30000\n                      },\n                      \"keep\": {\n                          \"type\": \"tool_uses\",\n                          \"value\": 3\n                      },\n                      \"clear_at_least\": {\n                          \"type\": \"input_tokens\",\n                          \"value\": 5000\n                      },\n                      \"exclude_tools\": [\"web_search\"]\n                  }\n              ]\n          }\n      }'\n  ```\n\n  ```python Python theme={null}\n  response = client.beta.messages.create(\n      model=\"claude-sonnet-4-5\",\n      max_tokens=4096,\n      messages=[\n          {\n              \"role\": \"user\",\n              \"content\": \"Create a simple command line calculator app using Python\"\n          }\n      ],\n      tools=[\n          {\n              \"type\": \"text_editor_20250728\",\n              \"name\": \"str_replace_based_edit_tool\",\n              \"max_characters\": 10000\n          },\n          {\n              \"type\": \"web_search_20250305\",\n              \"name\": \"web_search\",\n              \"max_uses\": 3\n          }\n      ],\n      betas=[\"context-management-2025-06-27\"],\n      context_management={\n          \"edits\": [\n              {\n                  \"type\": \"clear_tool_uses_20250919\",\n                  # Trigger clearing when threshold is exceeded\n                  \"trigger\": {\n                      \"type\": \"input_tokens\",\n                      \"value\": 30000\n                  },\n                  # Number of tool uses to keep after clearing\n                  \"keep\": {\n                      \"type\": \"tool_uses\",\n                      \"value\": 3\n                  },\n                  # Optional: Clear at least this many tokens\n                  \"clear_at_least\": {\n                      \"type\": \"input_tokens\",\n                      \"value\": 5000\n                  },\n                  # Exclude these tools from being cleared\n                  \"exclude_tools\": [\"web_search\"]\n              }\n          ]\n      }\n  )\n  ```\n\n  ```typescript TypeScript theme={null}\n  import Anthropic from '@anthropic-ai/sdk';\n\n  const anthropic = new Anthropic({\n    apiKey: process.env.ANTHROPIC_API_KEY,\n  });\n\n  const response = await anthropic.beta.messages.create({\n    model: \"claude-sonnet-4-5\",\n    max_tokens: 4096,\n    messages: [\n      {\n        role: \"user\",\n        content: \"Create a simple command line calculator app using Python\"\n      }\n    ],\n    tools: [\n      {\n        type: \"text_editor_20250728\",\n        name: \"str_replace_based_edit_tool\",\n        max_characters: 10000\n      },\n      {\n        type: \"web_search_20250305\",\n        name: \"web_search\",\n        max_uses: 3\n      }\n    ],\n    betas: [\"context-management-2025-06-27\"],\n    context_management: {\n      edits: [\n        {\n          type: \"clear_tool_uses_20250919\",\n          // Trigger clearing when threshold is exceeded\n          trigger: {\n            type: \"input_tokens\",\n            value: 30000\n          },\n          // Number of tool uses to keep after clearing\n          keep: {\n            type: \"tool_uses\",\n            value: 3\n          },\n          // Optional: Clear at least this many tokens\n          clear_at_least: {\n            type: \"input_tokens\",\n            value: 5000\n          },\n          // Exclude these tools from being cleared\n          exclude_tools: [\"web_search\"]\n        }\n      ]\n    }\n  });\n  ```\n</CodeGroup>\n\n## Thinking block clearing usage\n\nEnable thinking block clearing to manage context and prompt caching effectively when extended thinking is enabled:\n\n<CodeGroup>\n  ```bash cURL theme={null}\n  curl https://api.anthropic.com/v1/messages \\\n      --header \"x-api-key: $ANTHROPIC_API_KEY\" \\\n      --header \"anthropic-version: 2023-06-01\" \\\n      --header \"content-type: application/json\" \\\n      --header \"anthropic-beta: context-management-2025-06-27\" \\\n      --data '{\n          \"model\": \"claude-sonnet-4-5-20250929\",\n          \"max_tokens\": 1024,\n          \"messages\": [...],\n          \"thinking\": {\n              \"type\": \"enabled\",\n              \"budget_tokens\": 10000\n          },\n          \"context_management\": {\n              \"edits\": [\n                  {\n                      \"type\": \"clear_thinking_20251015\",\n                      \"keep\": {\n                          \"type\": \"thinking_turns\",\n                          \"value\": 2\n                      }\n                  }\n              ]\n          }\n      }'\n  ```\n\n  ```python Python theme={null}\n  response = client.beta.messages.create(\n      model=\"claude-sonnet-4-5-20250929\",\n      max_tokens=1024,\n      messages=[...],\n      thinking={\n          \"type\": \"enabled\",\n          \"budget_tokens\": 10000\n      },\n      betas=[\"context-management-2025-06-27\"],\n      context_management={\n          \"edits\": [\n              {\n                  \"type\": \"clear_thinking_20251015\",\n                  \"keep\": {\n                      \"type\": \"thinking_turns\",\n                      \"value\": 2\n                  }\n              }\n          ]\n      }\n  )\n  ```\n\n  ```typescript TypeScript theme={null}\n  import Anthropic from '@anthropic-ai/sdk';\n\n  const anthropic = new Anthropic({\n    apiKey: process.env.ANTHROPIC_API_KEY,\n  });\n\n  const response = await anthropic.beta.messages.create({\n    model: \"claude-sonnet-4-5-20250929\",\n    max_tokens: 1024,\n    messages: [...],\n    thinking: {\n      type: \"enabled\",\n      budget_tokens: 10000\n    },\n    betas: [\"context-management-2025-06-27\"],\n    context_management: {\n      edits: [\n        {\n          type: \"clear_thinking_20251015\",\n          keep: {\n            type: \"thinking_turns\",\n            value: 2\n          }\n        }\n      ]\n    }\n  });\n  ```\n</CodeGroup>\n\n### Configuration options for thinking block clearing\n\nThe `clear_thinking_20251015` strategy supports the following configuration:\n\n| Configuration option | Default                              | Description                                                                                                                                                                                              |\n| -------------------- | ------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |\n| `keep`               | `{type: \"thinking_turns\", value: 1}` | Defines how many recent assistant turns with thinking blocks to preserve. Use `{type: \"thinking_turns\", value: N}` where N must be > 0 to keep the last N turns, or `\"all\"` to keep all thinking blocks. |\n\n**Example configurations:**\n\n```json  theme={null}\n// Keep thinking blocks from the last 3 assistant turns\n{\n  \"type\": \"clear_thinking_20251015\",\n  \"keep\": {\n    \"type\": \"thinking_turns\",\n    \"value\": 3\n  }\n}\n\n// Keep all thinking blocks (maximizes cache hits)\n{\n  \"type\": \"clear_thinking_20251015\",\n  \"keep\": \"all\"\n}\n```\n\n### Combining strategies\n\nYou can use both thinking block clearing and tool result clearing together:\n\n<Note>\n  When using multiple strategies, the `clear_thinking_20251015` strategy must be listed first in the `edits` array.\n</Note>\n\n<CodeGroup>\n  ```python Python theme={null}\n  response = client.beta.messages.create(\n      model=\"claude-sonnet-4-5-20250929\",\n      max_tokens=1024,\n      messages=[...],\n      thinking={\n          \"type\": \"enabled\",\n          \"budget_tokens\": 10000\n      },\n      tools=[...],\n      betas=[\"context-management-2025-06-27\"],\n      context_management={\n          \"edits\": [\n              {\n                  \"type\": \"clear_thinking_20251015\",\n                  \"keep\": {\n                      \"type\": \"thinking_turns\",\n                      \"value\": 2\n                  }\n              },\n              {\n                  \"type\": \"clear_tool_uses_20250919\",\n                  \"trigger\": {\n                      \"type\": \"input_tokens\",\n                      \"value\": 50000\n                  },\n                  \"keep\": {\n                      \"type\": \"tool_uses\",\n                      \"value\": 5\n                  }\n              }\n          ]\n      }\n  )\n  ```\n\n  ```typescript TypeScript theme={null}\n  const response = await anthropic.beta.messages.create({\n    model: \"claude-sonnet-4-5-20250929\",\n    max_tokens: 1024,\n    messages: [...],\n    thinking: {\n      type: \"enabled\",\n      budget_tokens: 10000\n    },\n    tools: [...],\n    betas: [\"context-management-2025-06-27\"],\n    context_management: {\n      edits: [\n        {\n          type: \"clear_thinking_20251015\",\n          keep: {\n            type: \"thinking_turns\",\n            value: 2\n          }\n        },\n        {\n          type: \"clear_tool_uses_20250919\",\n          trigger: {\n            type: \"input_tokens\",\n            value: 50000\n          },\n          keep: {\n            type: \"tool_uses\",\n            value: 5\n          }\n        }\n      ]\n    }\n  });\n  ```\n</CodeGroup>\n\n## Configuration options for tool result clearing\n\n| Configuration option | Default              | Description                                                                                                                                                                                                                                           |\n| -------------------- | -------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |\n| `trigger`            | 100,000 input tokens | Defines when the context editing strategy activates. Once the prompt exceeds this threshold, clearing will begin. You can specify this value in either `input_tokens` or `tool_uses`.                                                                 |\n| `keep`               | 3 tool uses          | Defines how many recent tool use/result pairs to keep after clearing occurs. The API removes the oldest tool interactions first, preserving the most recent ones.                                                                                     |\n| `clear_at_least`     | None                 | Ensures a minimum number of tokens is cleared each time the strategy activates. If the API can't clear at least the specified amount, the strategy will not be applied. This helps determine if context clearing is worth breaking your prompt cache. |\n| `exclude_tools`      | None                 | List of tool names whose tool uses and results should never be cleared. Useful for preserving important context.                                                                                                                                      |\n| `clear_tool_inputs`  | `false`              | Controls whether the tool call parameters are cleared along with the tool results. By default, only the tool results are cleared while keeping Claude's original tool calls visible.                                                                  |\n\n## Context editing response\n\nYou can see which context edits were applied to your request using the `context_management` response field, along with helpful statistics about the content and input tokens cleared.\n\n```json Response theme={null}\n{\n    \"id\": \"msg_013Zva2CMHLNnXjNJJKqJ2EF\",\n    \"type\": \"message\",\n    \"role\": \"assistant\",\n    \"content\": [...],\n    \"usage\": {...},\n    \"context_management\": {\n        \"applied_edits\": [\n            // When using `clear_thinking_20251015`\n            {\n                \"type\": \"clear_thinking_20251015\",\n                \"cleared_thinking_turns\": 3,\n                \"cleared_input_tokens\": 15000\n            },\n            // When using `clear_tool_uses_20250919`\n            {\n                \"type\": \"clear_tool_uses_20250919\",\n                \"cleared_tool_uses\": 8,\n                \"cleared_input_tokens\": 50000\n            }\n        ]\n    }\n}\n```\n\nFor streaming responses, the context edits will be included in the final `message_delta` event:\n\n```json Streaming Response theme={null}\n{\n    \"type\": \"message_delta\",\n    \"delta\": {\n        \"stop_reason\": \"end_turn\",\n        \"stop_sequence\": null\n    },\n    \"usage\": {\n        \"output_tokens\": 1024\n    },\n    \"context_management\": {\n        \"applied_edits\": [...]\n    }\n}\n```\n\n## Token counting\n\nThe [token counting](/en/docs/build-with-claude/token-counting) endpoint supports context management, allowing you to preview how many tokens your prompt will use after context editing is applied.\n\n<CodeGroup>\n  ```bash cURL theme={null}\n  curl https://api.anthropic.com/v1/messages/count_tokens \\\n      --header \"x-api-key: $ANTHROPIC_API_KEY\" \\\n      --header \"anthropic-version: 2023-06-01\" \\\n      --header \"content-type: application/json\" \\\n      --header \"anthropic-beta: context-management-2025-06-27\" \\\n      --data '{\n          \"model\": \"claude-sonnet-4-5\",\n          \"messages\": [\n              {\n                  \"role\": \"user\",\n                  \"content\": \"Continue our conversation...\"\n              }\n          ],\n          \"tools\": [...],\n          \"context_management\": {\n              \"edits\": [\n                  {\n                      \"type\": \"clear_tool_uses_20250919\",\n                      \"trigger\": {\n                          \"type\": \"input_tokens\",\n                          \"value\": 30000\n                      },\n                      \"keep\": {\n                          \"type\": \"tool_uses\",\n                          \"value\": 5\n                      }\n                  }\n              ]\n          }\n      }'\n  ```\n\n  ```python Python theme={null}\n  response = client.beta.messages.count_tokens(\n      model=\"claude-sonnet-4-5\",\n      messages=[\n          {\n              \"role\": \"user\",\n              \"content\": \"Continue our conversation...\"\n          }\n      ],\n      tools=[...],  # Your tool definitions\n      betas=[\"context-management-2025-06-27\"],\n      context_management={\n          \"edits\": [\n              {\n                  \"type\": \"clear_tool_uses_20250919\",\n                  \"trigger\": {\n                      \"type\": \"input_tokens\",\n                      \"value\": 30000\n                  },\n                  \"keep\": {\n                      \"type\": \"tool_uses\",\n                      \"value\": 5\n                  }\n              }\n          ]\n      }\n  )\n\n  print(f\"Original tokens: {response.context_management['original_input_tokens']}\")\n  print(f\"After clearing: {response.input_tokens}\")\n  print(f\"Savings: {response.context_management['original_input_tokens'] - response.input_tokens} tokens\")\n  ```\n\n  ```typescript TypeScript theme={null}\n  import Anthropic from '@anthropic-ai/sdk';\n\n  const anthropic = new Anthropic({\n    apiKey: process.env.ANTHROPIC_API_KEY,\n  });\n\n  const response = await anthropic.beta.messages.countTokens({\n    model: \"claude-sonnet-4-5\",\n    messages: [\n      {\n        role: \"user\",\n        content: \"Continue our conversation...\"\n      }\n    ],\n    tools: [...],  // Your tool definitions\n    betas: [\"context-management-2025-06-27\"],\n    context_management: {\n      edits: [\n        {\n          type: \"clear_tool_uses_20250919\",\n          trigger: {\n            type: \"input_tokens\",\n            value: 30000\n          },\n          keep: {\n            type: \"tool_uses\",\n            value: 5\n          }\n        }\n      ]\n    }\n  });\n\n  console.log(`Original tokens: ${response.context_management?.original_input_tokens}`);\n  console.log(`After clearing: ${response.input_tokens}`);\n  console.log(`Savings: ${(response.context_management?.original_input_tokens || 0) - response.input_tokens} tokens`);\n  ```\n</CodeGroup>\n\n```json Response theme={null}\n{\n    \"input_tokens\": 25000,\n    \"context_management\": {\n        \"original_input_tokens\": 70000\n    }\n}\n```\n\nThe response shows both the final token count after context management is applied (`input_tokens`) and the original token count before any clearing occurred (`original_input_tokens`).\n\n## Using with the Memory Tool\n\nContext editing can be combined with the [memory tool](/en/docs/agents-and-tools/tool-use/memory-tool). When your conversation context approaches the configured clearing threshold, Claude receives an automatic warning to preserve important information. This enables Claude to save tool results or context to its memory files before they're cleared from the conversation history.\n\nThis combination allows you to:\n\n* **Preserve important context**: Claude can write essential information from tool results to memory files before those results are cleared\n* **Maintain long-running workflows**: Enable agentic workflows that would otherwise exceed context limits by offloading information to persistent storage\n* **Access information on demand**: Claude can look up previously cleared information from memory files when needed, rather than keeping everything in the active context window\n\nFor example, in a file editing workflow where Claude performs many operations, Claude can summarize completed changes to memory files as the context grows. When tool results are cleared, Claude retains access to that information through its memory system and can continue working effectively.\n\nTo use both features together, enable them in your API request:\n\n<CodeGroup>\n  ```python Python theme={null}\n  response = client.beta.messages.create(\n      model=\"claude-sonnet-4-5\",\n      max_tokens=4096,\n      messages=[...],\n      tools=[\n          {\n              \"type\": \"memory_20250818\",\n              \"name\": \"memory\"\n          },\n          # Your other tools\n      ],\n      betas=[\"context-management-2025-06-27\"],\n      context_management={\n          \"edits\": [\n              {\"type\": \"clear_tool_uses_20250919\"}\n          ]\n      }\n  )\n  ```\n\n  ```typescript TypeScript theme={null}\n  import Anthropic from '@anthropic-ai/sdk';\n\n  const anthropic = new Anthropic({\n    apiKey: process.env.ANTHROPIC_API_KEY,\n  });\n\n  const response = await anthropic.beta.messages.create({\n    model: \"claude-sonnet-4-5\",\n    max_tokens: 4096,\n    messages: [...],\n    tools: [\n      {\n        type: \"memory_20250818\",\n        name: \"memory\"\n      },\n      // Your other tools\n    ],\n    betas: [\"context-management-2025-06-27\"],\n    context_management: {\n      edits: [\n        { type: \"clear_tool_uses_20250919\" }\n      ]\n    }\n  });\n  ```\n</CodeGroup>",
  "content_length": 26040
}