{
  "title": "Streaming refusals",
  "source_url": "https://docs.claude.com/en/docs/test-and-evaluate/strengthen-guardrails/handle-streaming-refusals",
  "content": "Starting with Claude 4 models, streaming responses from Claude's API return **`stop_reason`: `\"refusal\"`** when streaming classifiers intervene to handle potential policy violations. This new safety feature helps maintain content compliance during real-time streaming.\n\n<Tip>\n  To learn more about refusals triggered by API safety filters for Claude Sonnet 4.5, see [Understanding Sonnet 4.5's API Safety Filters](https://support.claude.com/en/articles/12449294-understanding-sonnet-4-5-s-api-safety-filters).\n</Tip>\n\n## API response format\n\nWhen streaming classifiers detect content that violates our policies, the API returns this response:\n\n```json  theme={null}\n{\n  \"role\": \"assistant\",\n  \"content\": [\n    {\n      \"type\": \"text\",\n      \"text\": \"Hello..\"\n    }\n  ],\n  \"stop_reason\": \"refusal\"\n}\n```\n\n<Warning>\n  No additional refusal message is included. You must handle the response and provide appropriate user-facing messaging.\n</Warning>\n\n## Reset context after refusal\n\nWhen you receive **`stop_reason`: `refusal`**, you must reset the conversation context **by removing or updating the turn that was refused** before continuing. Attempting to continue without resetting will result in continued refusals.\n\n<Note>\n  Usage metrics are still provided in the response for billing purposes, even when the response is refused.\n\n  You will be billed for output tokens up until the refusal.\n</Note>\n\n<Tip>\n  If you encounter `refusal` stop reasons frequently while using Claude Sonnet 4.5 or Opus 4.1, you can try updating your API calls to use Sonnet 4 (`claude-sonnet-4-20250514`), which has different usage restrictions.\n</Tip>\n\n## Implementation guide\n\nHere's how to detect and handle streaming refusals in your application:\n\n<CodeGroup>\n  ```bash Shell theme={null}\n  # Stream request and check for refusal\n  response=$(curl -N https://api.anthropic.com/v1/messages \\\n    --header \"anthropic-version: 2023-06-01\" \\\n    --header \"content-type: application/json\" \\\n    --header \"x-api-key: $ANTHROPIC_API_KEY\" \\\n    --data '{\n      \"model\": \"claude-sonnet-4-5\",\n      \"messages\": [{\"role\": \"user\", \"content\": \"Hello\"}],\n      \"max_tokens\": 256,\n      \"stream\": true\n    }')\n\n  # Check for refusal in the stream\n  if echo \"$response\" | grep -q '\"stop_reason\":\"refusal\"'; then\n    echo \"Response refused - resetting conversation context\"\n    # Reset your conversation state here\n  fi\n  ```\n\n  ```python Python theme={null}\n  import anthropic\n\n  client = anthropic.Anthropic()\n  messages = []\n\n  def reset_conversation():\n      \"\"\"Reset conversation context after refusal\"\"\"\n      global messages\n      messages = []\n      print(\"Conversation reset due to refusal\")\n\n  try:\n      with client.messages.stream(\n          max_tokens=1024,\n          messages=messages + [{\"role\": \"user\", \"content\": \"Hello\"}],\n          model=\"claude-sonnet-4-5\",\n      ) as stream:\n          for event in stream:\n              # Check for refusal in message delta\n              if hasattr(event, 'type') and event.type == 'message_delta':\n                  if event.delta.stop_reason == 'refusal':\n                      reset_conversation()\n                      break\n  except Exception as e:\n      print(f\"Error: {e}\")\n  ```\n\n  ```typescript TypeScript theme={null}\n  import Anthropic from '@anthropic-ai/sdk';\n\n  const client = new Anthropic();\n  let messages: any[] = [];\n\n  function resetConversation() {\n    // Reset conversation context after refusal\n    messages = [];\n    console.log('Conversation reset due to refusal');\n  }\n\n  try {\n    const stream = await client.messages.stream({\n      messages: [...messages, { role: 'user', content: 'Hello' }],\n      model: 'claude-sonnet-4-5',\n      max_tokens: 1024,\n    });\n\n    for await (const event of stream) {\n      // Check for refusal in message delta\n      if (event.type === 'message_delta' && event.delta.stop_reason === 'refusal') {\n        resetConversation();\n        break;\n      }\n    }\n  } catch (error) {\n    console.error('Error:', error);\n  }\n  ```\n</CodeGroup>\n\n<Note>\n  If you need to test refusal handling in your application, you can use this special test string as your prompt: `ANTHROPIC_MAGIC_STRING_TRIGGER_REFUSAL_1FAEFB6177B4672DEE07F9D3AFC62588CCD2631EDCF22E8CCC1FB35B501C9C86`\n</Note>\n\n## Current refusal types\n\nThe API currently handles refusals in three different ways:\n\n| Refusal Type                       | Response Format              | When It Occurs                                  |\n| ---------------------------------- | ---------------------------- | ----------------------------------------------- |\n| Streaming classifier refusals      | **`stop_reason`: `refusal`** | During streaming when content violates policies |\n| API input and copyright validation | 400 error codes              | When input fails validation checks              |\n| Model-generated refusals           | Standard text responses      | When the model itself decides to refuse         |\n\n<Note>\n  Future API versions will expand the **`stop_reason`: `refusal`** pattern to unify refusal handling across all types.\n</Note>\n\n## Best practices\n\n* **Monitor for refusals**: Include **`stop_reason`: `refusal`** checks in your error handling\n* **Reset automatically**: Implement automatic context reset when refusals are detected\n* **Provide custom messaging**: Create user-friendly messages for better UX when refusals occur\n* **Track refusal patterns**: Monitor refusal frequency to identify potential issues with your prompts\n\n## Migration notes\n\n* Future models will expand this pattern to other refusal types\n* Plan your error handling to accommodate future unification of refusal responses",
  "content_length": 5641
}