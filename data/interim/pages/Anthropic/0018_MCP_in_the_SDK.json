{
  "title": "MCP in the SDK",
  "source_url": "https://docs.claude.com/en/docs/agent-sdk/mcp",
  "content": "Extend Claude Code with custom tools using Model Context Protocol servers\n\n## Overview\n\nModel Context Protocol (MCP) servers extend Claude Code with custom tools and capabilities. MCPs can run as external processes, connect via HTTP/SSE, or execute directly within your SDK application.\n\n## Configuration\n\n### Basic Configuration\n\nConfigure MCP servers in `.mcp.json` at your project root:\n\n<CodeGroup>\n  ```json TypeScript theme={null}\n  {\n    \"mcpServers\": {\n      \"filesystem\": {\n        \"command\": \"npx\",\n        \"args\": [\"@modelcontextprotocol/server-filesystem\"],\n        \"env\": {\n          \"ALLOWED_PATHS\": \"/Users/me/projects\"\n        }\n      }\n    }\n  }\n  ```\n\n  ```json Python theme={null}\n  {\n    \"mcpServers\": {\n      \"filesystem\": {\n        \"command\": \"python\",\n        \"args\": [\"-m\", \"mcp_server_filesystem\"],\n        \"env\": {\n          \"ALLOWED_PATHS\": \"/Users/me/projects\"\n        }\n      }\n    }\n  }\n  ```\n</CodeGroup>\n\n### Using MCP Servers in SDK\n\n<CodeGroup>\n  ```typescript TypeScript theme={null}\n  import { query } from \"@anthropic-ai/claude-agent-sdk\";\n\n  for await (const message of query({\n    prompt: \"List files in my project\",\n    options: {\n      mcpServers: {\n        \"filesystem\": {\n          command: \"npx\",\n          args: [\"@modelcontextprotocol/server-filesystem\"],\n          env: {\n            ALLOWED_PATHS: \"/Users/me/projects\"\n          }\n        }\n      },\n      allowedTools: [\"mcp__filesystem__list_files\"]\n    }\n  })) {\n    if (message.type === \"result\" && message.subtype === \"success\") {\n      console.log(message.result);\n    }\n  }\n  ```\n\n  ```python Python theme={null}\n  from claude_agent_sdk import query\n\n  async for message in query(\n      prompt=\"List files in my project\",\n      options={\n          \"mcpServers\": {\n              \"filesystem\": {\n                  \"command\": \"python\",\n                  \"args\": [\"-m\", \"mcp_server_filesystem\"],\n                  \"env\": {\n                      \"ALLOWED_PATHS\": \"/Users/me/projects\"\n                  }\n              }\n          },\n          \"allowedTools\": [\"mcp__filesystem__list_files\"]\n      }\n  ):\n      if message[\"type\"] == \"result\" and message[\"subtype\"] == \"success\":\n          print(message[\"result\"])\n  ```\n</CodeGroup>\n\n## Transport Types\n\n### stdio Servers\n\nExternal processes communicating via stdin/stdout:\n\n<CodeGroup>\n  ```typescript TypeScript theme={null}\n  // .mcp.json configuration\n  {\n    \"mcpServers\": {\n      \"my-tool\": {\n        \"command\": \"node\",\n        \"args\": [\"./my-mcp-server.js\"],\n        \"env\": {\n          \"DEBUG\": \"${DEBUG:-false}\"\n        }\n      }\n    }\n  }\n  ```\n\n  ```python Python theme={null}\n  # .mcp.json configuration\n  {\n    \"mcpServers\": {\n      \"my-tool\": {\n        \"command\": \"python\",\n        \"args\": [\"./my_mcp_server.py\"],\n        \"env\": {\n          \"DEBUG\": \"${DEBUG:-false}\"\n        }\n      }\n    }\n  }\n  ```\n</CodeGroup>\n\n### HTTP/SSE Servers\n\nRemote servers with network communication:\n\n<CodeGroup>\n  ```typescript TypeScript theme={null}\n  // SSE server configuration\n  {\n    \"mcpServers\": {\n      \"remote-api\": {\n        \"type\": \"sse\",\n        \"url\": \"https://api.example.com/mcp/sse\",\n        \"headers\": {\n          \"Authorization\": \"Bearer ${API_TOKEN}\"\n        }\n      }\n    }\n  }\n\n  // HTTP server configuration\n  {\n    \"mcpServers\": {\n      \"http-service\": {\n        \"type\": \"http\",\n        \"url\": \"https://api.example.com/mcp\",\n        \"headers\": {\n          \"X-API-Key\": \"${API_KEY}\"\n        }\n      }\n    }\n  }\n  ```\n\n  ```python Python theme={null}\n  # SSE server configuration\n  {\n    \"mcpServers\": {\n      \"remote-api\": {\n        \"type\": \"sse\",\n        \"url\": \"https://api.example.com/mcp/sse\",\n        \"headers\": {\n          \"Authorization\": \"Bearer ${API_TOKEN}\"\n        }\n      }\n    }\n  }\n\n  # HTTP server configuration\n  {\n    \"mcpServers\": {\n      \"http-service\": {\n        \"type\": \"http\",\n        \"url\": \"https://api.example.com/mcp\",\n        \"headers\": {\n          \"X-API-Key\": \"${API_KEY}\"\n        }\n      }\n    }\n  }\n  ```\n</CodeGroup>\n\n### SDK MCP Servers\n\nIn-process servers running within your application. For detailed information on creating custom tools, see the [Custom Tools guide](/en/docs/agent-sdk/custom-tools):\n\n## Resource Management\n\nMCP servers can expose resources that Claude can list and read:\n\n<CodeGroup>\n  ```typescript TypeScript theme={null}\n  import { query } from \"@anthropic-ai/claude-agent-sdk\";\n\n  // List available resources\n  for await (const message of query({\n    prompt: \"What resources are available from the database server?\",\n    options: {\n      mcpServers: {\n        \"database\": {\n          command: \"npx\",\n          args: [\"@modelcontextprotocol/server-database\"]\n        }\n      },\n      allowedTools: [\"mcp__list_resources\", \"mcp__read_resource\"]\n    }\n  })) {\n    if (message.type === \"result\") console.log(message.result);\n  }\n  ```\n\n  ```python Python theme={null}\n  from claude_agent_sdk import query\n\n  # List available resources\n  async for message in query(\n      prompt=\"What resources are available from the database server?\",\n      options={\n          \"mcpServers\": {\n              \"database\": {\n                  \"command\": \"python\",\n                  \"args\": [\"-m\", \"mcp_server_database\"]\n              }\n          },\n          \"allowedTools\": [\"mcp__list_resources\", \"mcp__read_resource\"]\n      }\n  ):\n      if message[\"type\"] == \"result\":\n          print(message[\"result\"])\n  ```\n</CodeGroup>\n\n## Authentication\n\n### Environment Variables\n\n<CodeGroup>\n  ```typescript TypeScript theme={null}\n  // .mcp.json with environment variables\n  {\n    \"mcpServers\": {\n      \"secure-api\": {\n        \"type\": \"sse\",\n        \"url\": \"https://api.example.com/mcp\",\n        \"headers\": {\n          \"Authorization\": \"Bearer ${API_TOKEN}\",\n          \"X-API-Key\": \"${API_KEY:-default-key}\"\n        }\n      }\n    }\n  }\n\n  // Set environment variables\n  process.env.API_TOKEN = \"your-token\";\n  process.env.API_KEY = \"your-key\";\n  ```\n\n  ```python Python theme={null}\n  # .mcp.json with environment variables\n  {\n    \"mcpServers\": {\n      \"secure-api\": {\n        \"type\": \"sse\",\n        \"url\": \"https://api.example.com/mcp\",\n        \"headers\": {\n          \"Authorization\": \"Bearer ${API_TOKEN}\",\n          \"X-API-Key\": \"${API_KEY:-default-key}\"\n        }\n      }\n    }\n  }\n\n  # Set environment variables\n  import os\n  os.environ[\"API_TOKEN\"] = \"your-token\"\n  os.environ[\"API_KEY\"] = \"your-key\"\n  ```\n</CodeGroup>\n\n### OAuth2 Authentication\n\nOAuth2 MCP authentication in-client is not currently supported.\n\n## Error Handling\n\nHandle MCP connection failures gracefully:\n\n<CodeGroup>\n  ```typescript TypeScript theme={null}\n  import { query } from \"@anthropic-ai/claude-agent-sdk\";\n\n  for await (const message of query({\n    prompt: \"Process data\",\n    options: {\n      mcpServers: {\n        \"data-processor\": dataServer\n      }\n    }\n  })) {\n    if (message.type === \"system\" && message.subtype === \"init\") {\n      // Check MCP server status\n      const failedServers = message.mcp_servers.filter(\n        s => s.status !== \"connected\"\n      );\n      \n      if (failedServers.length > 0) {\n        console.warn(\"Failed to connect:\", failedServers);\n      }\n    }\n    \n    if (message.type === \"result\" && message.subtype === \"error_during_execution\") {\n      console.error(\"Execution failed\");\n    }\n  }\n  ```\n\n  ```python Python theme={null}\n  from claude_agent_sdk import query\n\n  async for message in query(\n      prompt=\"Process data\",\n      options={\n          \"mcpServers\": {\n              \"data-processor\": data_server\n          }\n      }\n  ):\n      if message[\"type\"] == \"system\" and message[\"subtype\"] == \"init\":\n          # Check MCP server status\n          failed_servers = [\n              s for s in message[\"mcp_servers\"]\n              if s[\"status\"] != \"connected\"\n          ]\n          \n          if failed_servers:\n              print(f\"Failed to connect: {failed_servers}\")\n      \n      if message[\"type\"] == \"result\" and message[\"subtype\"] == \"error_during_execution\":\n          print(\"Execution failed\")\n  ```\n</CodeGroup>\n\n## Related Resources\n\n* [Custom Tools Guide](/en/docs/agent-sdk/custom-tools) - Detailed guide on creating SDK MCP servers\n* [TypeScript SDK Reference](/en/docs/agent-sdk/typescript)\n* [Python SDK Reference](/en/docs/agent-sdk/python)\n* [SDK Permissions](/en/docs/agent-sdk/permissions)\n* [Common Workflows](https://code.claude.com/docs/en/common-workflows)",
  "content_length": 8409
}