{
  "title": "How to version deployments",
  "source_url": "https://docs-3.prefect.io/v3/how-to-guides/deployments/versioning",
  "content": "Track changes to your deployments and roll back to previous versions\n\nIn Prefect Cloud, deployments have a version history.\nThe **live** deployment version is the runnable version of a deployment.\nA previous deployment version can be made live by **rolling back** to it.\nWhen a previous deployment version is live, a newer deployment version can be made live by **promoting** it.\n\n<Warning>\n  When a new version of a deployment is created, it is automatically set as the live version.\n</Warning>\n\n## What's included in a deployment version\n\nDeployment versions are a history of changes to a deployment's configuration.\n\nWhile the majority of deployment properties are included in a deployment's version, some properties cannot be versioned.\nPersisting these properties across all versions helps prevent unexpected execution behavior when rolling back or promoting versions.\n\n<AccordionGroup>\n  <Accordion title=\"Versioned deployment properties\" icon=\"check\" iconType=\"solid\">\n    These properties are pinned to each deployment version.\n\n    | Deployment Property        | Versioned                              |\n    | -------------------------- | -------------------------------------- |\n    | `description`              | <Icon icon=\"check\" iconType=\"solid\" /> |\n    | `tags`                     | <Icon icon=\"check\" iconType=\"solid\" /> |\n    | `labels`                   | <Icon icon=\"check\" iconType=\"solid\" /> |\n    | `entrypoint`               | <Icon icon=\"check\" iconType=\"solid\" /> |\n    | `pull_steps`               | <Icon icon=\"check\" iconType=\"solid\" /> |\n    | `parameters`               | <Icon icon=\"check\" iconType=\"solid\" /> |\n    | `parameter_openapi_schema` | <Icon icon=\"check\" iconType=\"solid\" /> |\n    | `enforce_parameter_schema` | <Icon icon=\"check\" iconType=\"solid\" /> |\n    | `work_queue_id`            | <Icon icon=\"check\" iconType=\"solid\" /> |\n    | `work_pool_name`           | <Icon icon=\"check\" iconType=\"solid\" /> |\n    | `job_variables`            | <Icon icon=\"check\" iconType=\"solid\" /> |\n    | `created_by`               | <Icon icon=\"check\" iconType=\"solid\" /> |\n    | `updated_by`               | <Icon icon=\"check\" iconType=\"solid\" /> |\n    | `version_info`             | <Icon icon=\"check\" iconType=\"solid\" /> |\n  </Accordion>\n\n  <Accordion title=\"Unversioned deployment properties\" icon=\"xmark\" description=\"\">\n    These properties persist across version rollbacks and promotions.\n\n    | Deployment Property   | Versioned                                                          |\n    | --------------------- | ------------------------------------------------------------------ |\n    | `name`                | <Icon icon=\"xmark\" iconType=\"solid\" color=\"#FF0000\" /> (immutable) |\n    | `schedules`           | <Icon icon=\"xmark\" iconType=\"solid\" color=\"#FF0000\" />             |\n    | `is_schedule_active`  | <Icon icon=\"xmark\" iconType=\"solid\" color=\"#FF0000\" />             |\n    | `paused`              | <Icon icon=\"xmark\" iconType=\"solid\" color=\"#FF0000\" />             |\n    | `disabled`            | <Icon icon=\"xmark\" iconType=\"solid\" color=\"#FF0000\" />             |\n    | `concurrency_limit`   | <Icon icon=\"xmark\" iconType=\"solid\" color=\"#FF0000\" />             |\n    | `concurrency_options` | <Icon icon=\"xmark\" iconType=\"solid\" color=\"#FF0000\" />             |\n  </Accordion>\n</AccordionGroup>\n\n## How to create and manage versions\n\nA new deployment version is created every time a deployment is updated, whether from the CLI, from Python, or from the UI.\n\nIf you're deploying from a supported source code management platform or from inside a Git repository, Prefect automatically collects the **repository name**, **repository URL**, the currently checked out **branch**, the **commit SHA**, and the **first line of your commit message** from your environment.\nThis information is used to help create a record of which code versions produced which deployment versions, and does not affect deployment execution.\n\n### Supported source code management platforms\n\nPrefect searches for environment variables in each supported platform's CI environment in order to collect information about the current state of the repository from which deployment versions are created.\nIt may be useful to access these environment variables in other stages of your deployment process for constructing version identifiers.\n\n<Note>\n  Prefect's automatic version information collection currently supports GitHub Actions, GitLab CI, Bitbucket Pipelines, and Azure Pipelines.\n  If deploying from a Git repository not on one of these platforms, Prefect will use `git` CLI commands as a best effort to discover these values.\n</Note>\n\n<Tabs>\n  <Tab title=\"GitHub Actions\">\n    | Environment Variable | Value                              |\n    | -------------------- | ---------------------------------- |\n    | `GITHUB_SHA`         | Commit SHA                         |\n    | `GITHUB_REF_NAME`    | Branch name                        |\n    | `GITHUB_REPOSITORY`  | Repository name                    |\n    | `GITHUB_SERVER_URL`  | Github account or organization URL |\n  </Tab>\n\n  <Tab title=\"GitLab CI\">\n    | Environment Variable | Value           |\n    | -------------------- | --------------- |\n    | `CI_COMMIT_SHA`      | Commit SHA      |\n    | `CI_COMMIT_REF_NAME` | Branch name     |\n    | `CI_PROJECT_NAME`    | Repository name |\n    | `CI_PROJECT_URL`     | Repository URL  |\n  </Tab>\n\n  <Tab title=\"Bitbucket Pipelines\">\n    | Environment Variable        | Value                                 |\n    | --------------------------- | ------------------------------------- |\n    | `BITBUCKET_COMMIT`          | Commit SHA                            |\n    | `BITBUCKET_BRANCH`          | Branch name                           |\n    | `BITBUCKET_REPO_SLUG`       | Repository name                       |\n    | `BITBUCKET_GIT_HTTP_ORIGIN` | Bitbucket account or organization URL |\n  </Tab>\n\n  <Tab title=\"Azure Pipelines\">\n    | Environment Variable     | Value           |\n    | ------------------------ | --------------- |\n    | `BUILD_SOURCEVERSION`    | Commit SHA      |\n    | `BUILD_SOURCEBRANCHNAME` | Branch name     |\n    | `BUILD_REPOSITORY_NAME`  | Repository name |\n    | `BUILD_REPOSITORY_URI`   | Repository URL  |\n  </Tab>\n</Tabs>\n\n### Using the `version` deployment property\n\nSupplying a `version` to your deployment is not required, but using human-readable version names helps give meaning to each change you make.\nIt's also valuable for quickly finding or communicating the version you want to roll back to or promote.\n\nFor additional details on how Prefect handles the value of `version`, see [deployment metadata for bookkeeping](/v3/deploy#metadata-for-bookkeeping).\n\n### Executing specific code versions\n\nIt's possible to synchronize code changes to deployment versions so each deployment version executes the exact commit that was checked out when it was created.\nSince `pull_steps` and `job_variables` define what repository or image to pull when a flow runs, updating their contents with each code change keeps deployment versions in step with your codebase.\nWhich of these configurations to use depends on whether you are pulling code from Git or storing code in Docker images.\n\nThe examples in this section use GitHub as their source control management and CI platform, so be sure to replace URLs, environment variables, and CI workflows with the ones relevant to your platform.\nYou can check out complete example repositories on GitHub for executing specific code versions when [pulling from Git](https://github.com/kevingrismore/version-testing) and [pulling Docker images](https://github.com/kevingrismore/version-testing-docker/tree/main).\n\n#### Pulling from Git\n\nThe `git_clone` deployment pull step and `GitRepository` deployment storage class offer a `commit_sha` field.\nWhen deploying from a Git repository, provide the commit SHA from your environment to your deployment.\nBoth approaches below will result in a deployment pull step that clones your repository and checks out a specific commit.\n\n<CodeGroup>\n  ```yaml With prefect.yaml theme={null}\n  pull:\n  - prefect.deployments.steps.git_clone:\n      repository: https://github.com/my-org/my-repo.git\n      commit_sha: \"{{ $GITHUB_SHA }}\"\n\n  deployments:\n  - name: my-deployment\n    version: 0.0.1\n    entrypoint: example.py:my_flow\n    work_pool:\n      name: my-work-pool\n  ```\n\n  ```python With .deploy() theme={null}\n  import os\n\n  from prefect import flow\n  from prefect.runner.storage import GitRepository\n\n  @flow(log_prints=True)\n  def my_flow():\n      print(\"Hello world!\")\n\n  if __name__ == \"__main__\":\n      my_flow.from_source(\n          source=GitRepository(\n              repo_url=\"https://github.com/my-org/my-repo.git\",\n              commit_sha=os.getenv(\"GITHUB_SHA\"),\n          )\n      ).deploy(\n          name=\"my-deployment\",\n          version=\"0.0.1\",\n          work_pool_name=\"my-work-pool\",\n      )\n  ```\n</CodeGroup>\n\n#### Pulling Docker images\n\nWhen baking code into Docker images, use the image digest to pin exact code versions to deployment versions.\nAn image digest uniquely and immutably identifies a container image.\n\nFirst, build your image in your CI job and pass the image digest as an environment variable to the Prefect deploy step.\n\n```yaml Github Actions theme={null}\n      ...\n\n      - name: Set up Docker Buildx\n        uses: docker/setup-buildx-action@v3\n\n      - name: Log in to Docker Hub\n        uses: docker/login-action@v3\n        with:\n          username: ${{ vars.DOCKERHUB_USERNAME }}\n          password: ${{ secrets.DOCKERHUB_TOKEN }}\n\n      - name: Build and push\n        id: build-docker-image\n        uses: docker/build-push-action@v6\n        with:\n          platforms: linux/amd64,linux/arm64\n          push: true\n          tags: my-registry/my-example-image:my-tag\n          cache-from: type=gha\n          cache-to: type=gha,mode=max\n\n      - name: Deploy a Prefect flow\n        env:\n          IMAGE_DIGEST: ${{ steps.build-docker-image.outputs.digest }}\n          PREFECT_API_KEY: ${{ secrets.PREFECT_API_KEY }}\n          PREFECT_API_URL: ${{ secrets.PREFECT_API_URL }}\n        ... # your deployment action here\n```\n\nThen, refer to that digest in the image name you provide to this deployment version's job variables.\n\n<CodeGroup>\n  ```yaml With prefect.yaml theme={null}\n  deployments:\n  - name: my-deployment\n    version: 0.0.1\n    entrypoint: example.py:my_flow\n    work_pool:\n      name: my-work-pool\n      job_variables:\n        image: \"my-registry/my-image@{{ $IMAGE_DIGEST }}\"\n  ```\n\n  ```python With .deploy() theme={null}\n  import os\n\n  from prefect import flow\n\n  @flow(log_prints=True)\n  def my_flow():\n      print(\"Hello world!\")\n\n  if __name__ == \"__main__\":\n      my_flow.deploy(\n          name=\"my-deployment\",\n          version=\"0.0.1\",\n          work_pool_name=\"my-work-pool\",\n          image=f\"my-registry/my-image@{os.getenv('IMAGE_DIGEST')}\",\n          build=False,\n      )\n  ```\n</CodeGroup>",
  "content_length": 10990
}