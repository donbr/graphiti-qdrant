{
  "title": "How to detect and respond to zombie flows",
  "source_url": "https://docs-3.prefect.io/v3/advanced/detect-zombie-flows",
  "content": "Learn how to detect and respond to zombie flows.\n\nSudden infrastructure failures (like machine crashes or container evictions) can cause flow runs to become unresponsive and appear stuck in a `Running` state.\n\nTo mitigate this, flow runs triggered by deployments can emit heartbeats to drive Automations that detect and respond to these \"zombie\" flow runs, ensuring they are marked as `Crashed` if they stop reporting heartbeats.\n\n### Enable flow run heartbeat events\n\nYou will need to ensure you're running Prefect version 3.1.8 or greater and set `PREFECT_RUNNER_HEARTBEAT_FREQUENCY`\nto an integer greater than 30 to emit flow run heartbeat events.\n\n### Create the automation\n\nTo create an automation that marks zombie flow runs as crashed, run this script:\n\n```python  theme={null}\nfrom datetime import timedelta\n\nfrom prefect.automations import Automation\nfrom prefect.client.schemas.objects import StateType\nfrom prefect.events.actions import ChangeFlowRunState\nfrom prefect.events.schemas.automations import EventTrigger, Posture\nfrom prefect.events.schemas.events import ResourceSpecification\n\n\nmy_automation = Automation(\n    name=\"Crash zombie flows\",\n    trigger=EventTrigger(\n        after={\"prefect.flow-run.heartbeat\"},\n        expect={\n            \"prefect.flow-run.heartbeat\",\n            \"prefect.flow-run.Completed\",\n            \"prefect.flow-run.Failed\",\n            \"prefect.flow-run.Cancelled\",\n            \"prefect.flow-run.Crashed\",\n        },\n        match=ResourceSpecification({\"prefect.resource.id\": [\"prefect.flow-run.*\"]}),\n        for_each={\"prefect.resource.id\"},\n        posture=Posture.Proactive,\n        threshold=1,\n        within=timedelta(seconds=90),\n    ),\n    actions=[\n        ChangeFlowRunState(\n            state=StateType.CRASHED,\n            message=\"Flow run marked as crashed due to missing heartbeats.\",\n        )\n    ],\n)\n\nif __name__ == \"__main__\":\n    my_automation.create()\n```\n\nThe trigger definition says that `after` each heartbeat event for a flow run we `expect` to see another heartbeat event or a\nterminal state event for that same flow run `within` 90 seconds of a heartbeat event.\n\n### Adjusting behavior with settings\n\nIf `PREFECT_RUNNER_HEARTBEAT_FREQUENCY` is set to `30`, the automation will trigger only after 3 heartbeats have been missed.\nYou can adjust `within` in the trigger definition and `PREFECT_RUNNER_HEARTBEAT_FREQUENCY` to change how quickly the automation\nwill fire after the server stops receiving flow run heartbeats.\n\nYou can also add additional actions to your automation to send a notification when zombie runs are detected.",
  "content_length": 2607
}