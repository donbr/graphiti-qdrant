{
  "title": "prefect-ray",
  "source_url": "https://docs-3.prefect.io/integrations/prefect-ray/index",
  "content": "Accelerate your workflows by running tasks in parallel with Ray\n\n[Ray](https://docs.ray.io/en/latest/index.html) can run your tasks in parallel by distributing them over multiple machines.\nThe `prefect-ray` integration makes it easy to accelerate your flow runs with Ray.\n\n## Install `prefect-ray`\n\nThe following command will install a version of `prefect-ray` compatible with your installed version of `prefect`.\nIf you don't already have `prefect` installed, it will install the newest version of `prefect` as well.\n\n```bash  theme={null}\npip install \"prefect[ray]\"\n```\n\nUpgrade to the latest versions of `prefect` and `prefect-ray`:\n\n```bash  theme={null}\npip install -U \"prefect[ray]\"\n```\n\n<Warning>\n  **Ray limitations**\n\n  There are a few limitations with Ray:\n\n  * Ray has [experimental](https://docs.ray.io/en/latest/ray-overview/installation.html#install-nightlies) support for Python 3.13, but Prefect [does *not* currently support](https://github.com/PrefectHQ/prefect/issues/16910) Python 3.13.\n  * Ray support for non-x86/64 architectures such as ARM/M1 processors with installation from `pip` alone and will be skipped during installation of Prefect. It is possible to manually install the blocking component with `conda`. See the [Ray documentation](https://docs.ray.io/en/latest/ray-overview/installation.html#m1-mac-apple-silicon-support) for instructions.\n  * Ray support for Windows is currently in beta.\n\n  See the [Ray installation documentation](https://docs.ray.io/en/latest/ray-overview/installation.html) for further compatibility information.\n</Warning>\n\n## Run tasks on Ray\n\nThe `RayTaskRunner` is a [Prefect task runner](https://docs.prefect.io/develop/task-runners/) that submits tasks to [Ray](https://www.ray.io/) for parallel execution.\nBy default, a temporary Ray instance is created for the duration of the flow run.\nFor example, this flow counts to three in parallel:\n\n```python  theme={null}\nimport time\n\nfrom prefect import flow, task\nfrom prefect_ray import RayTaskRunner\n\n@task\ndef shout(number):\n    time.sleep(0.5)\n    print(f\"#{number}\")\n\n@flow(task_runner=RayTaskRunner)\ndef count_to(highest_number):\n    shout.map(range(highest_number)).wait()\n\nif __name__ == \"__main__\":\n    count_to(10)\n\n# outputs\n#3\n#7\n#2\n#6\n#4\n#0\n#1\n#5\n#8\n#9\n```\n\nIf you already have a Ray instance running, you can provide the connection URL via an `address` argument.\n\nTo configure your flow to use the `RayTaskRunner`:\n\n1. Make sure the `prefect-ray` collection is installed as described earlier: `pip install prefect-ray`.\n2. In your flow code, import `RayTaskRunner` from `prefect_ray.task_runners`.\n3. Assign it as the task runner when the flow is defined using the `task_runner=RayTaskRunner` argument.\n\nFor example, this flow uses the `RayTaskRunner` with a local, temporary Ray instance created by Prefect at flow run time.\n\n```python  theme={null}\nfrom prefect import flow\nfrom prefect_ray.task_runners import RayTaskRunner\n\n@flow(task_runner=RayTaskRunner())\ndef my_flow():\n    ...\n```\n\nThis flow uses the `RayTaskRunner` configured to access an existing Ray instance at `ray://<head_node_host>:10001`.\n\n```python  theme={null}\nfrom prefect import flow\nfrom prefect_ray.task_runners import RayTaskRunner\n\n@flow(\n    task_runner=RayTaskRunner(\n        address=\"ray://<head_node_host>:10001\",\n        init_kwargs={\"runtime_env\": {\"pip\": [\"prefect-ray\"]}},\n    )\n)\ndef my_flow():\n    ...\n```\n\n`RayTaskRunner` accepts the following optional parameters:\n\n| Parameter    | Description                                                                                                                         |\n| ------------ | ----------------------------------------------------------------------------------------------------------------------------------- |\n| address      | Address of a currently running Ray instance, starting with the [ray://](https://docs.ray.io/en/master/cluster/ray-client.html) URI. |\n| init\\_kwargs | Additional kwargs to use when calling `ray.init`.                                                                                   |\n\nThe Ray client uses the [ray://](https://docs.ray.io/en/master/cluster/ray-client.html) URI to indicate the address of a Ray instance.\nIf you don't provide the `address` of a Ray instance, Prefect creates a temporary instance automatically.\n\n## Run tasks on a remote Ray cluster\n\nWhen using the `RayTaskRunner` with a remote Ray cluster, you may run into issues that are not seen when using a local Ray instance.\nTo resolve these issues, we recommend taking the following steps when working with a remote Ray cluster:\n\n1. By default, Prefect will not persist any data to the filesystem of the remote ray worker. However, if you want to take advantage of Prefect's caching ability, you will need to configure a remote result storage to persist results across task runs.\n\nWe recommend using the [Prefect UI to configure a storage block](https://docs.prefect.io/develop/blocks/) to use for remote results storage.\n\nHere's an example of a flow that uses caching and remote result storage:\n\n```python  theme={null}\nfrom typing import List\n\nfrom prefect import flow, task\nfrom prefect.logging import get_run_logger\nfrom prefect.tasks import task_input_hash\nfrom prefect_aws import S3Bucket\nfrom prefect_ray.task_runners import RayTaskRunner\n\n\n# The result of this task will be cached in the configured result storage\n@task(cache_key_fn=task_input_hash)\ndef say_hello(name: str) -> None:\n    logger = get_run_logger()\n    # This log statement will print only on the first run. Subsequent runs will be cached.\n    logger.info(f\"hello {name}!\")\n    return name\n\n\n@flow(\n    task_runner=RayTaskRunner(\n        address=\"ray://<instance_public_ip_address>:10001\",\n    ),\n    # Using an S3 block that has already been created via the Prefect UI\n    result_storage=\"s3/my-result-storage\",\n)\ndef greetings(names: List[str]) -> None:\n    say_hello.map(names).wait()\n\n\nif __name__ == \"__main__\":\n    greetings([\"arthur\", \"trillian\", \"ford\", \"marvin\"])\n```\n\n2. If you get an error stating that the module 'prefect' cannot be found, ensure `prefect` is installed on the remote cluster, with:\n\n```bash  theme={null}\npip install prefect\n```\n\n3. If you get an error with a message similar to \"File system created with scheme 's3' could not be created\", ensure the required Python modules are installed on **both local and remote machines**. For example, if using S3 for storage:\n\n```bash  theme={null}\npip install s3fs\n```\n\n4. If you are seeing timeout or other connection errors, double check the address provided to the `RayTaskRunner`. The address should look similar to: `address='ray://<head_node_ip_address>:10001'`:\n\n```bash  theme={null}\nRayTaskRunner(address=\"ray://1.23.199.255:10001\")\n```\n\n## Specify remote options\n\nThe `remote_options` context can be used to control the task's remote options. For example, we can set the number of CPUs and GPUs to use for the `process` task:\n\n```python  theme={null}\nfrom prefect import flow, task\nfrom prefect_ray.task_runners import RayTaskRunner\nfrom prefect_ray.context import remote_options\n\n\n@task\ndef process(x):\n    return x + 1\n\n\n@flow(task_runner=RayTaskRunner())\ndef my_flow():\n    # equivalent to setting @ray.remote(num_cpus=4, num_gpus=2)\n    with remote_options(num_cpus=4, num_gpus=2):\n        process.submit(42).wait()\n```\n\n## Resources\n\nRefer to the `prefect-ray` [SDK documentation](https://reference.prefect.io/prefect_ray/) to explore all the capabilities of the `prefect-ray` library.\n\nFor further assistance using Ray, consult the [Ray documentation](https://docs.ray.io/en/latest/index.html).",
  "content_length": 7623
}