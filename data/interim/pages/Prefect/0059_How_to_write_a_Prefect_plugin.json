{
  "title": "How to write a Prefect plugin",
  "source_url": "https://docs-3.prefect.io/v3/advanced/experimental-plugins",
  "content": "<Warning>\n  **Experimental Feature**\n\n  The plugin system is an **experimental feature** under active development. The API is subject to change without notice, and features may be modified or removed in future releases.\n</Warning>\n\nThe Prefect plugin system allows third-party packages to run hooks when Prefect is imported. This enables plugins to configure environment variables, authenticate with external services, or perform other initialization tasks automatically - whether you're running CLI commands, Python scripts, workers, or agents.\n\n## Use Cases\n\nThe plugin system is designed for scenarios where you need to:\n\n* **Obtain short-lived credentials**: Automatically fetch temporary AWS credentials, service tokens, or API keys before workflow execution\n* **Configure environment variables**: Set up environment-specific configuration based on the execution context\n* **Initialize external services**: Connect to secret managers, credential stores, or authentication providers\n* **Prepare execution environments**: Ensure required resources or configurations are available before workflows run\n\n## Quick Start\n\n### Enabling the Plugin System\n\nThe plugin system is opt-in and disabled by default. Enable it by setting the environment variable:\n\n```bash  theme={null}\nexport PREFECT_EXPERIMENTS_PLUGINS_ENABLED=1\n```\n\nOnce enabled, plugins will automatically run whenever Prefect is imported - this includes:\n\n* Python scripts that import Prefect (`import prefect`)\n* CLI commands (`prefect deploy`, `prefect server start`, etc.)\n* Workers and agents starting up\n* Any process that uses Prefect\n\nThis ensures your environment is properly configured before any Prefect code executes.\n\n### Example Plugin\n\nHere's a minimal example plugin that sets environment variables:\n\n```python  theme={null}\n# my_plugin/__init__.py\nfrom prefect._experimental.plugins import register_hook, HookContext, SetupResult\n\nPREFECT_PLUGIN_API_REQUIRES = \">=0.1,<1\"\n\n\n@register_hook\ndef setup_environment(*, ctx: HookContext) -> SetupResult:\n    \"\"\"Configure environment before Prefect starts.\"\"\"\n    logger = ctx.logger_factory(\"my-plugin\")\n\n    # Perform authentication or configuration\n    credentials = fetch_credentials()\n    logger.info(\"Configured credentials\")\n\n    return SetupResult(\n        env={\n            \"MY_SERVICE_TOKEN\": credentials.token,\n            \"MY_SERVICE_URL\": \"https://api.example.com\",\n        },\n        note=\"Configured my-service credentials\",\n        required=True  # Abort if this plugin fails in strict mode\n    )\n\n\ndef fetch_credentials():\n    # Your authentication logic here\n    pass\n```\n\nRegister the plugin in your `pyproject.toml`:\n\n```toml  theme={null}\n[project]\nname = \"my-plugin\"\nversion = \"0.1.0\"\ndependencies = [\"prefect>=3.4\"]\n\n[project.entry-points.\"prefect.plugins\"]\nmy_plugin = \"my_plugin\"\n```\n\n**Install the plugin:**\n\n```bash  theme={null}\npip install -e .\n```\n\n## Configuration\n\n### Environment Variables\n\nConfigure the plugin system with these environment variables:\n\n| Variable                                            | Description                                  | Default            |\n| --------------------------------------------------- | -------------------------------------------- | ------------------ |\n| `PREFECT_EXPERIMENTS_PLUGINS_ENABLED`               | Enable/disable the plugin system             | `0` (disabled)     |\n| `PREFECT_EXPERIMENTS_PLUGINS_ALLOW`                 | Comma-separated list of allowed plugin names | None (all allowed) |\n| `PREFECT_EXPERIMENTS_PLUGINS_DENY`                  | Comma-separated list of denied plugin names  | None (none denied) |\n| `PREFECT_EXPERIMENTS_PLUGINS_SETUP_TIMEOUT_SECONDS` | Maximum time for all plugins to complete     | `20`               |\n| `PREFECT_EXPERIMENTS_PLUGINS_STRICT`                | Exit if a required plugin fails              | `0` (disabled)     |\n| `PREFECT_EXPERIMENTS_PLUGINS_SAFE_MODE`             | Load plugins without executing hooks         | `0` (disabled)     |\n\n### Examples\n\n**Allow only specific plugins:**\n\n```bash  theme={null}\nexport PREFECT_EXPERIMENTS_PLUGINS_ALLOW=\"aws-plugin,gcp-plugin\"\n```\n\n**Deny problematic plugins:**\n\n```bash  theme={null}\nexport PREFECT_EXPERIMENTS_PLUGINS_DENY=\"legacy-plugin\"\n```\n\n**Enable strict mode for production:**\n\n```bash  theme={null}\nexport PREFECT_EXPERIMENTS_PLUGINS_STRICT=1\n```\n\n**Debug plugins without execution:**\n\n```bash  theme={null}\nexport PREFECT_EXPERIMENTS_PLUGINS_SAFE_MODE=1\n```\n\n## Plugin API\n\n### Hook Specification\n\nPlugins implement the `setup_environment` hook to configure the environment or run code on startup. The simplest approach is to use a decorated function:\n\n```python  theme={null}\nfrom prefect._experimental.plugins import register_hook, HookContext, SetupResult\n\nPREFECT_PLUGIN_API_REQUIRES = \">=0.1,<1\"\n\n\n@register_hook\ndef setup_environment(*, ctx: HookContext) -> SetupResult | None:\n    \"\"\"\n    Prepare process environment for Prefect.\n\n    Args:\n        ctx: Context with Prefect version, API URL, and logger factory\n\n    Returns:\n        SetupResult with environment variables, or None for no changes\n    \"\"\"\n    logger = ctx.logger_factory(\"my-plugin\")\n    logger.info(f\"Running with Prefect {ctx.prefect_version}\")\n\n    # Return None if no setup needed\n    if not should_configure():\n        return None\n\n    # Return SetupResult with configuration\n    return SetupResult(\n        env={\"KEY\": \"value\"},\n        note=\"Short description\",\n        required=False  # Optional\n    )\n```\n\n<Note>\n  **Required Decorator**: The `@register_hook` decorator is **required** to mark your function as a plugin hook implementation. Without it, your plugin will not be discovered by the plugin system.\n\n  **Entry Point**: When using the function-based pattern, your entry point should reference the module (e.g., `\"my_plugin\"`) rather than a specific class or instance.\n</Note>\n\n**Alternative: Class-Based Plugins**\n\nFor plugins that need to maintain state, you can also use a class-based approach:\n\n```python  theme={null}\nfrom prefect._experimental.plugins import register_hook, HookContext, SetupResult\n\nclass MyPlugin:\n    def __init__(self):\n        self.state = {}\n\n    @register_hook\n    def setup_environment(self, *, ctx: HookContext) -> SetupResult | None:\n        # Access instance state\n        return SetupResult(env={\"KEY\": \"value\"})\n\n# Create instance at module level\nPlugin = MyPlugin()\n```\n\nEntry point: `\"my_plugin:Plugin\"`\n\n### HookContext\n\nThe context object passed to plugins:\n\n```python  theme={null}\nfrom dataclasses import dataclass\nfrom typing import Callable\nimport logging\n\n@dataclass\nclass HookContext:\n    prefect_version: str  # e.g., \"3.0.0\"\n    api_url: str | None   # Configured Prefect API URL\n    logger_factory: Callable[[str], logging.Logger]  # Create loggers\n```\n\n### SetupResult\n\nThe result returned by plugins:\n\n```python  theme={null}\nfrom dataclasses import dataclass\nfrom typing import Mapping\nfrom datetime import datetime\n\n@dataclass\nclass SetupResult:\n    env: Mapping[str, str]           # Environment variables to set\n    note: str | None = None           # Human-readable description\n    required: bool = False            # Abort in strict mode if fails\n```\n\n## Example: AWS Credentials Plugin\n\nHere's a complete example of a plugin that assumes an AWS IAM role and provides temporary credentials:\n\n```python  theme={null}\n# prefect_aws_setup/__init__.py\nfrom __future__ import annotations\n\nimport os\nfrom datetime import timezone\n\nimport botocore.session\nfrom prefect._experimental.plugins import register_hook, HookContext, SetupResult\n\nPREFECT_PLUGIN_API_REQUIRES = \">=0.1,<1\"\n\n\n@register_hook\ndef setup_environment(*, ctx: HookContext) -> SetupResult | None:\n    \"\"\"Assume AWS IAM role and provide temporary credentials.\"\"\"\n    logger = ctx.logger_factory(\"prefect-aws-setup\")\n\n    role_arn = os.getenv(\"PREFECT_AWS_SETUP_ROLE_ARN\")\n    if not role_arn:\n        logger.debug(\"PREFECT_AWS_SETUP_ROLE_ARN not set, skipping\")\n        return None\n\n    profile = os.getenv(\"PREFECT_AWS_SETUP_PROFILE\")\n    region = os.getenv(\"AWS_REGION\", \"us-east-1\")\n    duration = int(os.getenv(\"PREFECT_AWS_SETUP_DURATION\", \"3600\"))\n\n    try:\n        # Create AWS session and assume role\n        session = botocore.session.Session(profile=profile)\n        sts = session.create_client(\"sts\", region_name=region)\n\n        response = sts.assume_role(\n            RoleArn=role_arn,\n            RoleSessionName=\"prefect-plugin\",\n            DurationSeconds=duration\n        )\n\n        credentials = response[\"Credentials\"]\n\n        return SetupResult(\n            env={\n                \"AWS_ACCESS_KEY_ID\": credentials[\"AccessKeyId\"],\n                \"AWS_SECRET_ACCESS_KEY\": credentials[\"SecretAccessKey\"],\n                \"AWS_SESSION_TOKEN\": credentials[\"SessionToken\"],\n                \"AWS_REGION\": region,\n            },\n            note=f\"Assumed role {role_arn.split('/')[-1]}\",\n            required=bool(os.getenv(\"PREFECT_AWS_SETUP_REQUIRED\")),\n        )\n    except Exception:\n        logger.exception(\"Failed to assume AWS role\")\n        if os.getenv(\"PREFECT_AWS_SETUP_REQUIRED\"):\n            raise\n        return None\n```\n\n**Package configuration:**\n\n```toml  theme={null}\n# pyproject.toml\n[project]\nname = \"prefect-aws-setup\"\nversion = \"0.1.0\"\ndependencies = [\"prefect>=3.4\", \"botocore>=1.34\"]\n\n[project.entry-points.\"prefect.plugins\"]\naws_setup = \"prefect_aws_setup\"\n```\n\n**Installation:**\n\n```bash  theme={null}\npip install -e .\n```\n\n**Usage:**\n\n```bash  theme={null}\n# Configure the plugin\nexport PREFECT_AWS_SETUP_ROLE_ARN=\"arn:aws:iam::123456789012:role/PrefectRole\"\nexport PREFECT_AWS_SETUP_PROFILE=\"my-aws-profile\"\nexport AWS_REGION=\"us-west-2\"\nexport PREFECT_AWS_SETUP_REQUIRED=1\n\n# Enable plugins\nexport PREFECT_EXPERIMENTS_PLUGINS_ENABLED=1\n\n# Run Prefect commands - credentials are automatically configured\nprefect deploy --all\n```\n\n## Diagnostics\n\nUse the diagnostic command to troubleshoot plugin issues:\n\n```bash  theme={null}\nprefect experimental plugins diagnose\n```\n\n**Example output:**\n\n```\nPrefect Experimental Plugin System Diagnostics\n\nEnabled: True\nTimeout: 20.0s\nStrict mode: False\nSafe mode: False\nAllow list: None\nDeny list: None\n\nDiscoverable Plugins (entry point group: prefect.plugins)\n\n  • aws-setup: active\n    Module: prefect_aws_setup:Plugin\n    API requirement: >=0.1,<1\n\nRunning Startup Hooks\n\n  • aws-setup: success\n    Environment variables: 4\n      AWS_ACCESS_KEY_ID=••••••\n      AWS_SECRET_ACCESS_KEY=••••••\n      AWS_SESSION_TOKEN=••••••\n      AWS_REGION=us-west-2\n    Note: Assumed role PrefectRole\n    Expires: 2024-01-15 18:30:00+00:00\n```\n\n## Security Considerations\n\n<Warning>\n  **Security Best Practices**\n\n  * Only install plugins from trusted sources\n  * Review plugin source code before installation\n  * Use `PREFECT_EXPERIMENTS_PLUGINS_DENY` to quarantine known-bad plugins\n  * Sensitive values are automatically redacted in logs and diagnostics\n  * Plugins run with the same permissions as Prefect\n</Warning>\n\n### Secret Redaction\n\nThe plugin system automatically redacts sensitive environment variables in logs and diagnostics. Variables containing these keywords are redacted:\n\n* `SECRET`\n* `TOKEN`\n* `PASSWORD`\n* `KEY`\n\nExample:\n\n```python  theme={null}\n# This environment variable will be redacted\n{\"AWS_SECRET_ACCESS_KEY\": \"••••••\"}\n\n# This will not\n{\"AWS_REGION\": \"us-east-1\"}\n```\n\n### Permissions\n\nPlugins execute with the same permissions as the Prefect process. Be cautious about:\n\n* Environment variables can affect all child processes\n* File system access matches the Prefect process user\n* Network calls are unrestricted\n* Plugins can import any installed package\n\n## Behavior & Guarantees\n\n### Import-Time Execution\n\nPlugins run **automatically when Prefect is imported**, before any other Prefect code executes. This means:\n\n* Environment variables are available to all Prefect operations\n* Credentials are configured before connecting to APIs\n* Setup happens once per process, not per CLI command\n\nIf plugin initialization fails (and strict mode is disabled), Prefect will log the error and continue loading.\n\n### Execution Order\n\n* Plugins are discovered via entry points in the `prefect.plugins` group\n* Execution order is not guaranteed\n* Multiple plugins may modify the same environment variables (last write wins)\n\n### Error Handling\n\n* Plugin errors are isolated and logged\n* One plugin's failure doesn't affect others\n* In strict mode with `required=True`, plugin failures abort startup\n* Timeouts apply globally to all plugins combined\n\n### Async Support\n\nPlugins can be either synchronous or asynchronous:\n\n```python  theme={null}\nfrom prefect._experimental.plugins import register_hook, HookContext, SetupResult\n\n# Synchronous plugin\n@register_hook\ndef setup_environment(*, ctx: HookContext) -> SetupResult:\n    # Synchronous implementation\n    return SetupResult(env={\"KEY\": \"value\"})\n\n# Asynchronous plugin\n@register_hook\nasync def setup_environment(*, ctx: HookContext) -> SetupResult:\n    # Asynchronous implementation\n    data = await fetch_data()\n    return SetupResult(env={\"KEY\": data})\n```\n\n### Idempotence\n\nPlugins should be idempotent - multiple invocations should produce the same result. Prefect may call plugins multiple times during initialization or in different processes.\n\n## Version Compatibility\n\n### Specifying Version Requirements\n\nPlugins should declare their API version compatibility using the `PREFECT_PLUGIN_API_REQUIRES` attribute:\n\n```python  theme={null}\nfrom prefect._experimental.plugins import register_hook, HookContext\n\n# At module level in your plugin\nPREFECT_PLUGIN_API_REQUIRES = \">=0.1,<1\"  # Supports API version 0.1.x\n\nclass Plugin:\n    @register_hook\n    def setup_environment(self, *, ctx: HookContext):\n        # Your plugin implementation\n        pass\n```\n\nThe version specifier follows [PEP 440](https://peps.python.org/pep-0440/) syntax:\n\n* `\">=0.1,<1\"` - Compatible with 0.1.x releases, incompatible with 1.0+\n* `\">=0.1\"` - Compatible with 0.1 and all future versions\n* `\"==0.1\"` - Only compatible with exactly version 0.1\n\nThe current plugin API version is `0.1`. This will be incremented when breaking changes are made to the plugin interface.\n\n### Version Validation\n\nWhen Prefect loads plugins, it automatically validates version compatibility:\n\n1. **Compatible versions**: Plugin loads normally and executes\n2. **Incompatible versions**: Plugin is skipped with a warning log message\n3. **Invalid specifiers**: Warning is logged, but plugin loads anyway (best-effort)\n4. **Missing attribute**: Defaults to `\">=0.1,<1\"` if not specified\n\n**Example logs:**\n\n```\n# Incompatible version\nWARNING: Skipping plugin my-plugin: requires API version >=1.0, current version is 0.1\n\n# Invalid specifier\nDEBUG: Plugin my-plugin has invalid version specifier 'not-valid', ignoring version check\n```\n\n### Checking Compatibility\n\nUse the diagnostics command to see plugin version requirements:\n\n```bash  theme={null}\nprefect experimental plugins diagnose\n```\n\nOutput shows API requirements for each plugin:\n\n```\n  • my-plugin: active\n    Module: my_plugin:Plugin\n    API requirement: >=0.1,<1\n```\n\n## Troubleshooting\n\n### Plugin Not Running\n\n1. Verify plugins are enabled:\n   ```bash  theme={null}\n   echo $PREFECT_EXPERIMENTS_PLUGINS_ENABLED\n   ```\n\n2. Check plugin is discoverable:\n   ```bash  theme={null}\n   prefect experimental plugins diagnose\n   ```\n\n3. Verify entry point is registered:\n   ```bash  theme={null}\n   pip show your-plugin-package\n   ```\n\n### Plugin Errors\n\n1. Enable safe mode to test loading without execution:\n   ```bash  theme={null}\n   PREFECT_EXPERIMENTS_PLUGINS_SAFE_MODE=1 prefect experimental plugins diagnose\n   ```\n\n2. Check plugin logs:\n   ```bash  theme={null}\n   PREFECT_LOGGING_LEVEL=DEBUG prefect --version\n   ```\n\n3. Test plugin in isolation:\n   ```bash  theme={null}\n   PREFECT_EXPERIMENTS_PLUGINS_ALLOW=\"your-plugin\" prefect experimental plugins diagnose\n   ```\n\n### Version Compatibility Issues\n\nIf a plugin isn't loading due to version mismatch:\n\n1. Check the plugin's API requirement:\n   ```bash  theme={null}\n   prefect experimental plugins diagnose\n   ```\n   Look for warnings about incompatible API versions\n\n2. Update the plugin to a version compatible with your Prefect installation, or update Prefect to match the plugin's requirements\n\n3. If you're developing a plugin, adjust `PREFECT_PLUGIN_API_REQUIRES` to match the current API version:\n   ```python  theme={null}\n   PREFECT_PLUGIN_API_REQUIRES = \">=0.1,<1\"  # Current API version is 0.1\n   ```\n\n4. Enable debug logging to see detailed version validation:\n   ```bash  theme={null}\n   PREFECT_LOGGING_LEVEL=DEBUG prefect --version\n   ```\n\n### Timeout Issues\n\nIncrease the timeout for slow operations:\n\n```bash  theme={null}\nexport PREFECT_EXPERIMENTS_PLUGINS_SETUP_TIMEOUT_SECONDS=60\n```\n\nOr optimize plugin startup time by deferring expensive operations.",
  "content_length": 16923
}