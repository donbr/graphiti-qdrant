{
  "title": "How to upgrade from agents to workers",
  "source_url": "https://docs-3.prefect.io/v3/how-to-guides/migrate/upgrade-agents-to-workers",
  "content": "Learn how to upgrade from agents to workers to significantly enhance the experience of deploying flows.\n\nUpgrading from agents to workers significantly enhances the experience of deploying flows\nby simplifying the specification of each flow's infrastructure and runtime environment.\n\n<Note>\n  This guide is for users who are upgrading from agents (a deployment pattern specific to `prefect>2.0,<3.0`) to workers.\n  If you are new to Prefect, we recommend starting with the\n  [Prefect Quickstart](/v3/get-started/quickstart/).\n</Note>\n\n## About workers and agents\n\nA [worker](/v3/concepts/workers) is the fusion of an\nagent with an infrastructure block.\nLike agents, workers poll a work pool for flow runs that are scheduled to start.\nLike infrastructure blocks, workers are typed. They work with only one kind of infrastructure,\nand they specify the default configuration for jobs submitted to that infrastructure.\n\nAccordingly, workers are not a drop-in replacement for agents. **Using workers requires\ndeploying flows differently.** In particular, deploying a flow with a worker does not involve\nspecifying an infrastructure block. Instead, infrastructure configuration is specified on the\n[work pool](/v3/concepts/work-pools) and passed to each worker that polls work\nfrom that pool.\n\n## Upgrade enhancements\n\n### Workers\n\n* Improved visibility into the status of each worker, including when a worker was started\n  and when it last polled.\n* Better handling of race conditions for high availability use cases.\n\n### Work pools\n\n* Work pools allow greater customization and governance of infrastructure parameters for deployments\n  through their [base job template](/v3/how-to-guides/deployment_infra/manage-work-pools#base-job-template).\n* Prefect Cloud [push work pools](/v3/how-to-guides/deployment_infra/serverless) enable flow\n  execution in your cloud provider environment without the need to host a worker.\n* Prefect Cloud [managed work pools](/v3/how-to-guides/deployment_infra/managed) allow you to run flows on\n  Prefect's infrastructure, without the need to host a worker or configure cloud provider infrastructure.\n\n### Improved deployment interfaces\n\n* The Python deployment experience with [`.deploy()`](/v3/how-to-guides/deployments/deploy-via-python) or the alternative deployment experience with\n  `prefect.yaml` are more flexible and easier to use than block and agent-based deployments.\n* Both options allow you to [deploy multiple flows](/v3/deploy/infrastructure-concepts/prefect-yaml/#work-with-multiple-deployments-with-prefect-yaml)\n  with a single command.\n* Both options allow you to build Docker images for your flows to create portable execution environments.\n* The YAML-based API supports [templating](/v3/deploy/infrastructure-concepts/prefect-yaml/#templating-options)\n  to enable [dryer deployment definitions](/v3/how-to-guides/deployments/prefect-yaml#reuse-configuration-across-deployments).\n\n## Upgrade changes\n\n1. **Deployment CLI and Python SDK:**\n\n   `prefect deployment build <entrypoint>`/`prefect deployment apply` --> [`prefect deploy`](/v3/deploy/infrastructure-concepts/prefect-yaml/#deployment-declaration-reference)\n\n   Prefect now automatically detects flows in your repo and provides a [wizard](/v3/#step-5-deploy-the-flow)\n   to guide you through setting required attributes for your deployments.\n\n   `Deployment.build_from_flow` --> [`flow.deploy`](https://reference.prefect.io/prefect/flows/#prefect.flows.Flow.deploy)\n\n2. **Configuring remote flow code storage:**\n\n   storage blocks --> [pull action](/v3/deploy/infrastructure-concepts/prefect-yaml/#the-pull-action)\n\n   When using the YAML-based deployment API, you can configure a pull action in your `prefect.yaml`\n   file to specify how to retrieve flow code for your deployments. You can use configuration from your\n   existing storage blocks to define your pull action [through templating](/v3/deploy/infrastructure-concepts/prefect-yaml/#templating-options).\n\n   When using the Python deployment API, you can pass any storage block to the `flow.deploy` method to\n   specify how to retrieve flow code for your deployment.\n\n3. **Configuring flow run infrastructure:**\n\n   infrastructure blocks --> [typed work pool](/v3/deploy/infrastructure-concepts/workers/#worker-types)\n\n   Default infrastructure config is now set on the typed work pool, and can be overwritten by\n   individual deployments.\n\n4. **Managing multiple deployments:**\n\n   Create and/or update many deployments at once through a\n   [`prefect.yaml`](/v3/deploy/infrastructure-concepts/prefect-yaml/#work-with-multiple-deployments-with-prefect-yaml)\n   file or use the [`deploy`](/v3/how-to-guides/deployments/deploy-via-python)\n   function.\n\n## What's similar\n\n* You can set storage blocks as the pull action in a `prefect.yaml` file.\n\n* Infrastructure blocks have configuration fields similar to typed work pools.\n\n* Deployment-level infrastructure overrides operate in much the same way.\n\n  `infra_override` -> [`job_variable`](/v3/deploy/infrastructure-concepts/prefect-yaml/#work-pool-fields)\n\n* The process for starting an agent and [starting a worker](/v3/deploy/infrastructure-concepts/workers/#start-a-worker)\n  in your environment are virtually identical.\n\n  `prefect agent start --pool <work pool name>` --> `prefect worker start --pool <work pool name>`\n\n<Tip>\n  **Worker Helm chart**\n\n  If you host your agents in a Kubernetes cluster, you can use the [Prefect worker Helm chart](https://github.com/PrefectHQ/prefect-helm/tree/main/charts/prefect-worker)\n  to host workers in your cluster.\n</Tip>\n\n## Upgrade steps\n\nIf you have existing deployments that use infrastructure blocks, you can quickly upgrade them to\nbe compatible with workers by following these steps:\n\n1. **[Create a work pool](/v3/deploy/infrastructure-concepts/work-pools/#work-pool-configuration)**\n\nThis new work pool replaces your infrastructure block.\n\nYou can use the [`.publish_as_work_pool`](https://docs.prefect.io/2.19.2/api-ref/prefect/infrastructure/#prefect.infrastructure.Infrastructure.publish_as_work_pool)\nmethod on any infrastructure block to create a work pool with the same configuration.\n\nFor example, if you have a `KubernetesJob` infrastructure block named 'my-k8s-job', you can\ncreate a work pool with the same configuration with this script:\n\n```python  theme={null}\nfrom prefect.infrastructure import KubernetesJob\n\n\nKubernetesJob.load(\"my-k8s-job\").publish_as_work_pool()\n```\n\nRunning this script creates a work pool named 'my-k8s-job' with the same configuration as your infrastructure block.\n\n<Tip>\n  **Serving flows**\n  If you are using a `Process` infrastructure block and a `LocalFilesystem` storage block\n  (or aren't using an infrastructure and storage block at all), you can use [`flow.serve`](/v3/deploy/index)\n  to create a deployment without specifying a work pool name or start a worker.\n\n  This is a quick way to create a deployment for a flow and manage your\n  deployments if you don't need the dynamic infrastructure creation or configuration offered\n  by workers.\n</Tip>\n\n2. **[Start a worker](/v3/deploy/infrastructure-concepts/workers/#start-a-worker)**\n\nThis worker replaces your agent and polls your new work pool for flow runs to execute.\n\n```bash  theme={null}\nprefect worker start -p <work pool name>\n```\n\n3. **Deploy your flows to the new work pool**\n\nTo deploy your flows to the new work pool, use `flow.deploy` for a Pythonic deployment\nexperience or `prefect deploy` for a YAML-based deployment experience.\n\nIf you currently use `Deployment.build_from_flow`, we recommend using `flow.deploy`.\n\nIf you currently use `prefect deployment build` and `prefect deployment apply`, we recommend\nusing `prefect deploy`.\n\n### Use `flow.deploy`\n\nIf you have a Python script that uses `Deployment.build_from_flow` to create a deployment, you\ncan replace it with `flow.deploy`.\n\nYou can translate most arguments to `Deployment.build_from_flow` directly to `flow.deploy`,\nbut here are some possible changes you may need:\n\n* Replace `infrastructure` with `work_pool_name`.\n  * If you've used the `.publish_as_work_pool` method on your infrastructure block, use the\n    name of the created work pool.\n* Replace `infra_overrides` with `job_variables`.\n* Replace `storage` with a call to [`flow.from_source`](/v3/deploy/index).\n  * `flow.from_source` loads your flow from a remote storage location and makes it deployable.\n    You can pass your existing storage block to the `source` argument of `flow.from_source`.\n\nBelow are some examples of how to translate `Deployment.build_from_flow` into `flow.deploy`.\n\n#### Deploying from a local file\n\nUsing agents and `Deployment.build_from_flow` to deploy a flow from a local file looked like:\n\n```python  theme={null}\nfrom prefect import flow\n\n\n@flow(log_prints=True)\ndef my_flow(name: str = \"world\"):\n    print(f\"Hello {name}! I'm a flow from a Python script!\")\n\n\nif __name__ == \"__main__\":\n    Deployment.build_from_flow(\n        my_flow,\n        name=\"my-deployment\",\n        parameters=dict(name=\"Marvin\"),\n    )\n```\n\nWhen using workers, you can accomplish the same local-storage deployment with `flow.deploy`:\n\n```python example.py theme={null}\nfrom pathlib import Path\nfrom prefect import flow\n\n\n@flow(log_prints=True)\ndef my_flow(name: str = \"world\"):\n    print(f\"Hello {name}! I'm a flow from a Python script!\")\n\n\nif __name__ == \"__main__\":\n    my_flow.from_source(\n        source=str(Path(__file__).parent),\n        entrypoint=\"example.py:my_flow\",\n    ).deploy(\n        name=\"my-deployment\",\n        parameters=dict(name=\"Marvin\"),\n        work_pool_name=\"local\",\n    )\n```\n\nYou can then start a worker to execute scheduled runs, pulling the flow code from `example.py`:\n\n```bash  theme={null}\n# starts a worker and creates `local` Process work pool if it doesn't exist\nprefect worker start --pool local\n```\n\n<Note>\n  If you'd like to immediately serve this flow as a deployment without running a worker or using work pools, you can [use `flow.serve`](/v3/how-to-guides/deployment_infra/run-flows-in-local-processes).\n</Note>\n\n#### Deploying using a storage block\n\nIf you currently use a storage block to load your flow code but no infrastructure block:\n\n```python  theme={null}\nfrom prefect import flow\nfrom prefect.filesystems import GitHub\n\n\n@flow(log_prints=True)\ndef my_flow(name: str = \"world\"):\n    print(f\"Hello {name}! I'm a flow from a GitHub repo!\")\n\n\nif __name__ == \"__main__\":\n    Deployment.build_from_flow(\n        my_flow,\n        name=\"my-deployment\",\n        storage=GitHub.load(\"demo-repo\"),\n        parameters=dict(name=\"Marvin\"),\n    )\n```\n\nYou can use `flow.from_source` to load your flow from the same location and `flow.deploy` to\ncreate a deployment:\n\n```python example.py theme={null}\nfrom prefect import flow\nfrom prefect.blocks.system import Secret\nfrom prefect.runner.storage import GitRepository\n\n@flow(log_prints=True)\ndef my_flow(name: str = \"world\"):\n    print(f\"Hello {name}! I'm a flow from a GitHub repo!\")\n\nif __name__ == \"__main__\":\n    flow.from_source(\n        source=GitRepository(\n            url=\"https://github.com/me/myrepo.git\",\n            credentials={\"username\": \"oauth2\", \"access_token\": Secret.load(\"my-github-pat\")},\n        ),\n        entrypoint=\"example.py:my_flow\"\n    ).deploy(\n        name=\"my-deployment\",\n        parameters=dict(name=\"Marvin\"),\n        work_pool_name=\"local\", # or the name of your work pool\n    )\n```\n\n#### Deploy using an infrastructure block and a storage block\n\nFor the code below, you need to create a work pool from your infrastructure block and pass it to\n`flow.deploy` as the `work_pool_name` argument. You also need to pass your storage block to\n`flow.from_source` as the `source` argument.\n\n```python example.py theme={null}\nfrom prefect import flow\nfrom prefect.deployments import Deployment\nfrom prefect.filesystems import GitHub # this block class no longer exists\nfrom prefect.infrastructure.kubernetes import KubernetesJob\n\n\n@flow(log_prints=True)\ndef my_flow(name: str = \"world\"):\n    print(f\"Hello {name}! I'm a flow from a GitHub repo!\")\n\nrepo = GitHub.load(\"demo-repo\")\n\nif __name__ == \"__main__\":\n    Deployment.build_from_flow(\n        my_flow,\n        name=\"my-deployment\",\n        storage=repo,\n        entrypoint=\"example.py:my_flow\",\n        infrastructure=KubernetesJob.load(\"my-k8s-job\"),\n        infra_overrides=dict(pull_policy=\"Never\"),\n        parameters=dict(name=\"Marvin\"),\n    )\n```\n\nThe equivalent deployment code using `flow.deploy` should look like this:\n\n```python example.py theme={null}\nfrom prefect import flow\n\nif __name__ == \"__main__\":\n    flow.from_source(\n        source=\"https://github.com/me/myrepo.git\",\n        entrypoint=\"example.py:my_flow\"\n    ).deploy(\n        name=\"my-deployment\",\n        work_pool_name=\"my-k8s-job\",\n        job_variables=dict(pull_policy=\"Never\"),\n        parameters=dict(name=\"Marvin\"),\n    )\n```\n\n<Note>\n  When using `flow.from_source().deploy()` with a remote `source`such as a `GitHub` block or `str` URL like [https://github.com/me/myrepo.git](https://github.com/me/myrepo.git)), the flow you're deploying doesn't need to be available locally before running your script.\n  See the [SDK reference](https://reference.prefect.io/prefect/#prefect.Flow.from_source) for more info on `from_source`.\n</Note>\n\n#### Deploy via a Docker image\n\nIf you currently bake your flow code into a Docker image before deploying, you can use the\n`image` argument of `flow.deploy` to build a Docker image as part of your deployment process:\n\n```python  theme={null}\nfrom prefect import flow\n\n@flow(log_prints=True)\ndef my_flow(name: str = \"world\"):\n    print(f\"Hello {name}! I'm a flow from a Docker image!\")\n\n\nif __name__ == \"__main__\":\n    my_flow.deploy(\n        name=\"my-deployment\",\n        image=\"my-repo/my-image:latest\",\n        work_pool_name=\"my-k8s-job\",\n        job_variables=dict(pull_policy=\"Never\"),\n        parameters=dict(name=\"Marvin\"),\n    )\n```\n\nYou can skip a `flow.from_source` call when building an image with `flow.deploy`. Prefect\nkeeps track of the flow's source code location in the image and loads it from that location when the\nflow is executed.\n\n### Use `prefect deploy`\n\n<Warning>\n  **Always run `prefect deploy` commands from the `root` level of your repo!**\n\n  With agents, you may have multiple `deployment.yaml` files. But under worker deployment\n  patterns, each repo has a single `prefect.yaml` file located at the **root** of the repo\n  that contains [deployment configuration](/v3/deploy/infrastructure-concepts/prefect-yaml/#work-with-multiple-deployments-with-prefect-yaml)\n  for all flows in that repo.\n</Warning>\n\nTo set up a new `prefect.yaml` file for your deployments, run the following command from the root\nlevel of your repo:\n\n```bash  theme={null}\nprefect deploy\n```\n\nThis starts a wizard that guides you through setting up your deployment.\n\n<Note>\n  **For step 4, select `y` on the last prompt to save the configuration for the deployment.**\n\n  Saving the configuration for your deployment results in a `prefect.yaml` file populated\n  with your first deployment. You can use this YAML file to edit and [define multiple deployments](/v3/deploy/infrastructure-concepts/prefect-yaml/#work-with-multiple-deployments-with-prefect-yaml)\n  for this repo.\n</Note>\n\nYou can add more [deployments](/v3/deploy/infrastructure-concepts/prefect-yaml/#deployment-declaration-reference)\nto the `deployments` list in your `prefect.yaml` file and/or by continuing to use the deployment\ncreation wizard.\n\nFor more information on deployments, check out our [in-depth guide for deploying flows to work pools](/v3/how-to-guides/deployment_infra/serve-flows-docker).",
  "content_length": 15672
}