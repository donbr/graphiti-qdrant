{
  "title": "How to cache workflow step outputs",
  "source_url": "https://docs-3.prefect.io/v3/how-to-guides/workflows/cache-workflow-steps",
  "content": "The simplest way to cache the results of tasks within in a flow is to set `persist_result=True` on a task definition.\n\n```python  theme={null}\nfrom prefect import task, flow\n\n@task(persist_result=True)\ndef add_one(x: int):\n    return x + 1\n\n@flow\ndef my_flow():\n    add_one(1) # will not be cached\n    add_one(1) # will be cached\n    add_one(2) # will not be cached\n\nif __name__ == \"__main__\":\n    my_flow()\n```\n\n<Accordion title=\"Output\">\n  ```python  theme={null}\n  16:28:51.230 | INFO    | Flow run 'outgoing-cicada' - Beginning flow run 'outgoing-cicada' for flow 'my-flow'\n  16:28:51.257 | INFO    | Task run 'add_one-d85' - Finished in state Completed()\n  16:28:51.276 | INFO    | Task run 'add_one-eff' - Finished in state Cached(type=COMPLETED)\n  16:28:51.294 | INFO    | Task run 'add_one-d16' - Finished in state Completed()\n  16:28:51.311 | INFO    | Flow run 'outgoing-cicada' - Finished in state Completed()\n  ```\n</Accordion>\n\nThis will implicitly use the `DEFAULT` cache policy, which is a composite cache policy defined as:\n\n```python  theme={null}\nDEFAULT = INPUTS + TASK_SOURCE + RUN_ID\n```\n\nThis means subsequent calls of a task with identical inputs from within the same parent run will return cached results without executing the body of the function.\n\n<Note>\n  The `TASK_SOURCE` component of the `DEFAULT` cache policy helps avoid naming collisions between similar tasks that should not share a cache.\n</Note>\n\n### Cache based on inputs\n\nTo cache the result of a task based only on task inputs, set `cache_policy=INPUTS` in the task decorator:\n\n```python  theme={null}\nfrom prefect import task\nfrom prefect.cache_policies import INPUTS\n\nimport time\n\n\n@task(cache_policy=INPUTS)\ndef my_stateful_task(x: int):\n    print('sleeping')\n    time.sleep(10)\n    return x + 1\n\nmy_stateful_task(x=1) # sleeps\nmy_stateful_task(x=1) # does not sleep\nmy_stateful_task(x=2) # sleeps\n```\n\nThe above task will sleep the first time it is called with `x=1`, but will not sleep for any subsequent calls with the same input.\n\nPrefect ships with several [cache policies](/v3/concepts/caching#cache-policies) that can be used to customize caching behavior.\n\n### Cache based on a subset of inputs\n\nTo cache based on a subset of inputs, you can subtract kwargs from the `INPUTS` cache policy.\n\n```python  theme={null}\nfrom prefect import task\nfrom prefect.cache_policies import INPUTS\n\nimport time\n\n\n@task(cache_policy=INPUTS - 'debug')\ndef my_stateful_task(x: int, debug: bool = False):\n    print('sleeping')\n    time.sleep(10)\n    return x + 1\n\nmy_stateful_task(x=1) # sleeps\nmy_stateful_task(x=1, debug=True) # does not sleep\nmy_stateful_task(x=1, debug=False) # does not sleep\n```\n\n### Cache with an expiration\n\nTo cache with an expiration, set the `cache_expiration` parameter on the task decorator.\n\n```python  theme={null}\nfrom prefect import task\nfrom prefect.cache_policies import INPUTS\n\nimport time\nfrom datetime import timedelta\n\n\n@task(cache_policy=INPUTS, cache_expiration=timedelta(seconds=10))\ndef my_stateful_task(x: int):\n    print('sleeping')\n    time.sleep(10)\n    return x + 1\n\nmy_stateful_task(x=1) # sleeps\nmy_stateful_task(x=1) # does not sleep\n# ... 10 seconds pass ...\nmy_stateful_task(x=1) # sleeps again\n```\n\n### Ignore the cache\n\nTo ignore the cache regardless of the cache policy, set the `refresh_cache` parameter on the task decorator.\n\n```python  theme={null}\nimport random\n\nfrom prefect import task\nfrom prefect.cache_policies import TASK_SOURCE\n\n\n@task(cache_policy=TASK_SOURCE, refresh_cache=True)\ndef never_caching_task():\n    return random.random()\n```\n\nTo refresh the cache for all tasks, use the `PREFECT_TASKS_REFRESH_CACHE` setting.\nSetting `PREFECT_TASKS_REFRESH_CACHE=true` changes the default behavior of all tasks to refresh.\n\nIf you have tasks that should not refresh when this setting is enabled, set `refresh_cache` to `False`. These tasks will never write to the cache. If a cache key exists it will be read, not updated.\nIf a cache key does *not* exist yet, these tasks can still write to the cache.\n\n```python  theme={null}\nimport random\n\nfrom prefect import task\nfrom prefect.cache_policies import TASK_SOURCE\n\n\n@task(cache_policy=TASK_SOURCE, refresh_cache=False)\ndef caching_task():\n    return random.random()\n```\n\n### Cache on multiple criteria\n\nCache policies can be combined using the `+` operator.\n\n```python  theme={null}\nfrom prefect import task\nfrom prefect.cache_policies import INPUTS, TASK_SOURCE\n\n@task(cache_policy=INPUTS + TASK_SOURCE)\ndef my_task(x: int):\n    return x + 1\n```\n\nThe above task will use a cached result as long as the same inputs and task source are used.\n\n### Cache in a distributed environment\n\nBy default Prefect stores results locally in `~/.prefect/storage/`. To share the cache across tasks running on different machines, provide a storage block to the `result_storage` parameter on the task decorator.\n\nHere's an example with of a task that uses an S3 bucket to store cache records:\n\n```python  theme={null}\nfrom prefect import task\nfrom prefect.cache_policies import INPUTS\n\nfrom prefect_aws import AwsCredentials, S3Bucket\n\ns3_bucket = S3Bucket(\n    credentials=AwsCredentials(\n        aws_access_key_id=\"my-access-key-id\",\n        aws_secret_access_key=\"my-secret-access-key\",\n    ),\n    bucket_name=\"my-bucket\",\n)\n# save the block to ensure it is available across machines\ns3_bucket.save(\"my-cache-bucket\")\n\n@task(cache_policy=INPUTS, result_storage=s3_bucket)\ndef my_cached_task(x: int):\n    return x + 42\n```\n\n<Note>\n  When using a storage block from a Prefect integration package, the package the storage block is imported from must be installed in all environments where the task will run.\n\n  For example, the `prefect_aws` package must be installed to use the `S3Bucket` storage block.\n</Note>\n\n### Further reading\n\nFor more advanced caching examples, see the [advanced caching how-to guide](/v3/advanced/caching).\n\nFor more information on Prefect's caching system, see the [caching concepts page](/v3/concepts/caching).",
  "content_length": 6017
}