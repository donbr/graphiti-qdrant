{
  "title": "Azure Container Instances Worker Guide",
  "source_url": "https://docs-3.prefect.io/integrations/prefect-azure/aci_worker",
  "content": "## Why use ACI for flow run execution?\n\nACI (Azure Container Instances) is a fully managed compute platform that streamlines running your Prefect flows on scalable, on-demand infrastructure on Azure.\n\n## Prerequisites\n\nBefore starting this guide, make sure you have:\n\n* An Azure account and user permissions for provisioning resource groups and container instances.\n* The `azure` CLI installed on your local machine. You can follow Microsoft's [installation guide](https://learn.microsoft.com/en-us/cli/azure/install-azure-cli).\n* Docker installed on your local machine.\n\n## Step 1. Create a resource group\n\nAzure resource groups serve as containers for managing groupings of Azure resources.\n\nReplace `<resource-group-name>` with the name of your choosing, and `<location>` with a valid Azure location name, such as`eastus`.\n\n```bash  theme={null}\nexport RG_NAME=<resource-group-name> && \\\naz group create --name $RG_NAME --location <location>\n```\n\nThroughout the rest of the guide, we'll need to refer to the **scope** of the created resource group, which is a string describing where the resource group lives in the hierarchy of your Azure account. To save the scope of your resource group as an environment variable, run the following command:\n\n```bash  theme={null}\nRG_SCOPE=$(az group show --name $RG_NAME --query id --output tsv)\n```\n\nYou can check that the scope is correct before moving on by running `echo $RG_SCOPE` in your terminal. It should be formatted as follows:\n\n```\n/subscriptions/<subscription-id>/resourceGroups/<resource-group-name>\n```\n\n## Step 2. Prepare ACI permissions\n\nIn order for the worker to create, monitor, and delete the other container instances in which flows will run, we'll need to create a **custom role** and an **identity**, and then affiliate that role to the identity with a **role assignment**. When we start our worker, we'll assign that identity to the container instance it's running in.\n\n### 1. Create a role\n\nThe custom `Container Instances Contributor` role has all the permissions your worker will need to run flows in other container instances. Create it by running the following command:\n\n```bash  theme={null}\naz role definition create --role-definition '{\n  \"Name\": \"Container Instances Contributor\",\n  \"IsCustom\": true,\n  \"Description\": \"Can create, delete, and monitor container instances.\",\n  \"Actions\": [\n    \"Microsoft.ManagedIdentity/userAssignedIdentities/assign/action\",\n    \"Microsoft.Resources/deployments/*\",\n    \"Microsoft.ContainerInstance/containerGroups/*\"\n  ],\n  \"NotActions\": [\n  ],\n  \"AssignableScopes\": [\n    '\"\\\"$RG_SCOPE\\\"\"'\n  ]\n}'\n```\n\n### 2. Create an identity\n\nCreate a user-managed identity with the following command, replacing `<identity-name>` with the name you'd like to use for the identity:\n\n```bash  theme={null}\nexport IDENTITY_NAME=<identity_name> && \\\naz identity create -g $RG_NAME -n $IDENTITY_NAME\n```\n\nWe'll also need to save the principal ID and full object ID of the identity for the role assignment and container creation steps, respectively:\n\n```bash  theme={null}\nIDENTITY_PRINCIPAL_ID=$(az identity list --query \"[?name=='$IDENTITY_NAME'].principalId\" --output tsv) && \\\nIDENTITY_ID=$(az identity list --query \"[?name=='$IDENTITY_NAME'].id\" --output tsv)\n```\n\n### 3. Assign roles to the identity\n\nNow let's assign the `Container Instances Contributor` role we created earlier to the new identity:\n\n```bash  theme={null}\naz role assignment create \\\n    --assignee $IDENTITY_PRINCIPAL_ID \\\n    --role \"Container Instances Contributor\" \\\n    --scope $RG_SCOPE\n```\n\nSince we'll be using ACR to host a custom Docker image containing a Prefect flow later in the guide, let's also assign the built in `AcrPull` role to the identity:\n\n```bash  theme={null}\naz role assignment create \\\n    --assignee $IDENTITY_PRINCIPAL_ID \\\n    --role \"AcrPull\" \\\n    --scope $RG_SCOPE\n```\n\n## Step 3. Create the worker container instance\n\nBefore running this command, set your `PREFECT_API_URL` and `PREFECT_API_KEY` as environment variables:\n\n```bash  theme={null}\nexport PREFECT_API_URL=<PREFECT_API_URL_HERE> PREFECT_API_KEY=<PREFECT_API_KEY_HERE>\n```\n\nRunning the following command will create a container instance in your Azure resource group that will start a Prefect ACI worker. If there is not already a work pool in Prefect with the name you chose, a work pool will also be created.\n\nReplace `<work-pool-name>` with the name of the ACI work pool you want to create in Prefect. Here we're using the work pool name as the name of the container instance in Azure as well, but you may name it something else if you prefer.\n\n```bash  theme={null}\naz container create \\\n    --name <work-pool-name> \\\n    --resource-group $RG_NAME \\\n    --assign-identity $IDENTITY_ID \\\n    --image \"prefecthq/prefect:3-python3.12\" \\\n    --secure-environment-variables PREFECT_API_URL=$PREFECT_API_URL PREFECT_API_KEY=$PREFECT_API_KEY \\\n    --command-line \"/bin/bash -c 'pip install prefect-azure && prefect worker start --pool <work-pool-name> --type azure-container-instance'\" \n```\n\nThis container instance uses default networking and security settings. For advanced configuration, refer the `az container create` [CLI reference](https://learn.microsoft.com/en-us/cli/azure/container?view=azure-cli-latest#az-container-create).\n\n## Step 4. Create an ACR registry\n\nIn order to build and push images containing flow code to Azure, we'll need a container registry. Create one with the following command, replacing `<registry-name>` with the registry name of your choosing:\n\n```bash  theme={null}\nexport REGISTRY_NAME=<registry-name> && \\\naz acr create --resource-group $RG_NAME \\\n  --name <registry-name> --sku Basic\n```\n\n## Step 5. Update your ACI work pool configuration\n\nOnce your work pool is created, navigate to the Edit page of your ACI work pool. You will need to update the following fields:\n\n### Identities\n\nThis will be your `IDENTITY_ID`. You can get it from your terminal by running `echo $IDENTITY_ID`. When adding it to your work pool, it should be formatted as a JSON array:\n\n```\n[\"/subscriptions/<subscription-id>/resourcegroups/<resource-group-name>/providers/Microsoft.ManagedIdentity/userAssignedIdentities/<identity-name>\"]\n```\n\n<img src=\"https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/integrations/aci-worker-identities.png?fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=5b6a19d6b2a5a742fb8587da6941d606\" alt=\"Configuring an ACI work pool's identities.\" data-og-width=\"2860\" width=\"2860\" data-og-height=\"426\" height=\"426\" data-path=\"images/integrations/aci-worker-identities.png\" data-optimize=\"true\" data-opv=\"3\" srcset=\"https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/integrations/aci-worker-identities.png?w=280&fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=c94e92fb24ace9f1e5bc974620319445 280w, https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/integrations/aci-worker-identities.png?w=560&fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=a034033ac86d5f81625f48ce9214efd4 560w, https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/integrations/aci-worker-identities.png?w=840&fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=d8b8b4438a58e9913e87f9c86a9c0b9f 840w, https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/integrations/aci-worker-identities.png?w=1100&fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=73363567c6b816257111c97d32abb623 1100w, https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/integrations/aci-worker-identities.png?w=1650&fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=cc52b0b048841969c2de5769b94f2c79 1650w, https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/integrations/aci-worker-identities.png?w=2500&fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=60e77729d0b4a16796f85b631364e320 2500w\" />\n\n### ACRManagedIdentity\n\nACRManagedIdentity is required for your flow code containers to be pulled from ACR. It consists of the following:\n\n* Identity: the same `IDENTITY_ID` as above, as a string\n\n```\n/subscriptions/<subscription-id>/resourcegroups/<resource-group-name>/providers/Microsoft.ManagedIdentity/userAssignedIdentities/<identity-name>\n```\n\n* Registry URL: your `<registry-name>`, followed by `.azurecr.io`\n\n```\n<registry-name>.azurecr.io\n```\n\n<img src=\"https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/integrations/aci-worker-acridentity.png?fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=c5d86b7c9e8dc2dce48c264f9a1f9bda\" alt=\"Configuring an ACI work pool's ACR Managed Identity.\" data-og-width=\"2824\" width=\"2824\" data-og-height=\"552\" height=\"552\" data-path=\"images/integrations/aci-worker-acridentity.png\" data-optimize=\"true\" data-opv=\"3\" srcset=\"https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/integrations/aci-worker-acridentity.png?w=280&fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=1bc6ae99eb0c39617e236af171f8a721 280w, https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/integrations/aci-worker-acridentity.png?w=560&fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=6bd76d504ab1fadb86f1f52ae5d31e5c 560w, https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/integrations/aci-worker-acridentity.png?w=840&fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=3cdc56678297cc04e0f43d34ceeea969 840w, https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/integrations/aci-worker-acridentity.png?w=1100&fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=18a784d93b3e47bac2c1a6a40b9fa12a 1100w, https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/integrations/aci-worker-acridentity.png?w=1650&fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=e2ad6047d0e7d7cbec12c9865d45dd2e 1650w, https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/integrations/aci-worker-acridentity.png?w=2500&fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=4fd35c1c53b2a517d2cd1741c3c68cd8 2500w\" />\n\n### Subscription ID and resource group name\n\nBoth the subscription ID and resource group name can be found in the `RG_SCOPE` environment variable created earlier in the guide. View their values by running `echo $RG_SCOPE`:\n\n```\n/subscriptions/<subscription-id>/resourceGroups/<resource-group-name>\n```\n\n<img src=\"https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/integrations/aci-worker-subscription.png?fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=9f9351730b058bea5fd23ee474630bf8\" alt=\"Configuring an ACI work pool.\" data-og-width=\"1256\" width=\"1256\" data-og-height=\"468\" height=\"468\" data-path=\"images/integrations/aci-worker-subscription.png\" data-optimize=\"true\" data-opv=\"3\" srcset=\"https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/integrations/aci-worker-subscription.png?w=280&fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=616f3da9418664e564343d730514a717 280w, https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/integrations/aci-worker-subscription.png?w=560&fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=4def6268ce57c7ba802bb04058a3188d 560w, https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/integrations/aci-worker-subscription.png?w=840&fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=7af1d7dedd653c1d379a1cc3cca181fe 840w, https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/integrations/aci-worker-subscription.png?w=1100&fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=bf9ac9f9ec29dbf3eace13929e1af63c 1100w, https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/integrations/aci-worker-subscription.png?w=1650&fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=e88e96b30f7c1ca1ad5656a9b0c302e0 1650w, https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/integrations/aci-worker-subscription.png?w=2500&fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=fb83f99e758670f03ed15fe6801a679e 2500w\" />\n\nThen click Save.\n\n## Step 6. Pick up a flow run with your new worker\n\nThis guide uses ACR to store a Docker image containing your flow code. Write a flow, then deploy it using `flow.deploy()`, which will copy flow code into a Docker image and push that image to an ACR registry.\n\n### 1. Log in to ACR\n\nUse the following commands to log in to ACR:\n\n```\nTOKEN=$(az acr login --name $REGISTRY_NAME --expose-token --output tsv --query accessToken)\n```\n\n```\ndocker login $REGISTRY_NAME.azurecr.io --username 00000000-0000-0000-0000-000000000000 --password-stdin <<< $TOKEN\n```\n\n### 2. Write and deploy a simple test flow\n\nCreate and run the following script to deploy your flow. Be sure to replace `<registry-name>` and `<work-pool-name>` with the appropriate values.\n\n`my_flow.py`\n\n```python  theme={null}\nfrom prefect import flow\nfrom prefect.logging import get_run_logger\nfrom prefect.docker import DockerImage\n\n@flow\ndef my_flow():\n    logger = get_run_logger()\n    logger.info(\"Hello from ACI!\")\n\nif __name__ == \"__main__\":\n    my_flow.deploy(\n        name=\"aci-deployment\",\n        image=DockerImage(\n            name=\"<registry-name>.azurecr.io/example:latest\",\n            platform=\"linux/amd64\",\n        ),\n        work_pool_name=\"<work-pool-name>\",\n    )\n```\n\n### 3. Find the deployment in the UI and click the **Quick Run** button!",
  "content_length": 13015
}