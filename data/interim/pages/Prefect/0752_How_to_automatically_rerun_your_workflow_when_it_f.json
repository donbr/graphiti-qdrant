{
  "title": "How to automatically rerun your workflow when it fails",
  "source_url": "https://docs-3.prefect.io/v3/how-to-guides/workflows/retries",
  "content": "### Set the number of retries\n\nTo rerun your workflow when an exception is raised, set the `retries` parameter to an integer.\n\n```python  theme={null}\nfrom prefect import flow\n\n\n@flow(retries=3)\ndef troublesome_workflow():\n    raise Exception(\"oopsie daisy\")\n```\n\n### Wait between retries\n\nTo add a wait between retries, pass a value to the `retry_delay_seconds` parameter.\n\n```python  theme={null}\nfrom prefect import flow\n\n\n@flow(retries=3, retry_delay_seconds=2.7182)\ndef troublesome_workflow():\n    raise Exception(\"oopsie daisy\")\n```\n\n### Retry parts of a workflow\n\nYou can configure retries for individual tasks in a workflow to limit the scope of a retry.\n\n```python  theme={null}\nimport random\n\nimport httpx\nfrom prefect import flow, task\n\n\n@task\ndef consistent_task() -> dict:\n    print(\"I won't rerun even if the task after me fails\")\n\n\n@task(retries=4, retry_delay_seconds=5)\ndef mercurial_task() -> dict:\n    # Will fail half of the time\n    url = f\"https://httpbin.org/status/{random.choice([200, 500])}\"\n\n    response = httpx.get(url)\n    response.raise_for_status()\n    \n\n@flow\ndef my_workflow():\n    consistent_task()\n    mercurial_task()\n```\n\n### Retry with configurable delay\n\nA task's retry delays can also be defined as a list of integers for different delays between retries.\n\n```python  theme={null}\nfrom prefect import task\n\n\n@task(retries=4, retry_delay_seconds=[1, 2, 4, 8])\ndef melancholic_task():\n    raise Exception(\"We used to see each other so much more often\")\n```\n\nYou can also use the `exponential_backoff` utility to generate a list of retry delays that correspond to an exponential backoff retry strategy.\n\n```python  theme={null}\nfrom prefect import task\nfrom prefect.tasks import exponential_backoff\n\n\n@task(retries=4, retry_delay_seconds=exponential_backoff(backoff_factor=2))\ndef melancholic_task():\n    raise Exception(\"We used to see each other so much more often\")\n```\n\n### Retry with a custom condition\n\nWhether or not a task should be retried can be determined dynamically by passing a callable to the `retry_condition_fn` parameter.\n\n```python  theme={null}\nimport httpx\nfrom prefect import flow, task\n\n\ndef retry_handler(task, task_run, state) -> bool:\n    \"\"\"\n    Retry handler that skips retries if the HTTP status code is 401 or 404.\n    \"\"\"\n    try:\n        state.result()\n    except httpx.HTTPStatusError as exc:\n        do_not_retry_on_these_codes = [401, 404]\n        return exc.response.status_code not in do_not_retry_on_these_codes\n    except httpx.ConnectError:\n        return False\n    except:\n        return True\n\n\n@task(retries=1, retry_condition_fn=retry_handler)\ndef api_call_task(url):\n    response = httpx.get(url)\n    response.raise_for_status()\n    return response.json()\n\n\n@flow\ndef my_workflow(url):\n    api_call_task(url=url)\n```\n\nIf a callable passed to `retry_condition_fn` returns `True`, the task will be retried. Otherwise, the task will exit with an exception.\n\n### Add jitter to retry delays\n\nTo add a random amount of time to retry delays, pass a value to the `retry_jitter_factor` parameter.\n\n```python  theme={null}\nimport time\n\nfrom prefect import task\nfrom prefect.tasks import exponential_backoff\n\nlast_run_time = time.time()\n\n@task(\n    retries=3,\n    retry_delay_seconds=exponential_backoff(backoff_factor=5),\n    retry_jitter_factor=3,\n)\ndef some_task_with_exponential_backoff_retries():\n    global last_run_time\n    print(f\"Time between retries: {time.time() - last_run_time}\")\n    if time.time() - last_run_time < 10:\n        last_run_time = time.time()\n        raise Exception(\"I could fail some more\")\n    return \"That's enough failure\"\n```\n\nAdding jitter to the retry delays avoids multiple tasks introducing load to external systems by failing and retrying at the exact same cadence.\n\n### Configure task retry behavior globally\n\nYou can set the default retries and retry delays for all tasks via Prefect's settings.\nThe default values can be overridden on a per-task basis via the `retries` and `retry_delay_seconds` parameters.\n\n```\nprefect config set PREFECT_TASK_DEFAULT_RETRIES=2\nprefect config set PREFECT_TASK_DEFAULT_RETRY_DELAY_SECONDS=\"1,10,100\"\n```",
  "content_length": 4149
}