{
  "title": "How to run flows on Coiled",
  "source_url": "https://docs-3.prefect.io/v3/how-to-guides/deployment_infra/coiled",
  "content": "Deploy cloud infrastructure without expertise with Coiled\n\nThis page provides a step-by-step guide to run Prefect flows in your own cloud\naccount using two technologies:\n\n* [Serverless push work pools](/v3/how-to-guides/deployment_infra/serverless), which remove the need to\n  host any always-on Prefect worker\n* [Coiled](https://coiled.io?utm_source=prefect-docs), which manages cloud VMs such as\n  ECS, Cloud Run, and ACI in your account ergonomically and accessibly.\n\nThis combination combines the cost efficiency and security\nof a cloud VM with easy setup and zero-maintenance infrastructure.\n\nCoiled is a for-profit service, but its free tier is usually enough for most\nPrefect users.  Coiled is provided by the makers of Dask.  This video\nwalks through the steps in this article:\n\n<script src=\"https://fast.wistia.com/embed/medias/lhn157i193.jsonp\" async />\n\n<script src=\"https://fast.wistia.com/assets/external/E-v1.js\" async />\n\n<div class=\"wistia_responsive_padding\" style={{padding: '45% 0 0 0', position: 'relative', width: '100%', margin: 'auto' }}>\n  <div class=\"wistia_responsive_wrapper\" style={{height:\"100%\", left:0, position:\"absolute\", top:0, width:\"100%\"}}>\n    <div class=\"wistia_embed wistia_async_lhn157i193 seo=true videoFoam=true\" style={{height:\"100%\", position:\"relative\", width:\"100%\"}}>\n       \n    </div>\n  </div>\n</div>\n\n## Install and set up accounts\n\n```\npip install prefect coiled prefect-coiled\n```\n\nIf you haven't used Prefect Cloud before, you'll need to [create a Prefect account](https://app.prefect.cloud) and log in:\n\n```\nprefect cloud login\n```\n\nIf you haven't used Coiled before, you'll need to [create a Coiled account](https://cloud.coiled.io/signup?utm_source=prefect-docs) and log in:\n\n```\ncoiled login\n```\n\nand then connect Coiled to your cloud account (AWS, Google Cloud, or Azure) where Coiled will run your flows. You can either use our interactive setup CLI:\n\n```\ncoiled setup\n```\n\nor via the web app UI at [cloud.coiled.io/settings/setup](https://cloud.coiled.io/settings/setup).\n\n## Create the Prefect push work pool\n\nTo create the push work pool:\n\n```\nprefect work-pool create --type coiled:push --provision-infra 'example-coiled-pool'\n```\n\n## Create flow and create deployment\n\nWe write our flow in Python as normal, using the work pool `\"example-coiled-pool\"` that we created in the last step.\n\n<Tabs>\n  <Tab title=\"example_flow.py\">\n    ```py  theme={null}\n    #example_flow.py\n    from prefect import flow, task\n\n    @task\n    def f(n):\n        return n**2\n\n    @task\n    def do_something(x):\n        print(x)\n\n    @flow(log_prints=True)\n    def my_flow():\n        print(\"Hello from your Prefect flow!\")\n        X = f.map(list(range(10)))\n        do_something(X)\n        return X\n\n\n    if __name__ == \"__main__\":\n        my_flow.deploy(\n            name=\"example-coiled-deployment\",\n            work_pool_name=\"example-coiled-pool\",\n            image=\"my-image\",\n        )\n    ```\n  </Tab>\n</Tabs>\n\n```\npython example_flow.py\n```\n\nHere we specified the Docker image `”my-image”` that you would replace with your own image location.  Alternatively, if you don’t enjoy working with Docker, see the section [Dockerless Execution](#dockerless-execution) below.\n\nOur deployment is now launched and we can execute runs either on the command line using the command printed out:\n\n```\nprefect deployment run 'my-flow/example-coiled-deployment'\n```\n\nOr by going to the deployment at the URL that Prefect prints in the CLI.\n\n## Dockerless execution\n\nYou don’t have to use Docker if you don’t want to.  In our example above we used Docker to build an image locally and push up to our Docker image repository:\n\n```python  theme={null}\nif __name__ == \"__main__\":\n    my_flow.deploy(\n        name=\"example-coiled-deployment\",\n        work_pool_name=\"example-coiled-pool\",\n        image=\"my-image\",                       # <--------\n    )\n```\n\nThis works well if you and your team are familiar with Docker.  However, if you’re not familiar, then it can cause confusion in a variety of ways:\n\n* You may not have Docker installed\n* You may be on a Mac, and be generating ARM-based Docker images for Intel-based cloud machines\n* You may need to rebuild your Docker image each time you update libraries\n* People on your team may not know how Docker works, limiting who can use Prefect\n\nBecause of this, Coiled also provides a Dockerless execution process that called [Package Sync](#how-environment-synchronization).  Coiled can automatically inspect your local environment and build a remote cloud environment on the fly.  This can be more ergonomic and accessible to everyone on the team.\n\nTo invoke this feature today you need to have both a Python file such as `example_flow.py` with your flow defined, and a `prefect.yaml` deployment configuration file .\n\n<Tabs>\n  <Tab title=\"example_flow.py\">\n    ```py  theme={null}\n    from prefect import flow, task\n\n    @task\n    def foo(n):\n        return n**2\n\n    @task\n    def do_something(x):\n        print(x)\n\n    @flow(log_prints=True)\n    def my_flow():\n        print(\"Hello from your Prefect flow!\")\n        X = foo.map(list(range(10)))\n        do_something(X)\n        return X\n    ```\n  </Tab>\n\n  <Tab title=\"prefect.yaml\">\n    ```yaml  theme={null}\n    push:\n    - prefect_coiled.deployments.steps.build_package_sync_senv:\n        id: coiled_senv\n\n    pull:\n    - prefect.deployments.steps.set_working_directory:\n        directory: /scratch/batch\n\n    deployments:\n    - name: example-coiled-deploy\n      build: null\n      entrypoint: example_flow:my_flow\n      work_pool:\n        name: example-coiled-pool\n        job_variables:\n          software: '{{ coiled_senv.name }}'\n    ```\n  </Tab>\n</Tabs>\n\nYou can deploy this flow to Prefect Cloud with the `prefect deploy` command, which makes it ready to run in the cloud.\n\n```\nprefect deploy --prefect-file prefect.yaml --all\n```\n\nYou can then run this flow as follows:\n\n```\nprefect deployment run 'my-flow/example-coiled-deployment'\n```\n\nIf the Docker example above didn’t work for you (for example because you didn’t have Docker installed, or because you have a Mac) then you may find this approach to be more robust.\n\n## Configure hardware\n\nOne of the great things about the cloud is that you can experiment with different kinds of machines.  Need lots of memory?  No problem.  A big GPU?  Of course!  Want to try ARM architectures for cost efficiency?  Sure!\n\nIf you’re using Coiled’s Dockerless framework you can specify the following variables in your `prefect.yaml` file:\n\n```\njob_variables:\n  cpu: 16\n  memory: 32GB\n```\n\nIf you’re operating straight from Python you can add these as a keyword in the `.deploy` call.\n\n```py  theme={null}\nmy_flow.deploy(\n    ...,\n    job_variables={\"cpu\": 16, \"memory\": \"32GB\"}\n)\n```\n\nFor a full list of possible configuration options see [Coiled API Documentation](https://docs.coiled.io/user_guide/api.html?utm_source=prefect-docs#coiled-batch-run).\n\n## Extra: scale out\n\nCoiled makes it simple to parallelize individual flows on distributed cloud hardware.  The easiest way to do this is to annotate your Prefect tasks with the `@coiled.function` decorator.\n\nLet’s modify our example from above:\n\n```python  theme={null}\nfrom prefect import flow, task\nimport coiled                               # new!\n\n@task\ndef f(n):\n    return n**2\n\n@task\n@coiled.function(memory=\"64 GiB\")           # new!\ndef do_something(x):\n    print(x)\n\n@flow(log_prints=True)\ndef my_flow():\n    print(\"Hello from your Prefect flow!\")\n    X = f.map(list(range(10)))\n```\n\nIf you’re using Docker, then you’ll have to rerun the Python script to rebuild the image.  If you’re using the Dockerless approach, then you’ll need to redeploy your flow.\n\n```\nprefect deploy --prefect-file prefect.yaml --all\n```\n\nAnd then you can re-run things to see the new machines show up:\n\n```\nprefect deployment run 'my-flow/example-coiled-deployment'\n```\n\n## Architecture: How does this work?\n\nIt’s important to know where work happens so that you can understand the security and cost implications involved.\n\nCoiled runs flows on VMs spun up in *your* cloud account (this is why you had to setup Coiled with your cloud account earlier). This means that …\n\n* You’ll be charged directly by your cloud provider for any computation used.\n* Your data stays within your cloud account.  Neither Prefect nor Coiled ever see your data.\n\nCoiled uses raw VM services (like AWS EC2) rather than systems like Kubernetes or Fargate, which has both good and bad tradeoffs:\n\n* **Bad:** there will be a 30-60 second spin-up time on any new flow.\n* **Good:** there is no resting infrastructure like a Kubernetes controller or long-standing VM, so there are no standing costs when you aren’t actively running flows.\n* **Good:** you can use any VM type available on the cloud, like big memory machines or GPUs.\n* **Good:** there is no cloud infrastructure to maintain and keep up-to-date.\n* **Good:** Raw VMs are cheap. They cost from $0.02 to $0.05 per CPU-hour.\n\nSee [Coiled Documentation](https://docs.coiled.io/user_guide/why.html?utm_source=prefect-docs) to learn more about Coiled architecture and design decisions.\n\n## FAQ\n\n* **Q:** Where do my computations run?<br />\n  **A:** Coiled deploys VMs inside your account.<br />\n\n* **Q:** Can anyone see my data?<br />\n  **A:** Only you and people in your own cloud account.<br />\n\n* **Q:** When I update my software libraries how does that software get on my cloud machines?<br />\n  **A:** If you’re using Docker then you handle this.  Otherwise, when you redeploy your flow Coiled scans your local Python environment and ships a specification of all libraries you’re using, along with any local .py files you have lying around.  These live in a secure S3 bucket while waiting for your VMs.<br />\n\n* **Q:** How much does this cost?<br />\n  **A:** You’ll have to pay your cloud provider for compute that you use.  Additionally, if you use more than 10,000 CPU-hours per month, you’ll have to pay Coiled \\$0.05 per CPU-hour.<br />\n  The average cost we see of Prefect flows is less than \\$0.02.<br />\n\n* **Q:** Will this leave expensive things running in my cloud account?<br />\n  **A:** No.  We clean everything up very thoroughly (VMs, storage, …)  It is safe to try and cheap to run.<br />\n\n* **Q:** What permissions do I need to give Coiled?<br />\n  **A:** In the [cloud setup process above](#install-and-setup-accounts) you give us permissions to do things like turn on and off VMs, set up security groups, and put logs into your cloud logging systems.  You do not give us any access to your data.<br />\n  Coiled is happy to talk briefly to your IT group if they’re concerned.  Reach out at [support@coiled.io](mailto:support@coiled.io)<br />",
  "content_length": 10717
}