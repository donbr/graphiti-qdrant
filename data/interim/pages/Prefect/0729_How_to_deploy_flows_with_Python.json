{
  "title": "How to deploy flows with Python",
  "source_url": "https://docs-3.prefect.io/v3/how-to-guides/deployments/deploy-via-python",
  "content": "Learn how to use the Python SDK to deploy flows to run in work pools.\n\nAs an alternative to defining deployments in a `prefect.yaml` file, you can use the Python SDK to create deployments with [dynamic infrastructure](/v3/concepts/work-pools).\nThis can be more flexible if you have to programmatically gather configuration at deployment time.\n\n## When to use `flow.deploy` instead of `flow.serve`\n\nThe `flow.serve` method is one [simple way to create a deployment with the Python SDK](/v3/how-to-guides/deployment_infra/run-flows-in-local-processes#serve-a-flow). It's ideal when you have readily available, static infrastructure for your flow runs and you don't need the dynamic dispatch of infrastructure per flow run offered by work pools.\n\nHowever, you might want to consider using `flow.deploy` to associate your flow with a work pool that enables dynamic dispatch of infrastructure per flow run for the following reasons:\n\n1. **Cost optimization:** Dynamic infrastructure can help reduce costs by scaling resources up or down based on demand.\n2. **Resource scarcity:** If you have limited persistent infrastructure, dynamic provisioning can help manage resource allocation more efficiently.\n3. **Varying workloads:** For workflows with inconsistent resource needs, dynamic infrastructure can adapt to changing requirements.\n4. **Cloud-native deployments:** When working with cloud providers that offer serverless or auto-scaling options.\n\nLet's explore how to create a deployment using the Python SDK and leverage dynamic infrastructure through work pools.\n\n## Prerequisites\n\nBefore deploying your flow using `flow.deploy`, ensure you have the following:\n\n1. **A running Prefect server or Prefect Cloud workspace:** You can either run a Prefect server locally or use a Prefect Cloud workspace.\n   To start a local server, run `prefect server start`. To use Prefect Cloud, sign up for an account at [app.prefect.cloud](https://app.prefect.cloud)\n   and follow the [Connect to Prefect Cloud](/v3/manage/cloud/connect-to-cloud/) guide.\n\n2. **A Prefect flow:** You should have a flow defined in your Python script. If you haven't created a flow yet, refer to the\n   [Write Workflows](/v3/how-to-guides/workflows/write-and-run) guide.\n\n3. **A work pool:** You need a work pool to manage the infrastructure for running your flow. If you haven't created a work pool, you can do so through\n   the Prefect UI or using the Prefect CLI. For more information, see the [Work Pools](/v3/concepts/work-pools/) guide.\n\n   For examples in this guide, we'll use a Docker work pool created by running:\n\n   ```bash  theme={null}\n   prefect work-pool create --type docker my-work-pool\n   ```\n\n4. **Docker:** Docker will be used to build and store the image containing your flow code. You can download and install\n   Docker from the [official Docker website](https://www.docker.com/get-started/). If you don't want to use Docker, you\n   can see other options in the [Use remote code storage](#use-remote-code-storage) section.\n\n5. **(Optional) A Docker registry:** While not strictly necessary for local development, having an account with a Docker registry (such as\n   Docker Hub) is recommended for storing and sharing your Docker images.\n\nWith these prerequisites in place, you're ready to deploy your flow using `flow.deploy`.\n\n## Deploy a flow with `flow.deploy`\n\nTo deploy a flow using `flow.deploy` and Docker, follow these steps:\n\n<Steps>\n  <Step title=\"Write a flow\">\n    Ensure your flow is defined in a Python file. Let's use a simple example:\n\n    ```python example.py theme={null}\n    from prefect import flow\n\n\n    @flow(log_prints=True)\n    def my_flow(name: str = \"world\"):\n        print(f\"Hello, {name}!\")\n    ```\n  </Step>\n\n  <Step title=\"Add deployment configuration\">\n    Add a call to `flow.deploy` to tell Prefect how to deploy your flow.\n\n    ```python example.py theme={null}\n    from prefect import flow\n\n\n    @flow(log_prints=True)\n    def my_flow(name: str = \"world\"):\n        print(f\"Hello, {name}!\")\n\n\n    if __name__ == \"__main__\":\n        my_flow.deploy(\n            name=\"my-deployment\",\n            work_pool_name=\"my-work-pool\",\n            image=\"my-registry.com/my-docker-image:my-tag\",\n            push=False # switch to True to push to your image registry\n        )\n    ```\n  </Step>\n\n  <Step title=\"Deploy!\">\n    Run your script to deploy your flow.\n\n    ```bash  theme={null}\n    python example.py\n    ```\n\n    Running this script will:\n\n    1. Build a Docker image containing your flow code and dependencies.\n    2. Create a deployment associated with the specified work pool and image.\n  </Step>\n</Steps>\n\nBuilding a Docker image for our flow allows us to have a consistent environment for our flow to run in. Workers for our work pool will use the image to run our flow.\nIn this example, we set `push=False` to skip pushing the image to a registry. This is useful for local development, and you can push your image to a registry such as Docker Hub in a production environment.\n\n<Note>\n  **Where's the Dockerfile?**\n\n  In the above example, we didn't specify a Dockerfile. By default, Prefect will generate a Dockerfile for us that copies the flow code into an image and installs\n  any additional dependencies.\n\n  If you want to write and use your own Dockerfile, you can do so by passing a `dockerfile` parameter to `flow.deploy`.\n</Note>\n\n### Trigger a run\n\nNow that we have our flow deployed, we can trigger a run via either the Prefect CLI or UI.\n\nFirst, we need to start a worker to run our flow:\n\n```bash  theme={null}\nprefect worker start --pool my-work-pool\n```\n\nThen, we can trigger a run of our flow using the Prefect CLI:\n\n```bash  theme={null}\nprefect deployment run 'my-flow/my-deployment'\n```\n\nAfter a few seconds, you should see logs from your worker showing that the flow run has started and see the state update in the UI.\n\n## Deploy with a schedule\n\nTo deploy a flow with a schedule, you can use one of the following options:\n\n* `interval`\n\n  Defines the interval at which the flow should run. Accepts an integer or float value representing the number of seconds between runs or a `datetime.timedelta` object.\n\n  <Expandable title=\"Example\">\n    ```python interval.py theme={null}\n    from datetime import timedelta\n    from prefect import flow\n\n\n    @flow(log_prints=True)\n    def my_flow(name: str = \"world\"):\n        print(f\"Hello, {name}!\")\n\n\n    if __name__ == \"__main__\":\n        my_flow.deploy(\n            name=\"my-deployment\",\n            work_pool_name=\"my-work-pool\",\n            image=\"my-registry.com/my-docker-image:my-tag\",\n            push=False,\n            # Run once a minute\n            interval=timedelta(minutes=1)\n        )\n    ```\n  </Expandable>\n\n* `cron`\n\n  Defines when a flow should run using a cron string.\n\n  <Expandable title=\"Example\">\n    ```python cron.py theme={null}\n    from prefect import flow\n\n\n    @flow(log_prints=True)\n    def my_flow(name: str = \"world\"):\n        print(f\"Hello, {name}!\")\n\n\n    if __name__ == \"__main__\":\n        my_flow.deploy(\n            name=\"my-deployment\",\n            work_pool_name=\"my-work-pool\",\n            image=\"my-registry.com/my-docker-image:my-tag\",\n            push=False,\n            # Run once a day at midnight\n            cron=\"0 0 * * *\"\n        )\n    ```\n  </Expandable>\n\n* `rrule`\n\n  Defines a complex schedule using an `rrule` string.\n\n  <Expandable title=\"Example\">\n    ```python rrule.py theme={null}\n    from prefect import flow\n\n\n    @flow(log_prints=True)\n    def my_flow(name: str = \"world\"):\n        print(f\"Hello, {name}!\")\n\n\n    if __name__ == \"__main__\":\n        my_flow.deploy(\n            name=\"my-deployment\",\n            work_pool_name=\"my-work-pool\",\n            image=\"my-registry.com/my-docker-image:my-tag\",\n            push=False,\n            # Run every weekday at 9 AM\n            rrule=\"FREQ=WEEKLY;BYDAY=MO,TU,WE,TH,FR;BYHOUR=9;BYMINUTE=0\"\n        )\n    ```\n  </Expandable>\n\n* `schedules`\n\n  Defines multiple schedules for a deployment. This option provides flexibility for:\n\n  * Setting up various recurring schedules\n  * Implementing complex scheduling logic\n  * Applying timezone offsets to schedules\n\n  <Expandable title=\"Example\">\n    ```python schedules.py theme={null}\n    from datetime import datetime, timedelta\n    from prefect import flow\n    from prefect.schedules import Interval\n\n\n    @flow(log_prints=True)\n    def my_flow(name: str = \"world\"):\n        print(f\"Hello, {name}!\")\n\n\n    if __name__ == \"__main__\":\n        my_flow.deploy(\n            name=\"my-deployment\",\n            work_pool_name=\"my-work-pool\",\n            image=\"my-registry.com/my-docker-image:my-tag\",\n            push=False,\n            # Run every 10 minutes starting from January 1, 2023\n            # at 00:00 Central Time\n            schedules=[\n                Interval(\n                    timedelta(minutes=10),\n                    anchor_date=datetime(2023, 1, 1, 0, 0),\n                    timezone=\"America/Chicago\"\n                )\n            ]\n        )\n    ```\n  </Expandable>\n\n  Learn more about schedules [here](/v3/how-to-guides/deployments/create-schedules).\n\n## Use remote code storage\n\nIn addition to storing your  code in a Docker image, Prefect also supports deploying your code to remote storage. This approach allows you to\nstore your flow code in a remote location, such as a Git repository or cloud storage service.\n\nUsing remote storage for your code has several advantages:\n\n1. Faster iterations: You can update your flow code without rebuilding Docker images.\n2. Reduced storage requirements: You don't need to store large Docker images for each code version.\n3. Flexibility: You can use different storage backends based on your needs and infrastructure.\n\nUsing an existing remote Git repository like GitHub, GitLab, or Bitbucket works really well as remote code storage because:\n\n1. Your code is already there.\n2. You can deploy to multiple environments via branches and tags.\n3. You can roll back to previous versions of your flows.\n\nTo deploy using remote storage, you'll need to specify where your code is stored by using `flow.from_source` to first load your flow code from a remote location.\n\nHere's an example of loading a flow from a Git repository and deploying it:\n\n```python git-deploy.py theme={null}\nfrom prefect import flow\n\n\nif __name__ == \"__main__\":\n    flow.from_source(\n        source=\"https://github.com/username/repository.git\",\n        entrypoint=\"path/to/your/flow.py:your_flow_function\"\n    ).deploy(\n        name=\"my-deployment\",\n        work_pool_name=\"my-work-pool\",\n    )\n```\n\nThe `source` parameter can accept a variety of remote storage options including:\n\n* Git repositories\n* S3 buckets (using the `s3://` scheme)\n* Google Cloud Storage buckets (using the `gs://` scheme)\n* Azure Blob Storage (using the `az://` scheme)\n\nThe `entrypoint` parameter is the path to the flow function within your repository combined with the name of the flow function.\n\nLearn more about remote code storage [here](/v3/deploy/infrastructure-concepts/store-flow-code/).\n\n## Set default parameters\n\nYou can set default parameters for a deployment using the `parameters` keyword argument in `flow.deploy`.\n\n```python default-parameters.py theme={null}\nfrom prefect import flow\n\n\n@flow\ndef my_flow(name: str = \"world\"):\n    print(f\"Hello, {name}!\")\n\n\nif __name__ == \"__main__\":\n    my_flow.deploy(\n        name=\"my-deployment\",\n        work_pool_name=\"my-work-pool\",\n        # Will print \"Hello, Marvin!\" by default instead of \"Hello, world!\"\n        parameters={\"name\": \"Marvin\"},\n        image=\"my-registry.com/my-docker-image:my-tag\",\n        push=False,\n    )\n```\n\nNote these parameters can still be overridden on a per-deployment basis.\n\n## Set job variables\n\nYou can set default job variables for a deployment using the `job_variables` keyword argument in `flow.deploy`.\nThe job variables provided will override the values set on the work pool.\n\n```python job-variables.py theme={null}\nimport os\nfrom prefect import flow\n\n\n@flow\ndef my_flow():\n    name = os.getenv(\"NAME\", \"world\")\n    print(f\"Hello, {name}!\")\n\n\nif __name__ == \"__main__\":\n    my_flow.deploy(\n        name=\"my-deployment\",\n        work_pool_name=\"my-work-pool\",\n        # Will print \"Hello, Marvin!\" by default instead of \"Hello, world!\"\n        job_variables={\"env\": {\"NAME\": \"Marvin\"}},\n        image=\"my-registry.com/my-docker-image:my-tag\",\n        push=False,\n    )\n```\n\nJob variables can be used to customize environment variables, resources limits, and other infrastructure options, allowing fine-grained control over your infrastructure on a per-deployment or per-flow-run basis.\nAny variable defined in the base job template of the associated work pool can be overridden by a job variable.\n\nYou can learn more about job variables [here](/v3/how-to-guides/deployments/customize-job-variables).\n\n## Deploy multiple flows\n\nTo deploy multiple flows at once, use the `deploy` function.\n\n```python multi-deploy.py theme={null}\nfrom prefect import flow, deploy\n\n\n@flow\ndef my_flow_1():\n    print(\"I'm number one!\")\n\n\n@flow\ndef my_flow_2():\n    print(\"Always second...\")\n\n\nif __name__ == \"__main__\":\n    deploy(\n        # Use the `to_deployment` method to specify configuration\n        #specific to each deployment\n        my_flow_1.to_deployment(\"my-deployment-1\"),\n        my_flow_2.to_deployment(\"my-deployment-2\"),\n\n        # Specify shared configuration for both deployments\n        image=\"my-registry.com/my-docker-image:my-tag\",\n        push=False,\n        work_pool_name=\"my-work-pool\",\n    )\n```\n\nWhen we run the above script, it will build a single Docker image for both deployments.\nThis approach offers the following benefits:\n\n* Saves time and resources by avoiding redundant image builds.\n* Simplifies management by maintaining a single image for multiple flows.\n\n## Further reading\n\n* [Work Pools](/v3/concepts/work-pools/)\n* [Store Flow Code](/v3/deploy/infrastructure-concepts/store-flow-code/)\n* [Customize Infrastructure](/v3/how-to-guides/deployments/customize-job-variables)\n* [Schedules](/v3/how-to-guides/deployments/create-schedules)\n* [Write Workflows](/v3/how-to-guides/workflows/write-and-run)",
  "content_length": 14169
}