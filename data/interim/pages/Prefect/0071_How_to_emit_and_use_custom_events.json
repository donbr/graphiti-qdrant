{
  "title": "How to emit and use custom events",
  "source_url": "https://docs-3.prefect.io/v3/advanced/use-custom-event-grammar",
  "content": "Learn how to define specific trigger conditions based on custom event grammar.\n\n## Motivating custom events\n\nImagine you are running an e-commerce platform and you want to trigger a deployment when a customer completes an order.\n\nThere might be a number of events that occur during an order on your platform, for example:\n\n* `order.created`\n* `order.item.added`\n* `order.payment-method.confirmed`\n* `order.shipping-method.added`\n* `order.complete`\n\n<Tip>\n  **Event grammar**\n\n  The above choices of event names are arbitrary. With Prefect events, you're free to select any event grammar that best\n  represents your use case.\n</Tip>\n\nIn this case, we want to trigger a deployment when a user completes an order, so our trigger should:\n\n* `expect` an `order.complete` event\n* `after` an `order.created` event\n* evaluate these conditions `for_each` user id\n\nFinally, it should pass the `user_id` as a parameter to the deployment.\n\n### Define the trigger\n\nHere's how this looks in code:\n\n```python post_order_deployment.py theme={null}\nfrom prefect import flow\nfrom prefect.events.schemas.deployment_triggers import DeploymentEventTrigger\n\norder_complete = DeploymentEventTrigger(\n    expect={\"order.complete\"},\n    after={\"order.created\"},\n    for_each={\"prefect.resource.id\"},\n    parameters={\"user_id\": \"{{ event.resource.id }}\"},\n)\n\n\n@flow(log_prints=True)\ndef post_order_complete(user_id: str):\n    print(f\"User {user_id} has completed an order -- doing stuff now\")\n\n\nif __name__ == \"__main__\":\n    post_order_complete.serve(triggers=[order_complete])\n```\n\n<Tip>\n  **Specify multiple events or resources**\n\n  The `expect` and `after` fields accept a `set` of event names, so you can specify multiple events for each condition.\n\n  Similarly, the `for_each` field accepts a `set` of resource ids.\n</Tip>\n\n### Simulate events\n\nTo simulate users causing order status events, run the following in a Python shell or script:\n\n```python simulate_events.py theme={null}\nimport time\nfrom prefect.events import emit_event\n\nuser_id_1, user_id_2 = \"123\", \"456\"\nfor event_name, user_id in [\n    (\"order.created\", user_id_1),\n    (\"order.created\", user_id_2), # other user\n    (\"order.complete\", user_id_1),\n]:\n    event = emit_event(\n        event=event_name,\n        resource={\"prefect.resource.id\": user_id},\n    )\n    time.sleep(1)\n    print(f\"{user_id} emitted {event_name}\")\n```\n\nIn the above example:\n\n* `user_id_1` creates and then completes an order, triggering a run of our deployment.\n* `user_id_2` creates an order, but no completed event is emitted so no deployment is triggered.",
  "content_length": 2578
}