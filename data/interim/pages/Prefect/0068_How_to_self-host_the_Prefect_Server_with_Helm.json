{
  "title": "How to self-host the Prefect Server with Helm",
  "source_url": "https://docs-3.prefect.io/v3/advanced/server-helm",
  "content": "Self-host your own Prefect server and connect a Prefect worker to it with Helm.\n\nYou can use Helm to manage a [self-hosted Prefect server](https://github.com/PrefectHQ/prefect-helm/tree/main/charts/prefect-server) and a [worker](https://github.com/PrefectHQ/prefect-helm/tree/main/charts/prefect-worker).\n\n## Prerequisites\n\n* A Kubernetes cluster\n* Install the [Helm CLI](https://helm.sh/docs/intro/install/)\n\n## Deploy a server with Helm\n\n<Warning>\n  Configuring ingress or publicly exposing Prefect from the cluster is business dependent and not covered in this tutorial.\n  For details on Ingress configuration, consult the [Kubernetes documentation](https://kubernetes.io/docs/concepts/services-networking/ingress/).\n</Warning>\n\n### Add the Prefect Helm repository:\n\n```bash  theme={null}\nhelm repo add prefect https://prefecthq.github.io/prefect-helm\nhelm repo update\n```\n\n### Create a namespace\n\nCreate a new namespace for this tutorial (all commands will use this namespace):\n\n```bash  theme={null}\nkubectl create namespace prefect\nkubectl config set-context --current --namespace=prefect\n```\n\n### Deploy the server\n\n<Expandable title=\"Deploy with default values\">\n  For a simple deployment using only the default values defined in the chart:\n\n  ```bash  theme={null}\n  helm install prefect-server prefect/prefect-server --namespace prefect\n  ```\n</Expandable>\n\n<Expandable title=\"Deploy with customized values to configure basic authentication\">\n  For a customized deployment, first create a `server-values.yaml` file for the server (see [values.yaml template](https://github.com/PrefectHQ/prefect-helm/blob/main/charts/prefect-server/values.yaml)):\n\n  ```yaml  theme={null}\n  server:\n    basicAuth:\n      enabled: true\n      existingSecret: server-auth-secret\n  ```\n\n  #### Create a secret for the API basic authentication username and password:\n\n  ```bash  theme={null}\n  kubectl create secret generic server-auth-secret \\\n    --namespace prefect --from-literal auth-string='admin:password123'\n  ```\n\n  #### Install the server:\n\n  ```bash  theme={null}\n  helm install prefect-server prefect/prefect-server \\\n    --namespace prefect \\\n    -f server-values.yaml\n  ```\n</Expandable>\n\nExpected output:\n\n```\nNAME: prefect-server\nLAST DEPLOYED: Tue Mar  4 09:08:07 2025\nNAMESPACE: prefect\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\nRun the following command to port-forward the UI to your localhost:\n$ kubectl --namespace prefect port-forward svc/prefect-server 4200:4200\n\nVisit http://localhost:4200 to use Prefect!\n```\n\n### Access the Prefect UI:\n\n```bash  theme={null}\nkubectl --namespace prefect port-forward svc/prefect-server 4200:4200\n```\n\nOpen `localhost:4200` in your browser. If using basic authentication, sign in with `admin:password123`.\n\n## Deploy a worker with Helm\n\nTo connect a worker to your self-hosted Prefect server in the same cluster:\n\n<Expandable title=\"Deploy with the minimum required values\">\n  Create a `worker-values.yaml` file for the worker (see [values.yaml template](https://github.com/PrefectHQ/prefect-helm/blob/main/charts/prefect-worker/values.yaml)):\n\n  ```yaml  theme={null}\n  worker:\n    apiConfig: selfHostedServer\n    config:\n      workPool: kube-test\n    selfHostedServerApiConfig:\n      apiUrl: http://prefect-server.prefect.svc.cluster.local:4200/api\n  ```\n\n  #### Install the worker:\n\n  ```bash  theme={null}\n  helm install prefect-worker prefect/prefect-worker \\\n    --namespace prefect \\\n    -f worker-values.yaml\n  ```\n</Expandable>\n\n<Expandable title=\"Deploy with customized values to configure basic authentication\">\n  Create a `worker-values.yaml` file for the worker (see [values.yaml template](https://github.com/PrefectHQ/prefect-helm/blob/main/charts/prefect-worker/values.yaml)):\n\n  ```yaml  theme={null}\n  worker:\n    apiConfig: selfHostedServer\n    config:\n      workPool: kube-test\n    selfHostedServerApiConfig:\n      apiUrl: http://prefect-server.prefect.svc.cluster.local:4200/api\n      basicAuth:\n        enabled: true\n        existingSecret: worker-auth-secret\n  ```\n\n  #### Create a secret for the API basic authentication username and password:\n\n  ```bash  theme={null}\n  kubectl create secret generic worker-auth-secret \\\n    --namespace prefect --from-literal auth-string='admin:password123'\n  ```\n\n  #### Install the worker:\n\n  ```bash  theme={null}\n  helm install prefect-worker prefect/prefect-worker \\\n    --namespace prefect \\\n    -f worker-values.yaml\n  ```\n</Expandable>\n\nExpected output:\n\n```\nRelease \"prefect-worker\" has been installed. Happy Helming!\nNAME: prefect-worker\nLAST DEPLOYED: Tue Mar  4 11:26:21 2025\nNAMESPACE: prefect\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\n```\n\n## Cleanup\n\nTo uninstall the self-hosted Prefect server and Prefect worker:\n\n```bash  theme={null}\nhelm uninstall prefect-worker\nhelm uninstall prefect-server\n```\n\n## Troubleshooting\n\n<Expandable title=\"Container creation error\">\n  If you see this error:\n\n  ```\n  Error from server (BadRequest): container \"prefect-server\" in pod \"prefect-server-7c87b7f7cf-sgqj2\" is waiting to start: CreateContainerConfigError\n  ```\n\n  Run `kubectl events` and confirm that the `authString` is correct.\n</Expandable>\n\n<Expandable title=\"Authentication error\">\n  If you see this error:\n\n  ```\n  prefect.exceptions.PrefectHTTPStatusError: Client error '401 Unauthorized' for url 'http://prefect-server.prefect.svc.cluster.local:4200/api/work_pools/kube-test'\n  Response: {'exception_message': 'Unauthorized'}\n  For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/401\n  An exception occurred.\n  ```\n\n  Ensure `basicAuth` is configured in the `worker-values.yaml` file.\n</Expandable>\n\n<Expandable title=\"Connection error\">\n  If you see this error:\n\n  ```\n  File \"/usr/local/lib/python3.11/site-packages/httpcore/_backends/anyio.py\", line 113, in connect_tcp\n    with map_exceptions(exc_map):\n  File \"/usr/local/lib/python3.11/contextlib.py\", line 158, in __exit__\n    self.gen.throw(typ, value, traceback)\n  File \"/usr/local/lib/python3.11/site-packages/httpcore/_exceptions.py\", line 14, in map_exceptions\n    raise to_exc(exc) from exc\n  httpcore.ConnectError: [Errno -2] Name or service not known\n  ```\n\n  Ensure the `PREFECT_API_URL` environment variable is properly templated by running the following command:\n\n  ```bash  theme={null}\n  helm template prefect-worker prefect/prefect-worker -f worker-values.yaml\n  ```\n\n  The URL format should look like the following:\n\n  ```\n  http://prefect-server.prefect.svc.cluster.local:4200/api\n  ```\n\n  <Note>\n    If the worker is not in the same cluster and namespace, the precise format will vary.\n  </Note>\n\n  For additional troubleshooting and configuration, review the [Prefect Worker Helm Chart](https://github.com/PrefectHQ/prefect-helm/tree/main/charts/prefect-worker).\n</Expandable>",
  "content_length": 6830
}