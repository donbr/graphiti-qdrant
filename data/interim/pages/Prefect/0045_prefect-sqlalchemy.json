{
  "title": "prefect-sqlalchemy",
  "source_url": "https://docs-3.prefect.io/integrations/prefect-sqlalchemy/index",
  "content": "# Welcome!\n\n`prefect-sqlalchemy` helps you connect to a database in your Prefect flows.\n\n## Getting started\n\n### Install `prefect-sqlalchemy`\n\nThe following command will install a version of `prefect-sqlalchemy` compatible with your installed version of `prefect`.\nIf you don't already have `prefect` installed, it will install the newest version of `prefect` as well.\n\n```bash  theme={null}\npip install \"prefect[sqlalchemy]\"\n```\n\nUpgrade to the latest versions of `prefect` and `prefect-sqlalchemy`:\n\n```bash  theme={null}\npip install -U \"prefect[sqlalchemy]\"\n```\n\n### Register newly installed block types\n\nRegister the block types in the `prefect-sqlalchemy` module to make them available for use.\n\n```bash  theme={null}\nprefect block register -m prefect_sqlalchemy\n```\n\n## Examples\n\n### Save credentials to a block\n\nTo use the `load` method on Blocks, you must have a block saved through code or saved through the UI.\n\n```python  theme={null}\nfrom prefect_sqlalchemy import SqlAlchemyConnector, ConnectionComponents, SyncDriver\n\nconnector = SqlAlchemyConnector(\n    connection_info=ConnectionComponents(\n        driver=SyncDriver.POSTGRESQL_PSYCOPG2,\n        username=\"USERNAME-PLACEHOLDER\",\n        password=\"PASSWORD-PLACEHOLDER\",\n        host=\"localhost\",\n        port=5432,\n        database=\"DATABASE-PLACEHOLDER\",\n    )\n)\n\nconnector.save(\"BLOCK_NAME-PLACEHOLDER\")\n```\n\nLoad the saved block that holds your credentials:\n\n```python  theme={null}\nfrom prefect_sqlalchemy import SqlAlchemyConnector\n\nSqlAlchemyConnector.load(\"BLOCK_NAME-PLACEHOLDER\")\n```\n\nThe required arguments depend upon the desired driver. For example, SQLite requires only the `driver` and `database` arguments:\n\n```python  theme={null}\nfrom prefect_sqlalchemy import SqlAlchemyConnector, ConnectionComponents, SyncDriver\n\nconnector = SqlAlchemyConnector(\n    connection_info=ConnectionComponents(\n        driver=SyncDriver.SQLITE_PYSQLITE,\n        database=\"DATABASE-PLACEHOLDER.db\"\n    )\n)\n\nconnector.save(\"BLOCK_NAME-PLACEHOLDER\")\n```\n\n### Work with databases in a flow\n\nTo set up a table, use the `execute` and `execute_many` methods.\n\nUse the `fetch_many` method to retrieve data in a stream until there's no more data.\n\nUse the `SqlAlchemyConnector` as a context manager, to ensure that the SQLAlchemy engine and any connected resources are closed properly after you're done with them.\n\n<Note>\n  **Async support**\n\n  `SqlAlchemyConnector`  supports async workflows. Just be sure to save, load, and use an async driver, as in the example below.\n\n  ```python  theme={null}\n  from prefect_sqlalchemy import SqlAlchemyConnector, ConnectionComponents, AsyncDriver\n\n  connector = SqlAlchemyConnector(\n      connection_info=ConnectionComponents(\n          driver=AsyncDriver.SQLITE_AIOSQLITE,\n          database=\"DATABASE-PLACEHOLDER.db\"\n      )\n  )\n\n  if __name__ == \"__main__\":\n      connector.save(\"BLOCK_NAME-PLACEHOLDER\")\n  ```\n</Note>\n\n<Tabs>\n  <Tab title=\"Sync\">\n    ```python  theme={null}\n    from prefect import flow, task\n    from prefect_sqlalchemy import SqlAlchemyConnector\n\n\n    @task\n    def setup_table(block_name: str) -> None:\n        with SqlAlchemyConnector.load(block_name) as connector:\n            connector.execute(\n                \"CREATE TABLE IF NOT EXISTS customers (name varchar, address varchar);\"\n            )\n            connector.execute(\n                \"INSERT INTO customers (name, address) VALUES (:name, :address);\",\n                parameters={\"name\": \"Marvin\", \"address\": \"Highway 42\"},\n            )\n            connector.execute_many(\n                \"INSERT INTO customers (name, address) VALUES (:name, :address);\",\n                seq_of_parameters=[\n                    {\"name\": \"Ford\", \"address\": \"Highway 42\"},\n                    {\"name\": \"Unknown\", \"address\": \"Highway 42\"},\n                ],\n            )\n\n    @task\n    def fetch_data(block_name: str) -> list:\n        all_rows = []\n        with SqlAlchemyConnector.load(block_name) as connector:\n            while True:\n                # Repeated fetch* calls using the same operation will\n                # skip re-executing and instead return the next set of results\n                new_rows = connector.fetch_many(\"SELECT * FROM customers\", size=2)\n                if len(new_rows) == 0:\n                    break\n                all_rows.append(new_rows)\n        return all_rows\n\n    @flow\n    def sqlalchemy_flow(block_name: str) -> list:\n        setup_table(block_name)\n        all_rows = fetch_data(block_name)\n        return all_rows\n\n\n    if __name__ == \"__main__\":\n        sqlalchemy_flow(\"BLOCK-NAME-PLACEHOLDER\")\n    ```\n  </Tab>\n\n  <Tab title=\"Async\">\n    ```python  theme={null}\n    from prefect import flow, task\n    from prefect_sqlalchemy import SqlAlchemyConnector\n    import asyncio\n\n\n    @task\n    async def setup_table(block_name: str) -> None:\n        async with await SqlAlchemyConnector.load(block_name) as connector:\n            await connector.execute(\n                \"CREATE TABLE IF NOT EXISTS customers (name varchar, address varchar);\"\n            )\n            await connector.execute(\n                \"INSERT INTO customers (name, address) VALUES (:name, :address);\",\n                parameters={\"name\": \"Marvin\", \"address\": \"Highway 42\"},\n            )\n            await connector.execute_many(\n                \"INSERT INTO customers (name, address) VALUES (:name, :address);\",\n                seq_of_parameters=[\n                    {\"name\": \"Ford\", \"address\": \"Highway 42\"},\n                    {\"name\": \"Unknown\", \"address\": \"Highway 42\"},\n                ],\n            )\n\n    @task\n    async def fetch_data(block_name: str) -> list:\n        all_rows = []\n        async with await SqlAlchemyConnector.load(block_name) as connector:\n            while True:\n                # Repeated fetch* calls using the same operation will\n                # skip re-executing and instead return the next set of results\n                new_rows = await connector.fetch_many(\"SELECT * FROM customers\", size=2)\n                if len(new_rows) == 0:\n                    break\n                all_rows.append(new_rows)\n        return all_rows\n\n    @flow\n    async def sqlalchemy_flow(block_name: str) -> list:\n        await setup_table(block_name)\n        all_rows = await fetch_data(block_name)\n        return all_rows\n\n\n    if __name__ == \"__main__\":\n        asyncio.run(sqlalchemy_flow(\"BLOCK-NAME-PLACEHOLDER\"))\n    ```\n  </Tab>\n</Tabs>\n\n## Resources\n\nRefer to the `prefect-sqlalchemy` [SDK documentation](https://reference.prefect.io/prefect_sqlalchemy/) to explore all the capabilities of the `prefect-sqlalchemy` library.\n\nFor assistance using SQLAlchemy, consult the [SQLAlchemy documentation](https://www.sqlalchemy.org/).",
  "content_length": 6732
}