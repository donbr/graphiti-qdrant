{
  "title": "How to apply global concurrency and rate limits",
  "source_url": "https://docs-3.prefect.io/v3/how-to-guides/workflows/global-concurrency-limits",
  "content": "Learn how to control concurrency and apply rate limits using Prefect's provided utilities.\n\nexport const API = ({name, href}) => <p>You can manage {name} with the <a href={href}>Prefect API</a>.</p>;\n\nexport const TF = ({name, href}) => <p>You can manage {name} with the <a href={href}>Terraform provider for Prefect</a>.</p>;\n\nexport const global_concurrency = {\n  cli: \"https://docs.prefect.io/v3/api-ref/cli/global-concurrency-limit\",\n  api: \"https://app.prefect.cloud/api/docs#tag/Concurrency-Limits-V2\",\n  tf: \"https://registry.terraform.io/providers/PrefectHQ/prefect/latest/docs/resources/global_concurrency_limit\"\n};\n\nexport const CLI = ({name, href}) => <p>You can manage {name} with the <a href={href}>Prefect CLI</a>.</p>;\n\nUse global concurrency limits to control how many operations run simultaneously, and rate limits to control how frequently operations can start. This guide shows you how to create, manage, and use these limits in your workflows.\n\nFor a deeper understanding of how global concurrency limits work and when to use them, see the [global concurrency limits concept page](/v3/concepts/global-concurrency-limits).\n\n## Manage global concurrency and rate limits\n\nYou can create, read, edit, and delete concurrency limits through the Prefect UI, CLI, Python SDK, Terraform, or API.\n\nWhen creating a concurrency limit, you can specify:\n\n* **Name**: How you'll reference the limit in your code (no special characters like `/`, `%`, `&`, `>`, `<`)\n* **Concurrency Limit**: Maximum number of slots available\n* **Slot Decay Per Second**: Rate at which slots are released (required for rate limiting)\n* **Active**: Whether the limit is enforced (`true`) or disabled (`false`)\n\n### Using the UI\n\nNavigate to the **Concurrency** section in the Prefect UI to create, update, and delete concurrency limits.\n\n<img src=\"https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/gcl-1.png?fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=2730ce50c5061894115a300fe25c53d1\" alt=\"Concurrency limits in the UI\" data-og-width=\"807\" width=\"807\" data-og-height=\"428\" height=\"428\" data-path=\"images/gcl-1.png\" data-optimize=\"true\" data-opv=\"3\" srcset=\"https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/gcl-1.png?w=280&fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=478e69c2aaa98038fc92d80567175a61 280w, https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/gcl-1.png?w=560&fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=3f518b8a3313decdb662ef6074753ac4 560w, https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/gcl-1.png?w=840&fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=eb7e32f970b8365970e2c1a20e5a6626 840w, https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/gcl-1.png?w=1100&fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=88b65dabe19ff407164e134b474a2142 1100w, https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/gcl-1.png?w=1650&fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=ede57dac36c3da806590bbeef789ccde 1650w, https://mintcdn.com/prefect-bd373955/61rCXJ5a7pFAZAcb/images/gcl-1.png?w=2500&fit=max&auto=format&n=61rCXJ5a7pFAZAcb&q=85&s=878f6f7d5cca25a250e275e52cbf46a8 2500w\" />\n\n### Using the CLI\n\n<CLI name=\"global concurrency\" href={global_concurrency.cli} />\n\nCreate a new concurrency limit with the `prefect gcl create` command:\n\n```bash  theme={null}\nprefect gcl create my-concurrency-limit --limit 5 --slot-decay-per-second 1.0\n```\n\nInspect a concurrency limit:\n\n```bash  theme={null}\nprefect gcl inspect my-concurrency-limit\n```\n\nUpdate a concurrency limit:\n\n```bash  theme={null}\nprefect gcl update my-concurrency-limit --limit 10\nprefect gcl update my-concurrency-limit --disable\n```\n\nDelete a concurrency limit:\n\n```bash  theme={null}\nprefect gcl delete my-concurrency-limit\nAre you sure you want to delete global concurrency limit 'my-concurrency-limit'? [y/N]: y\nDeleted global concurrency limit with name 'my-concurrency-limit'.\n```\n\nSee all available commands and options with `prefect gcl --help`.\n\n### Using Terraform\n\n<TF name=\"global concurrency\" href={global_concurrency.tf} />\n\n### Using the API\n\n<API name=\"global concurrency\" href={global_concurrency.api} />\n\n## Use the `concurrency` context manager\n\nControl concurrent operations using the `concurrency` context manager. Choose the synchronous or asynchronous version based on your code.\n\n<Tip>\n  By default, if a concurrency limit doesn't exist or lease renewal fails, a warning is logged but execution continues.\n\n  Use `strict=True` to raise an error instead. This ensures concurrency enforcement is guaranteed, useful for preventing resource exhaustion like database connection pool limits.\n</Tip>\n\n### Synchronous usage\n\n```python  theme={null}\nfrom prefect import flow, task\nfrom prefect.concurrency.sync import concurrency\nfrom prefect.futures import wait\n\n\n@task\ndef process_data(x, y):\n    with concurrency(\"database\", occupy=1):\n        return x + y\n\n\n@flow\ndef my_flow():\n    futures = []\n    for x, y in [(1, 2), (2, 3), (3, 4), (4, 5)]:\n        futures.append(process_data.submit(x, y))\n\n    wait(futures)\n\n\nif __name__ == \"__main__\":\n    my_flow()\n```\n\n### Asynchronous usage\n\n```python  theme={null}\nimport asyncio\nfrom prefect import flow, task\nfrom prefect.concurrency.asyncio import concurrency\nfrom prefect.futures import wait\n\n\n@task\nasync def process_data(x, y):\n    async with concurrency(\"database\", occupy=1):\n        return x + y\n\n\n@flow\ndef my_flow():\n    futures = []\n    for x, y in [(1, 2), (2, 3), (3, 4), (4, 5)]:\n        futures.append(process_data.submit(x, y))\n\n    wait(futures)\n\n\nif __name__ == \"__main__\":\n    asyncio.run(my_flow())\n```\n\nIn both examples, the `concurrency` context manager occupies one slot on the `database` concurrency limit. If no slots are available, execution blocks until a slot becomes available.\n\n### Using strict mode\n\nEnable strict mode to ensure errors are raised if the limit doesn't exist or if lease renewal fails:\n\n```python  theme={null}\nfrom prefect import flow, task\nfrom prefect.concurrency.sync import concurrency\n\n@task\ndef process_critical_data(x, y):\n    # strict=True ensures this task fails fast if concurrency can't be enforced\n    with concurrency(\"database\", occupy=1, strict=True):\n        return x + y\n\n@flow\ndef critical_flow():\n    process_critical_data(1, 2)\n```\n\n## Use `rate_limit`\n\nControl the frequency of operations using the `rate_limit` function.\n\n<Tip>\n  The concurrency limit must have `slot_decay_per_second` configured. Without it, `rate_limit` will fail.\n</Tip>\n\n### Synchronous usage\n\n```python  theme={null}\nfrom prefect import flow, task\nfrom prefect.concurrency.sync import rate_limit\n\n\n@task\ndef make_http_request():\n    rate_limit(\"rate-limited-api\")\n    print(\"Making an HTTP request...\")\n\n\n@flow\ndef my_flow():\n    for _ in range(10):\n        make_http_request.submit()\n\n\nif __name__ == \"__main__\":\n    my_flow()\n```\n\n### Asynchronous usage\n\n```python  theme={null}\nimport asyncio\n\nfrom prefect import flow, task\nfrom prefect.concurrency.asyncio import rate_limit\n\n\n@task\nasync def make_http_request():\n    await rate_limit(\"rate-limited-api\")\n    print(\"Making an HTTP request...\")\n\n\n@flow\ndef my_flow():\n    for _ in range(10):\n        make_http_request.submit()\n\n\nif __name__ == \"__main__\":\n    asyncio.run(my_flow())\n```\n\nThe `rate_limit` function ensures requests are made at a controlled pace based on the concurrency limit's `slot_decay_per_second` setting.\n\n## Use outside of flows\n\nYou can use `concurrency` and `rate_limit` in any Python code, not just within flows.\n\n```python  theme={null}\nimport asyncio\n\nfrom prefect.concurrency.asyncio import rate_limit\n\n\nasync def main():\n    for _ in range(10):\n        await rate_limit(\"rate-limited-api\")\n        print(\"Making an HTTP request...\")\n\n\n\nif __name__ == \"__main__\":\n    asyncio.run(main())\n```\n\n## Common patterns\n\n### Throttle task submission\n\nPrevent overwhelming downstream systems by controlling how quickly tasks are submitted:\n\n```python  theme={null}\nfrom prefect import flow, task\nfrom prefect.concurrency.sync import rate_limit\n\n\n@task\ndef my_task(i):\n    return i\n\n\n@flow\ndef my_flow():\n    for _ in range(100):\n        rate_limit(\"slow-my-flow\", occupy=1)\n        my_task.submit(1)\n\n\nif __name__ == \"__main__\":\n    my_flow()\n```\n\n### Limit database connections\n\nPrevent exhausting your database connection pool by limiting concurrent queries:\n\n```python  theme={null}\nfrom prefect import flow, task, concurrency\nfrom myproject import db\n\n@task\ndef database_query(query):\n    # Here we request a single slot on the 'database' concurrency limit. This\n    # will block in the case that all of the database connections are in use\n    # ensuring that we never exceed the maximum number of database connections.\n    with concurrency(\"database\", occupy=1):\n        result = db.execute(query)\n        return result\n\n@flow\ndef my_flow():\n    queries = [\"SELECT * FROM table1\", \"SELECT * FROM table2\", \"SELECT * FROM table3\"]\n\n    for query in queries:\n        database_query.submit(query)\n\nif __name__ == \"__main__\":\n    my_flow()\n```\n\n### Control parallel processing\n\nProcess data in controlled batches to avoid resource exhaustion:\n\n```python  theme={null}\nimport asyncio\nfrom prefect.concurrency.sync import concurrency\n\n\nasync def process_data(data):\n    print(f\"Processing: {data}\")\n    await asyncio.sleep(1)\n    return f\"Processed: {data}\"\n\n\nasync def main():\n    data_items = list(range(100))\n    processed_data = []\n\n    while data_items:\n        with concurrency(\"data-processing\", occupy=5):\n            chunk = [data_items.pop() for _ in range(5)]\n            processed_data += await asyncio.gather(\n                *[process_data(item) for item in chunk]\n            )\n\n    print(processed_data)\n\n\nif __name__ == \"__main__\":\n    asyncio.run(main())\n```\n\n## Next steps\n\nFor more information about how global concurrency limits work and when to use them versus other concurrency controls, see the [global concurrency limits concept page](/v3/concepts/global-concurrency-limits).",
  "content_length": 9996
}