{
  "title": "How to create deployment triggers",
  "source_url": "https://docs-3.prefect.io/v3/how-to-guides/automations/creating-deployment-triggers",
  "content": "Learn how to define automations that trigger deployment runs based on events.\n\n## Creating deployment triggers\n\nTo enable the simple configuration of event-driven deployments, Prefect provides **deployment triggers**â€”a shorthand for\ncreating automations that are linked to specific deployments to run them based on the presence or absence of events.\n\n<Info>\n  Deployment triggers are a special case of automations where the configured action is always running a deployment.\n</Info>\n\nTrigger definitions for deployments are supported in `prefect.yaml`, `.serve`, and `.deploy`. At deployment time,\nspecified trigger definitions create linked automations triggered by events matching your chosen\n[grammar](/v3/concepts/events/#event-grammar). Each trigger definition may include a [jinja template](https://en.wikipedia.org/wiki/Jinja_\\(template_engine\\))\nto render the triggering `event` as the `parameters` of your  deployment's flow run.\n\n### Define triggers in `prefect.yaml`\n\nYou can include a list of triggers on any deployment in a `prefect.yaml` file:\n\n```yaml  theme={null}\ndeployments:\n  - name: my-deployment\n    entrypoint: path/to/flow.py:decorated_fn\n    work_pool:\n      name: my-work-pool\n    triggers:\n      - type: event\n        enabled: true\n        match:\n          prefect.resource.id: my.external.resource\n        expect:\n          - external.resource.pinged\n        parameters:\n          param_1: \"{{ event }}\"\n```\n\n### Scheduling delayed deployment runs\n\nYou can configure deployment triggers to run after a specified delay using the `schedule_after` field. This is useful for implementing opt-out workflows or providing review windows before automated actions:\n\n```yaml  theme={null}\ndeployments:\n  - name: campaign-execution\n    entrypoint: path/to/campaign.py:execute_campaign\n    work_pool:\n      name: my-work-pool\n    triggers:\n      - type: event\n        enabled: true\n        match:\n          prefect.resource.id: marketing.campaign\n        expect:\n          - campaign.proposal.created\n        schedule_after: \"PT2H\"  # Wait 2 hours before execution\n        parameters:\n          campaign_id: \"{{ event.resource.id }}\"\n```\n\nThe `schedule_after` field accepts:\n\n* **ISO 8601 durations** (e.g., \"PT2H\" for 2 hours, \"PT30M\" for 30 minutes)\n* **Seconds as integer** (e.g., 7200 for 2 hours)\n* **Python timedelta objects** in code\n\nThis deployment creates a flow run when an `external.resource.pinged` event *and* an `external.resource.replied`\nevent have been seen from `my.external.resource`:\n\n```yaml  theme={null}\ndeployments:\n  - name: my-deployment\n    entrypoint: path/to/flow.py:decorated_fn\n    work_pool:\n      name: my-work-pool\n    triggers:\n      - type: compound\n        require: all\n        parameters:\n          param_1: \"{{ event }}\"\n        schedule_after: \"PT1H\"  # Wait 1 hour before running\n        triggers:\n          - type: event\n            match:\n              prefect.resource.id: my.external.resource\n            expect:\n              - external.resource.pinged\n          - type: event\n            match:\n              prefect.resource.id: my.external.resource\n            expect:\n              - external.resource.replied\n```\n\n### Define deployment triggers using Terraform\n\nYou can also set up a deployment trigger via Terraform resources, specifically via the `prefect_automation` [resource](https://registry.terraform.io/providers/PrefectHQ/prefect/latest/docs/resources/automation).\n\n```hcl  theme={null}\nresource \"prefect_deployment\" \"my_deployment\" {\n  name            = \"my-deployment\"\n  work_pool_name  = \"my-work-pool\"\n  work_queue_name = \"default\"\n  entrypoint      = \"path/to/flow.py:decorated_fn\"\n}\n\nresource \"prefect_automation\" \"event_trigger\" {\n  name = \"my-automation\"\n  trigger = {\n    event = {\n      posture   = \"Reactive\"\n      expect    = [\"external.resource.pinged\"]\n      threshold = 1\n      within    = 0\n    }\n  }\n  actions = [\n    {\n      type          = \"run-deployment\"\n      source        = \"selected\"\n      deployment_id = prefect_deployment.my_deployment.id\n      parameters = jsonencode({\n        \"param_1\" : \"{{ event }}\"\n      })\n    },\n  ]\n}\n\n```\n\n### Define triggers in `.serve` and `.deploy`\n\nTo create deployments with triggers in Python, the trigger types `DeploymentEventTrigger`,\n`DeploymentMetricTrigger`, `DeploymentCompoundTrigger`, and `DeploymentSequenceTrigger` can be imported\nfrom `prefect.events`:\n\n```python  theme={null}\nfrom datetime import timedelta\nfrom prefect import flow\nfrom prefect.events import DeploymentEventTrigger\n\n\n@flow(log_prints=True)\ndef decorated_fn(param_1: str):\n    print(param_1)\n\n\nif __name__==\"__main__\":\n    decorated_fn.serve(\n        name=\"my-deployment\",\n        triggers=[\n            DeploymentEventTrigger(\n                enabled=True,\n                match={\"prefect.resource.id\": \"my.external.resource\"},\n                expect=[\"external.resource.pinged\"],\n                schedule_after=timedelta(hours=1),  # Wait 1 hour before running\n                parameters={\n                    \"param_1\": \"{{ event }}\",\n                },\n            )\n        ],\n    )\n```\n\nAs with prior examples, you must supply composite triggers with a list of underlying triggers:\n\n```python  theme={null}\nfrom datetime import timedelta\nfrom prefect import flow\nfrom prefect.events import DeploymentCompoundTrigger\n\n\n@flow(log_prints=True)\ndef decorated_fn(param_1: str):\n    print(param_1)\n\n\nif __name__==\"__main__\":\n    decorated_fn.deploy(\n        name=\"my-deployment\",\n        image=\"my-image-registry/my-image:my-tag\",\n        triggers=[\n            DeploymentCompoundTrigger(\n                enabled=True,\n                name=\"my-compound-trigger\",\n                require=\"all\",\n                schedule_after=timedelta(minutes=30),  # Wait 30 minutes\n                triggers=[\n                    {\n                      \"type\": \"event\",\n                      \"match\": {\"prefect.resource.id\": \"my.external.resource\"},\n                      \"expect\": [\"external.resource.pinged\"],\n                    },\n                    {\n                      \"type\": \"event\",\n                      \"match\": {\"prefect.resource.id\": \"my.external.resource\"},\n                      \"expect\": [\"external.resource.replied\"],\n                    },\n                ],\n                parameters={\n                    \"param_1\": \"{{ event }}\",\n                },\n            )\n        ],\n        work_pool_name=\"my-work-pool\",\n    )\n```\n\n### Pass triggers to `prefect deploy`\n\nYou can pass one or more `--trigger` arguments to `prefect deploy` as either a JSON string or a\npath to a `.yaml` or `.json` file.\n\n```bash  theme={null}\n# Pass a trigger as a JSON string\nprefect deploy -n test-deployment \\\n  --trigger '{\n    \"enabled\": true,\n    \"match\": {\n      \"prefect.resource.id\": \"prefect.flow-run.*\"\n    },\n    \"expect\": [\"prefect.flow-run.Completed\"]\n  }'\n\n# Pass a trigger using a JSON/YAML file\nprefect deploy -n test-deployment --trigger triggers.yaml\nprefect deploy -n test-deployment --trigger my_stuff/triggers.json\n```\n\nFor example, a `triggers.yaml` file could have many triggers defined:\n\n```yaml  theme={null}\ntriggers:\n  - enabled: true\n    match:\n      prefect.resource.id: my.external.resource\n    expect:\n      - external.resource.pinged\n    parameters:\n      param_1: \"{{ event }}\"\n  - enabled: true\n    match:\n      prefect.resource.id: my.other.external.resource\n    expect:\n      - some.other.event\n    parameters:\n      param_1: \"{{ event }}\"\n```\n\nBoth of the above triggers would be attached to `test-deployment` after running `prefect deploy`.\n\n<Warning>\n  **Triggers passed to `prefect deploy` will override any triggers defined in `prefect.yaml`**\n\n  While you can define triggers in `prefect.yaml` for a given deployment, triggers passed to `prefect deploy`\n  take precedence over those defined in `prefect.yaml`.\n</Warning>\n\nNote that deployment triggers contribute to the total number of automations in your workspace.\n\n## Further reading\n\nFor more on the concepts behind deployment triggers, see the [Automations concepts](/v3/concepts/automations) page.",
  "content_length": 8098
}