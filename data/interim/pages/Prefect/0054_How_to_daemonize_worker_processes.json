{
  "title": "How to daemonize worker processes",
  "source_url": "https://docs-3.prefect.io/v3/advanced/daemonize-processes",
  "content": "Learn how Prefect flow deployments enable configuring flows for scheduled and remote execution with workers.\n\nWhen running workflow applications, it's helpful to create long-running processes that\nrun at startup and are resilient to failure.\n\nThis guide shows you how to set up a systemd service to create long-running Prefect processes\nthat poll for scheduled flow runs, including how to:\n\n* create a Linux user\n* install and configure Prefect\n* set up a systemd service for the Prefect worker or `.serve` process\n\n## Prerequisites\n\n* An environment with a linux operating system with [systemd](https://systemd.io/) and Python 3.10\n  or later.\n* A superuser account that can run `sudo` commands.\n* A Prefect Cloud account, or an instance of a Prefect server running on your network.\n\nIf using an [AWS t2-micro EC2 instance](https://aws.amazon.com/ec2/instance-types/t2/) with an\nAWS Linux image, you can install Python and pip with `sudo yum install -y python3 python3-pip`.\n\n## Steps\n\nA systemd service is ideal for running a long-lived process on a Linux VM or physical Linux server.\nYou will use systemd and learn how to automatically start a\n[Prefect worker](/v3/deploy/infrastructure-concepts/workers/) or\nlong-lived [`serve` process](/v3/how-to-guides/deployment_infra/run-flows-in-local-processes) when Linux starts.\nThis approach provides resilience by automatically restarting the process if it crashes.\n\n### Step 1: Add a user\n\nCreate a user account on your Linux system for the Prefect process.\nYou can run a worker or serve process as root, but it's best practice to create a dedicated user.\n\nIn a terminal, run:\n\n```bash  theme={null}\nsudo useradd -m prefect\nsudo passwd prefect\n```\n\nWhen prompted, enter a password for the `prefect` account.\n\nNext, log in to the `prefect` account by running:\n\n```bash  theme={null}\nsudo su prefect\n```\n\n### Step 2: Install Prefect\n\nRun:\n\n```bash  theme={null}\npip3 install prefect\n```\n\nThis guide assumes you are installing Prefect globally, rather than a virtual environment.\nIf running a systemd service in a virtual environment, change the ExecPath.\nFor example, if using [venv](https://docs.python.org/3/library/venv.html), change the ExecPath\nto target the `prefect` application in the `bin` subdirectory of your virtual environment.\n\nNext, set up your environment so the Prefect client knows which server to connect to.\n\nIf connecting to Prefect Cloud, follow [the instructions](v3/how-to-guides/cloud/connect-to-cloud)\nto obtain an API key, and then run the following:\n\n```bash  theme={null}\nprefect cloud login -k YOUR_API_KEY\n```\n\nWhen prompted, choose the Prefect workspace to log in to.\n\nIf connecting to a self-hosted Prefect server instance instead of a Prefect Cloud account, run the following command, substituting the IP address of your server:\n\n```bash  theme={null}\nprefect config set PREFECT_API_URL=http://your-prefect-server-IP:4200\n```\n\nRun the `exit` command to sign out of the `prefect` Linux account.\nThis command switches you back to your sudo-enabled account where you can run the commands in the\nnext section.\n\n### Step 3: Set up a systemd service\n\nSee the section below if you are setting up a Prefect worker.\nSkip to the [next section](#setting-up-a-systemd-service-for-serve) if you are setting up a\nPrefect `.serve` process.\n\n#### Setting up a systemd service for a Prefect worker\n\nMove into the `/etc/systemd/system` folder and open a file for editing.\nWe use the Vim text editor below.\n\n```bash  theme={null}\ncd /etc/systemd/system\nsudo vim my-prefect-service.service\n```\n\n```txt my-prefect-service.service theme={null}\n[Unit]\nDescription=Prefect worker\n\n[Service]\nUser=prefect\nWorkingDirectory=/home\nExecStart=prefect worker start --pool YOUR_WORK_POOL_NAME\nRestart=always\n\n[Install]\nWantedBy=multi-user.target\n```\n\nMake sure you substitute your own work pool name.\n\n#### Setting up a systemd service for `.serve`\n\nCopy your flow entrypoint Python file and any other files needed for your flow to run into the\n`/home` directory (or the directory of your choice).\n\nHere's a basic example flow:\n\n```python my_file.py theme={null}\nfrom prefect import flow\n\n\n@flow(log_prints=True)\ndef say_hi():\n    print(\"Hello!\")\n\nif __name__==\"__main__\":\n    say_hi.serve(name=\"served and daemonized deployment\")\n```\n\nTo make changes to your flow code without restarting your process, push your\ncode to git-based cloud storage (GitHub, BitBucket, GitLab) and use `flow.from_source().serve()`,\nas in the example below.\n\n```python my_remote_flow_code_file.py theme={null}\nif __name__ == \"__main__\":\n    flow.from_source(\n        source=\"https://github.com/org/repo.git\",\n        entrypoint=\"path/to/my_remote_flow_code_file.py:say_hi\",\n    ).serve(name=\"deployment-with-github-storage\")\n```\n\nMake sure you substitute your own flow code entrypoint path.\n\nIf you change the flow entrypoint parameters, you must restart the process.\n\nMove into the `/etc/systemd/system` folder and open a file for editing.\nThis example below uses Vim.\n\n```bash  theme={null}\ncd /etc/systemd/system\nsudo vim my-prefect-service.service\n```\n\n```txt my-prefect-service.service theme={null}\n[Unit]\nDescription=Prefect serve\n\n[Service]\nUser=prefect\nWorkingDirectory=/home\nExecStart=python3 my_file.py\nRestart=always\n\n[Install]\nWantedBy=multi-user.target\n```\n\n### Step 4: Save, enable, and start the service\n\nTo save the file and exit Vim, hit the escape key, type `:wq!`, then press the return key.\n\nNext, make systemd aware of your new service by running:\n\n```bash  theme={null}\nsudo systemctl daemon-reload\n```\n\nThen, enable the service by running:\n\n```bash  theme={null}\nsudo systemctl enable my-prefect-service\n```\n\nThis command ensures it runs when your system boots.\n\nNext, start the service:\n\n```bash  theme={null}\nsudo systemctl start my-prefect-service\n```\n\nRun your deployment from the UI and check the logs on the **Flow Runs** page.\n\nYou can see if your daemonized Prefect worker or serve process is running, and the\nPrefect logs with `systemctl status my-prefect-service`.\n\nYou now have a systemd service that starts when your system boots, which will restart if it ever crashes.",
  "content_length": 6131
}