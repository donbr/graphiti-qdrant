{
  "title": "triggers",
  "source_url": "https://docs-3.prefect.io/v3/api-ref/python/prefect-server-events-triggers",
  "content": "# `prefect.server.events.triggers`\n\nThe triggers consumer watches events streaming in from the event bus and decides whether\nto act on them based on the automations that users have set up.\n\n## Functions\n\n### `evaluate` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L82\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nevaluate(session: AsyncSession, trigger: EventTrigger, bucket: 'ORMAutomationBucket', now: prefect.types._datetime.DateTime, triggering_event: Optional[ReceivedEvent]) -> 'ORMAutomationBucket | None'\n```\n\nEvaluates an Automation, either triggered by a specific event or proactively\non a time interval.  Evaluating a Automation updates the associated counters for\neach automation, and will fire the associated action if it has met the threshold.\n\n### `fire` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L304\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nfire(session: AsyncSession, firing: Firing) -> None\n```\n\n### `evaluate_composite_trigger` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L315\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nevaluate_composite_trigger(session: AsyncSession, firing: Firing) -> None\n```\n\n### `act` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L400\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nact(firing: Firing) -> None\n```\n\nGiven a Automation that has been triggered, the triggering labels and event\n(if there was one), publish an action for the `actions` service to process.\n\n### `update_events_clock` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L462\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nupdate_events_clock(event: ReceivedEvent) -> None\n```\n\n### `get_events_clock` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L482\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nget_events_clock() -> Optional[float]\n```\n\n### `get_events_clock_offset` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L487\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nget_events_clock_offset() -> float\n```\n\nCalculate the current clock offset.  This takes into account both the `occurred`\nof the last event, as well as the time we *saw* the last event.  This helps to\nensure that in low volume environments, we don't end up getting huge offsets.\n\n### `reset_events_clock` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L503\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nreset_events_clock() -> None\n```\n\n### `reactive_evaluation` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L510\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nreactive_evaluation(event: ReceivedEvent, depth: int = 0) -> None\n```\n\nEvaluate all automations that may apply to this event.\n\nevent (ReceivedEvent): The event to evaluate. This object contains all the necessary information\nabout the event, including its type, associated resources, and metadata.\ndepth (int, optional): The current recursion depth. This is used to prevent infinite recursion\ndue to cyclic event dependencies. Defaults to 0 and is incremented with\neach recursive call.\n\n### `get_lost_followers` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L624\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nget_lost_followers() -> List[ReceivedEvent]\n```\n\nGet followers that have been sitting around longer than our lookback\n\n### `periodic_evaluation` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L629\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nperiodic_evaluation(now: prefect.types._datetime.DateTime) -> None\n```\n\nPeriodic tasks that should be run regularly, but not as often as every event\n\n### `evaluate_periodically` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L650\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nevaluate_periodically(periodic_granularity: timedelta) -> None\n```\n\nRuns periodic evaluation on the given interval\n\n### `find_interested_triggers` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L684\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nfind_interested_triggers(event: ReceivedEvent) -> Collection[EventTrigger]\n```\n\n### `load_automation` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L689\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nload_automation(automation: Optional[Automation]) -> None\n```\n\nLoads the given automation into memory so that it is available for evaluations\n\n### `forget_automation` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L707\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nforget_automation(automation_id: UUID) -> None\n```\n\nUnloads the given automation from memory\n\n### `automation_changed` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L715\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nautomation_changed(automation_id: UUID, event: Literal['automation__created', 'automation__updated', 'automation__deleted']) -> None\n```\n\n### `load_automations` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L730\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nload_automations(db: PrefectDBInterface, session: AsyncSession)\n```\n\nLoads all automations for the given set of accounts\n\n### `remove_buckets_exceeding_threshold` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L746\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nremove_buckets_exceeding_threshold(db: PrefectDBInterface, session: AsyncSession, trigger: EventTrigger)\n```\n\nDeletes bucket where the count has already exceeded the threshold\n\n### `read_buckets_for_automation` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L761\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nread_buckets_for_automation(db: PrefectDBInterface, session: AsyncSession, trigger: Trigger, batch_size: int = AUTOMATION_BUCKET_BATCH_SIZE) -> AsyncGenerator['ORMAutomationBucket', None]\n```\n\nYields buckets for the given automation and trigger in batches.\n\n### `read_bucket` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L795\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nread_bucket(db: PrefectDBInterface, session: AsyncSession, trigger: Trigger, bucketing_key: Tuple[str, ...]) -> Optional['ORMAutomationBucket']\n```\n\nGets the bucket this event would fall into for the given Automation, if there is\none currently\n\n### `read_bucket_by_trigger_id` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L812\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nread_bucket_by_trigger_id(db: PrefectDBInterface, session: AsyncSession, automation_id: UUID, trigger_id: UUID, bucketing_key: Tuple[str, ...]) -> 'ORMAutomationBucket | None'\n```\n\nGets the bucket this event would fall into for the given Automation, if there is\none currently\n\n### `increment_bucket` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L835\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nincrement_bucket(db: PrefectDBInterface, session: AsyncSession, bucket: 'ORMAutomationBucket', count: int, last_event: Optional[ReceivedEvent]) -> 'ORMAutomationBucket'\n```\n\nAdds the given count to the bucket, returning the new bucket\n\n### `start_new_bucket` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L886\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nstart_new_bucket(db: PrefectDBInterface, session: AsyncSession, trigger: EventTrigger, bucketing_key: Tuple[str, ...], start: prefect.types._datetime.DateTime, end: prefect.types._datetime.DateTime, count: int, triggered_at: Optional[prefect.types._datetime.DateTime] = None, last_event: Optional[ReceivedEvent] = None) -> 'ORMAutomationBucket'\n```\n\nEnsures that a bucket with the given start and end exists with the given count,\nreturning the new bucket\n\n### `ensure_bucket` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L946\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nensure_bucket(db: PrefectDBInterface, session: AsyncSession, trigger: EventTrigger, bucketing_key: Tuple[str, ...], start: prefect.types._datetime.DateTime, end: prefect.types._datetime.DateTime, last_event: Optional[ReceivedEvent], initial_count: int = 0) -> 'ORMAutomationBucket'\n```\n\nEnsures that a bucket has been started for the given automation and key,\nreturning the current bucket.  Will not modify the existing bucket.\n\n### `remove_bucket` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L999\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nremove_bucket(db: PrefectDBInterface, session: AsyncSession, bucket: 'ORMAutomationBucket')\n```\n\nRemoves the given bucket from the database\n\n### `sweep_closed_buckets` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L1013\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nsweep_closed_buckets(db: PrefectDBInterface, session: AsyncSession, older_than: prefect.types._datetime.DateTime) -> None\n```\n\n### `reset` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L1023\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nreset() -> None\n```\n\nResets the in-memory state of the service\n\n### `listen_for_automation_changes` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L1031\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nlisten_for_automation_changes() -> None\n```\n\nListens for any changes to automations via PostgreSQL NOTIFY/LISTEN,\nand applies those changes to the set of loaded automations.\n\n### `consumer` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L1100\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nconsumer(periodic_granularity: timedelta = timedelta(seconds=5)) -> AsyncGenerator[MessageHandler, None]\n```\n\nThe `triggers.consumer` processes all Events arriving on the event bus to\ndetermine if they meet the automation criteria, queuing up a corresponding\n`TriggeredAction` for the `actions` service if the automation criteria is met.\n\n### `proactive_evaluation` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L1159\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nproactive_evaluation(trigger: EventTrigger, as_of: prefect.types._datetime.DateTime) -> prefect.types._datetime.DateTime\n```\n\nThe core proactive evaluation operation for a single Automation\n\n### `evaluate_proactive_triggers` <sup><a href=\"https://github.com/PrefectHQ/prefect/blob/main/src/prefect/server/events/triggers.py#L1211\" target=\"_blank\"><Icon icon=\"github\" style=\"width: 14px; height: 14px;\" /></a></sup>\n\n```python  theme={null}\nevaluate_proactive_triggers() -> None\n```",
  "content_length": 13391
}