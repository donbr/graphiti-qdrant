{
  "title": "How to persist workflow results",
  "source_url": "https://docs-3.prefect.io/v3/advanced/results",
  "content": "Results represent the data returned by a flow or a task and enable features such as caching.\n\nResults are the bedrock of many Prefect features - most notably [transactions](/v3/develop/transactions)\nand [caching](/v3/concepts/caching) - and are foundational to the resilient execution paradigm that Prefect enables.\nAny return value from a task or a flow is a result.\nBy default these results are not persisted and no reference to them is maintained in the API.\n\nEnabling result persistence allows you to fully benefit from Prefect's orchestration features.\n\n<Tip>\n  **Turn on persistence globally by default**\n\n  The simplest way to turn on result persistence globally is through the `PREFECT_RESULTS_PERSIST_BY_DEFAULT` setting:\n\n  ```bash  theme={null}\n  prefect config set PREFECT_RESULTS_PERSIST_BY_DEFAULT=true\n  ```\n\n  See [settings](/v3/develop/settings-and-profiles) for more information on how settings are managed.\n</Tip>\n\n## Configuring result persistence\n\nThere are four categories of configuration for result persistence:\n\n* [whether to persist results at all](#enabling-result-persistence): this is configured through\n  various keyword arguments, the `PREFECT_RESULTS_PERSIST_BY_DEFAULT` setting, and the `PREFECT_TASKS_DEFAULT_PERSIST_RESULT` setting for tasks specifically.\n* [what filesystem to persist results to](#result-storage): this is configured through the `result_storage`\n  keyword and the `PREFECT_DEFAULT_RESULT_STORAGE_BLOCK` setting.\n* [how to serialize and deserialize results](#result-serialization): this is configured through\n  the `result_serializer` keyword and the `PREFECT_RESULTS_DEFAULT_SERIALIZER` setting.\n* [what filename to use](#result-filenames): this is configured through one of\n  `result_storage_key`, `cache_policy`, or `cache_key_fn`.\n\n### Default persistence configuration\n\nOnce result persistence is enabled - whether through the `PREFECT_RESULTS_PERSIST_BY_DEFAULT` setting or\nthrough any of the mechanisms [described below](#enabling-result-persistence) - Prefect's default\nresult storage configuration is activated.\n\nIf you enable result persistence and don't specify a filesystem block, your results will be stored locally.\nBy default, results are persisted to `~/.prefect/storage/`.\n\nYou can configure the location of these results through the `PREFECT_LOCAL_STORAGE_PATH` setting.\n\n```bash  theme={null}\nprefect config set PREFECT_LOCAL_STORAGE_PATH='~/.my-results/'\n```\n\n### Enabling result persistence\n\nIn addition to the `PREFECT_RESULTS_PERSIST_BY_DEFAULT` and `PREFECT_TASKS_DEFAULT_PERSIST_RESULT` settings,\nresult persistence can also be enabled or disabled on both individual flows and individual tasks.\nSpecifying a non-null value for any of the following keywords on the task decorator will enable result\npersistence for that task:\n\n* `persist_result`: a boolean that allows you to explicitly enable or disable result persistence.\n* `result_storage`: accepts either a string reference to a storage block or a storage block class that\n  specifies where results should be stored.\n* `result_storage_key`: a string that specifies the filename of the result within the task's result storage.\n* `result_serializer`: a string or serializer that configures how the data should be serialized and deserialized.\n* `cache_policy`: a [cache policy](/v3/concepts/caching#cache-policies) specifying the behavior of the task's cache.\n* `cache_key_fn`: [a function](/v3/concepts/caching#cache-key-functions) that configures a custom cache policy.\n\nSimilarly, setting `persist_result=True`, `result_storage`, or `result_serializer` on a flow will enable\npersistence for that flow.\n\n<Note>\n  **Enabling persistence on a flow enables persistence by default for its tasks**\n\n  Enabling result persistence on a flow through any of the above keywords will also enable it for all\n  tasks called within that flow by default.\n\n  Any settings *explicitly* set on a task take precedence over the flow settings.\n\n  Additionally, the `PREFECT_TASKS_DEFAULT_PERSIST_RESULT` environment variable can be used to globally control the default persistence behavior for tasks, overriding the default behavior set by a parent flow or task.\n</Note>\n\n### Result storage\n\nYou can configure the system of record for your results through the `result_storage` keyword argument.\nThis keyword accepts an instantiated [filesystem block](/v3/develop/blocks/), or a block slug. Find your blocks' slugs with `prefect block ls`.\nNote that if you want your tasks to share a common cache, your result storage should be accessible by\nthe infrastructure in which those tasks run. [Integrations](/integrations/integrations) have cloud-specific storage blocks.\nFor example, a common distributed filesystem for result storage is AWS S3.\n\nAdditionally, you can control the default persistence behavior for task results using the `default_persist_result` setting. This setting allows you to specify whether results should be persisted by default for all tasks. You can set this to `True` to enable persistence by default, or `False` to disable it. This setting can be overridden at the individual task or flow level.\n\n```python  theme={null}\nfrom prefect import flow, task\nfrom prefect_aws.s3 import S3Bucket\n\ntest_block = S3Bucket(bucket_name='test-bucket')\ntest_block.save('test-block', overwrite=True)\n\n# define three tasks\n# with different result persistence configuration\n\n@task\ndef my_task():\n    return 42\n\nunpersisted_task = my_task.with_options(persist_result=False)\nother_storage_task = my_task.with_options(result_storage=test_block)\n\n\n@flow(result_storage='s3-bucket/my-dev-block')\ndef my_flow():\n\n    # this task will use the flow's result storage\n    my_task()\n\n    # this task will not persist results at all\n    unpersisted_task()\n\n    # this task will persist results to its own bucket using a different S3 block\n    other_storage_task()\n```\n\n#### Specifying a default filesystem\n\nAlternatively, you can specify a different filesystem through the `PREFECT_DEFAULT_RESULT_STORAGE_BLOCK` setting.\nSpecifying a block document slug here will enable result persistence using that filesystem as the default.\n\nFor example:\n\n```bash  theme={null}\nprefect config set PREFECT_DEFAULT_RESULT_STORAGE_BLOCK='s3-bucket/my-prod-block'\n```\n\n<Info>\n  Note that any explicit configuration of `result_storage` on either a flow or task will override this default.\n</Info>\n\n#### Result filenames\n\nBy default, the filename of a task's result is computed based on the task's cache policy,\nwhich is typically a hash of various pieces of data and metadata.\nFor flows, the filename is a random UUID.\n\nYou can configure the filename of the result file within result storage using either:\n\n* `result_storage_key`: a templated string that can use any of the fields within `prefect.runtime` and\n  the task's individual parameter values. These templated values will be populated at runtime.\n* `cache_key_fn`: a function that accepts the task run context and its runtime parameters and returns\n  a string. See [task caching documentation](/v3/concepts/caching#cache-key-functions) for more information.\n\n<Warning>\n  If both `result_storage_key` and `cache_key_fn` are provided, only the `result_storage_key` will be used.\n</Warning>\n\nThe following example writes three different result files based on the `name` parameter passed to the task:\n\n```python  theme={null}\nfrom prefect import flow, task\n\n\n@task(result_storage_key=\"hello-{parameters[name]}.pickle\")\ndef hello_world(name: str = \"world\"):\n    return f\"hello {name}\"\n\n\n@flow\ndef my_flow():\n    hello_world()\n    hello_world(name=\"foo\")\n    hello_world(name=\"bar\")\n```\n\nIf a result exists at a given storage key in the storage location, the task will load it without running.\nTo learn more about caching mechanics in Prefect, see the [caching documentation](/v3/concepts/caching).\n\n### Result serialization\n\nYou can configure how results are serialized to storage using result serializers.\nThese can be set using the `result_serializer` keyword on both tasks and flows.\nA default value can be set using the `PREFECT_RESULTS_DEFAULT_SERIALIZER` setting, which defaults to `pickle`.\nCurrent built-in options include `\"pickle\"`, `\"json\"`, `\"compressed/pickle\"` and `\"compressed/json\"`.\n\nThe `result_serializer` accepts both a string identifier or an instance of a `ResultSerializer` class, allowing\nyou to customize serialization behavior.\n\n## Caching results in memory\n\nWhen running workflows, Prefect keeps the results of all tasks and flows in memory\nso they can be passed downstream. In some cases, it is desirable to override this behavior.\nFor example, if you are returning a large amount of data from a task, it can be costly to\nkeep it in memory for the entire duration of the flow run.\n\nFlows and tasks both include an option to drop the result from memory once the\nresult has been committed with `cache_result_in_memory`:\n\n```python  theme={null}\nfrom prefect import flow, task\n\n@flow(cache_result_in_memory=False)\ndef foo():\n    return \"pretend this is large data\"\n\n@task(cache_result_in_memory=False)\ndef bar():\n    return \"pretend this is biiiig data\"\n```",
  "content_length": 9118
}