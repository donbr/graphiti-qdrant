{
  "title": "How to limit concurrent task runs with tags",
  "source_url": "https://docs-3.prefect.io/v3/how-to-guides/workflows/tag-based-concurrency-limits",
  "content": "Prevent too many tasks from running simultaneously using tags.\n\nUse task tags to limit how many tasks can run at the same time. This is useful when tasks interact with shared resources like databases or external APIs.\n\n```python  theme={null}\nfrom prefect import flow, task\n\n@task(tags=[\"database\"])\ndef fetch_data():\n    # This task will respect the \"database\" tag's concurrency limit\n    return \"data\"\n\n@flow\ndef my_workflow():\n    fetch_data()\n```\n\nFor more details on how tag-based concurrency limits work, see the [tag-based concurrency limits concept page](/v3/concepts/tag-based-concurrency-limits).\n\n<Note>\n  As of Prefect 3.4.19, tag-based concurrency limits are backed by [global concurrency limits](/v3/concepts/global-concurrency-limits). When you create a tag-based limit, you'll see a corresponding global concurrency limit with the name `tag:{tag_name}`.\n</Note>\n\n## Set concurrency limits on tags\n\nTags without concurrency limits allow unlimited concurrent runs. Once you set a limit, only that many tasks with the tag can run simultaneously.\n\n```python  theme={null}\nfrom prefect import flow, task\n\n@task(tags=[\"database\"])\ndef query_database(query: str):\n    # Simulate database work\n    return f\"Results for {query}\"\n\n@flow\ndef data_pipeline():\n    # These will respect the \"database\" tag limit\n    query_database(\"SELECT * FROM users\")\n    query_database(\"SELECT * FROM orders\")\n    query_database(\"SELECT * FROM products\")\n```\n\n## Apply multiple tags to a task\n\nWhen a task has multiple tags, it must have available concurrency slots for **all** tags to run.\n\n```python  theme={null}\nfrom prefect import task\n\n@task(tags=[\"database\", \"analytics\"])\ndef complex_query():\n    # This task needs available slots in both \"database\" AND \"analytics\" limits\n    return \"complex results\"\n```\n\n## Configure concurrency limits\n\nYou can configure limits using the CLI, Python client, API, Terraform, or the Prefect UI.\n\n### CLI\n\n```bash  theme={null}\n# Set a limit of 10 for the \"database\" tag\nprefect concurrency-limit create database 10\n\n# View all concurrency limits\nprefect concurrency-limit ls\n\n# View details about a specific tag's limit\nprefect concurrency-limit inspect database\n\n# Delete a concurrency limit\nprefect concurrency-limit delete database\n```\n\n### Python client\n\n```python  theme={null}\nfrom prefect import get_client\n\nasync with get_client() as client:\n    # Set a concurrency limit of 10 on the \"database\" tag\n    await client.create_concurrency_limit(\n        tag=\"database\",\n        concurrency_limit=10\n    )\n\n    # Read current limit for a tag\n    limit = await client.read_concurrency_limit_by_tag(tag=\"database\")\n\n    # Delete a concurrency limit\n    await client.delete_concurrency_limit_by_tag(tag=\"database\")\n\n    # View all concurrency limits\n    limits = await client.read_concurrency_limits()\n```\n\n### API\n\n```bash  theme={null}\n# Create a concurrency limit\ncurl -X POST \"http://localhost:4200/api/concurrency_limits/\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"tag\": \"database\", \"concurrency_limit\": 10}'\n\n# Get all concurrency limits\ncurl \"http://localhost:4200/api/concurrency_limits/\"\n```\n\n### Terraform\n\n```hcl  theme={null}\nresource \"prefect_concurrency_limit\" \"database_limit\" {\n  tag               = \"database\"\n  concurrency_limit = 10\n}\n```\n\n## Configure globally\n\nWhen a task is delayed due to a concurrency limit, it will wait for a set wait time before retrying. You can set the wait time for when tasks are delayed due to concurrency limits:\n\n```bash  theme={null}\nprefect config set PREFECT_TASK_RUN_TAG_CONCURRENCY_SLOT_WAIT_SECONDS=60\n```\n\nNote: this setting needs to be set on the Prefect server, not the Prefect client.",
  "content_length": 3686
}