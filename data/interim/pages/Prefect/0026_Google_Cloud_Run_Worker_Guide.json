{
  "title": "Google Cloud Run Worker Guide",
  "source_url": "https://docs-3.prefect.io/integrations/prefect-gcp/gcp-worker-guide",
  "content": "## Why use Google Cloud Run for flow run execution?\n\nGoogle Cloud Run is a fully managed compute platform that automatically scales your containerized applications.\n\n1. Serverless architecture: Cloud Run follows a serverless architecture, which means you don't need to manage any underlying infrastructure. Google Cloud Run automatically handles the scaling and availability of your flow run infrastructure, allowing you to focus on developing and deploying your code.\n\n2. Scalability: Cloud Run can automatically scale your pipeline to handle varying workloads and traffic. It can quickly respond to increased demand and scale back down during low activity periods, ensuring efficient resource utilization.\n\n3. Integration with Google Cloud services: Google Cloud Run easily integrates with other Google Cloud services, such as Google Cloud Storage, Google Cloud Pub/Sub, and Google Cloud Build. This interoperability enables you to build end-to-end data pipelines that use a variety of services.\n\n4. Portability: Since Cloud Run uses container images, you can develop your pipelines locally using Docker and then deploy them on Google Cloud Run without significant modifications. This portability allows you to run the same pipeline in different environments.\n\n## Google Cloud Run guide\n\nAfter completing this guide, you will have:\n\n1. Created a Google Cloud Service Account\n2. Created a Prefect Work Pool\n3. Deployed a Prefect Worker as a Cloud Run Service\n4. Deployed a Flow\n5. Executed the Flow as a Google Cloud Run Job\n\n### Prerequisites\n\nBefore starting this guide, make sure you have:\n\n* A [Google Cloud Platform (GCP) account](https://cloud.google.com/gcp).\n* A project on your GCP account where you have the necessary permissions to create Cloud Run Services and Service Accounts.\n* The `gcloud` CLI installed on your local machine. You can follow Google Cloud's [installation guide](https://cloud.google.com/sdk/docs/install). If you're using Apple (or a Linux system) you can also use [Homebrew](https://formulae.brew.sh/cask/google-cloud-sdk) for installation.\n* [Docker](https://www.docker.com/get-started/) installed on your local machine.\n* A Prefect server instance. You can sign up for a forever free [Prefect Cloud Account](https://app.prefect.cloud/) or, alternatively, self-host a Prefect server.\n\n### Step 1. Create a Google Cloud service account\n\nFirst, open a terminal or command prompt on your local machine where `gcloud` is installed. If you haven't already authenticated with `gcloud`, run the following command and follow the instructions to log in to your GCP account.\n\n```bash  theme={null}\ngcloud auth login\n```\n\nNext, you'll set your project where you'd like to create the service account. Use the following command and replace `<PROJECT_ID>` with your GCP project's ID.\n\n```bash  theme={null}\ngcloud config set project <PROJECT-ID>\n```\n\nFor example, if your project's ID is `prefect-project` the command will look like this:\n\n```bash  theme={null}\ngcloud config set project prefect-project\n```\n\nNow you're ready to make the service account. To do so, you'll need to run this command:\n\n```bash  theme={null}\ngcloud iam service-accounts create <SERVICE-ACCOUNT-NAME> --display-name=\"<DISPLAY-NAME>\"\n```\n\nHere's an example of the command above which you can use which already has the service account name and display name provided. An additional option to describe the service account has also been added:\n\n```bash  theme={null}\ngcloud iam service-accounts create prefect-service-account \\\n    --description=\"service account to use for the prefect worker\" \\\n    --display-name=\"prefect-service-account\"\n```\n\nThe last step of this process is to make sure the service account has the proper permissions to execute flow runs as Cloud Run jobs.\nRun the following commands to grant the necessary permissions:\n\n```bash  theme={null}\ngcloud projects add-iam-policy-binding <PROJECT-ID> \\\n    --member=\"serviceAccount:<SERVICE-ACCOUNT-NAME>@<PROJECT-ID>.iam.gserviceaccount.com\" \\\n    --role=\"roles/iam.serviceAccountUser\"\n```\n\n```bash  theme={null}\ngcloud projects add-iam-policy-binding <PROJECT-ID> \\\n    --member=\"serviceAccount:<SERVICE-ACCOUNT-NAME>@<PROJECT-ID>.iam.gserviceaccount.com\" \\\n    --role=\"roles/run.admin\"\n```\n\n### Step 2. Create a Cloud Run work pool\n\nLet's walk through the process of creating a Cloud Run work pool.\n\n#### Fill out the work pool base job template\n\nYou can create a new work pool using the Prefect UI or CLI. The following command creates a work pool of type `cloud-run` via the CLI (you'll want to replace the `<WORK-POOL-NAME>` with the name of your work pool):\n\n```bash  theme={null}\nprefect work-pool create --type cloud-run <WORK-POOL-NAME>\n```\n\nOnce the work pool is created, find the work pool in the UI and edit it.\n\nThere are many ways to customize the base job template for the work pool. Modifying the template influences the infrastructure configuration that the worker provisions for flow runs submitted to the work pool. For this guide we are going to modify just a few of the available fields.\n\nSpecify the region for the cloud run job.\n\n<img src=\"https://mintcdn.com/prefect-bd373955/LVZNr0ZLDFWJ9-DE/images/cloud-run-work-pool-region.png?fit=max&auto=format&n=LVZNr0ZLDFWJ9-DE&q=85&s=e1861cc3e5c99b011882a246cc11e597\" alt=\"region\" data-og-width=\"461\" width=\"461\" data-og-height=\"111\" height=\"111\" data-path=\"images/cloud-run-work-pool-region.png\" data-optimize=\"true\" data-opv=\"3\" srcset=\"https://mintcdn.com/prefect-bd373955/LVZNr0ZLDFWJ9-DE/images/cloud-run-work-pool-region.png?w=280&fit=max&auto=format&n=LVZNr0ZLDFWJ9-DE&q=85&s=d9021b8bb318477876894b43bca0ea06 280w, https://mintcdn.com/prefect-bd373955/LVZNr0ZLDFWJ9-DE/images/cloud-run-work-pool-region.png?w=560&fit=max&auto=format&n=LVZNr0ZLDFWJ9-DE&q=85&s=a97dc4dd4379a0ed8d702a44eb991e10 560w, https://mintcdn.com/prefect-bd373955/LVZNr0ZLDFWJ9-DE/images/cloud-run-work-pool-region.png?w=840&fit=max&auto=format&n=LVZNr0ZLDFWJ9-DE&q=85&s=424169eb3bfba32e5751ffdbb0b8cbc6 840w, https://mintcdn.com/prefect-bd373955/LVZNr0ZLDFWJ9-DE/images/cloud-run-work-pool-region.png?w=1100&fit=max&auto=format&n=LVZNr0ZLDFWJ9-DE&q=85&s=7784ffebdd8a5e9caaa0c15717016e9d 1100w, https://mintcdn.com/prefect-bd373955/LVZNr0ZLDFWJ9-DE/images/cloud-run-work-pool-region.png?w=1650&fit=max&auto=format&n=LVZNr0ZLDFWJ9-DE&q=85&s=7e2a0846b584bcfd3682bc47765c105b 1650w, https://mintcdn.com/prefect-bd373955/LVZNr0ZLDFWJ9-DE/images/cloud-run-work-pool-region.png?w=2500&fit=max&auto=format&n=LVZNr0ZLDFWJ9-DE&q=85&s=fc292a690bee4b17fd7f58d1b1c38940 2500w\" />\n\nSave the name of the service account created in first step of this guide.\n\n<img src=\"https://mintcdn.com/prefect-bd373955/LVZNr0ZLDFWJ9-DE/images/cloud-run-work-pool-service-account-name.png?fit=max&auto=format&n=LVZNr0ZLDFWJ9-DE&q=85&s=f5c7ec0746ae7f5a2756eec666d83f61\" alt=\"name\" data-og-width=\"1225\" width=\"1225\" data-og-height=\"124\" height=\"124\" data-path=\"images/cloud-run-work-pool-service-account-name.png\" data-optimize=\"true\" data-opv=\"3\" srcset=\"https://mintcdn.com/prefect-bd373955/LVZNr0ZLDFWJ9-DE/images/cloud-run-work-pool-service-account-name.png?w=280&fit=max&auto=format&n=LVZNr0ZLDFWJ9-DE&q=85&s=2188b818a427bb67a9f691abb54eda1e 280w, https://mintcdn.com/prefect-bd373955/LVZNr0ZLDFWJ9-DE/images/cloud-run-work-pool-service-account-name.png?w=560&fit=max&auto=format&n=LVZNr0ZLDFWJ9-DE&q=85&s=cf74c609544f4bc1395ea893d541390b 560w, https://mintcdn.com/prefect-bd373955/LVZNr0ZLDFWJ9-DE/images/cloud-run-work-pool-service-account-name.png?w=840&fit=max&auto=format&n=LVZNr0ZLDFWJ9-DE&q=85&s=ce35cfe3a5c3c5e4cb4c394b90dd1bd7 840w, https://mintcdn.com/prefect-bd373955/LVZNr0ZLDFWJ9-DE/images/cloud-run-work-pool-service-account-name.png?w=1100&fit=max&auto=format&n=LVZNr0ZLDFWJ9-DE&q=85&s=c77fb3616291a1bf13a0d03660488be1 1100w, https://mintcdn.com/prefect-bd373955/LVZNr0ZLDFWJ9-DE/images/cloud-run-work-pool-service-account-name.png?w=1650&fit=max&auto=format&n=LVZNr0ZLDFWJ9-DE&q=85&s=71952a120cdb6e59c49f697e8a08ca20 1650w, https://mintcdn.com/prefect-bd373955/LVZNr0ZLDFWJ9-DE/images/cloud-run-work-pool-service-account-name.png?w=2500&fit=max&auto=format&n=LVZNr0ZLDFWJ9-DE&q=85&s=3ff6812333cbc505b1aadb8b046fcb08 2500w\" />\n\nYour work pool is now ready to receive scheduled flow runs!\n\n### Step 3. Deploy a Cloud Run worker\n\nNow you can launch a Cloud Run service to host the Cloud Run worker. This worker will poll the work pool that you created in the previous step.\n\nNavigate back to your terminal and run the following commands to set your Prefect API key and URL as environment variables.\nBe sure to replace `<ACCOUNT-ID>` and `<WORKSPACE-ID>` with your Prefect account and workspace IDs (both will be available in the URL of the UI when previewing the workspace dashboard).\nYou'll want to replace `<YOUR-API-KEY>` with an active API key as well.\n\n```bash  theme={null}\nexport PREFECT_API_URL='https://api.prefect.cloud/api/accounts/<ACCOUNT-ID>/workspaces/<WORKSPACE-ID>'\nexport PREFECT_API_KEY='<YOUR-API-KEY>'\n```\n\nOnce those variables are set, run the following shell command to deploy your worker as a service.\nDon't forget to replace `<YOUR-SERVICE-ACCOUNT-NAME>` with the name of the service account you created in the first step of this guide, and replace `<WORK-POOL-NAME>` with the name of the work pool you created in the second step.\n\n```bash  theme={null}\ngcloud run deploy prefect-worker --image=prefecthq/prefect:3-latest \\\n--set-env-vars PREFECT_API_URL=$PREFECT_API_URL,PREFECT_API_KEY=$PREFECT_API_KEY \\\n--service-account <YOUR-SERVICE-ACCOUNT-NAME> \\\n--no-cpu-throttling \\\n--min-instances 1 \\\n--startup-probe httpGet.port=8080,httpGet.path=/health,initialDelaySeconds=100,periodSeconds=20,timeoutSeconds=20 \\\n--args \"prefect\",\"worker\",\"start\",\"--install-policy\",\"always\",\"--with-healthcheck\",\"-p\",\"<WORK-POOL-NAME>\",\"-t\",\"cloud-run\"\n```\n\nAfter running this command, you'll be prompted to specify a region. Choose the same region that you selected when creating the Cloud Run work pool in the second step of this guide.\nThe next prompt will ask if you'd like to allow unauthenticated invocations to your worker. For this guide, you can select \"No\".\n\nAfter a few seconds, you'll be able to see your new `prefect-worker` service by navigating to the Cloud Run page of your Google Cloud console. Additionally, you should be able to see a record of this worker in the Prefect UI on the work pool's page by navigating to the `Worker` tab.\nLet's not leave our worker hanging, it's time to give it a job.\n\n### Step 4. Deploy a flow\n\nLet's prepare a flow to run as a Cloud Run job. In this section of the guide, we'll \"bake\" our code into a Docker image, and push that image to Google Artifact Registry.\n\n### Create a registry\n\nLet's create a docker repository in your Google Artifact Registry to host your custom image. If you already have a registry, and are authenticated to it, skip ahead to the *Write a flow* section.\n\nThe following command creates a repository using the gcloud CLI. You'll want to replace the `<REPOSITORY-NAME>` with your own value. :\n\n```bash  theme={null}\ngcloud artifacts repositories create <REPOSITORY-NAME> \\\n--repository-format=docker --location=us\n```\n\nNow you can authenticate to artifact registry:\n\n```bash  theme={null}\ngcloud auth configure-docker us-docker.pkg.dev\n```\n\n### Write a flow\n\nFirst, create a new directory. This will serve as the root of your project's repository. Within the directory, create a sub-directory called `flows`.\nNavigate to the `flows` subdirectory and create a new file for your flow. Feel free to write your own flow, but here's a ready-made one for your convenience:\n\n```python  theme={null}\nimport httpx\nfrom prefect import flow, task\nfrom prefect.artifacts import create_markdown_artifact\n\n@task\ndef mark_it_down(temp):\n    markdown_report = f\"\"\"# Weather Report\n## Recent weather\n\n| Time      | Temperature |\n| :-------- | ----------: |\n| Now       |      {temp} |\n| In 1 hour |  {temp + 2} |\n\"\"\"\n    create_markdown_artifact(\n        key=\"weather-report\",\n        markdown=markdown_report,\n        description=\"Very scientific weather report\",\n    )\n\n\n@flow\ndef fetch_weather(lat: float, lon: float):\n    base_url = \"https://api.open-meteo.com/v1/forecast/\"\n    weather = httpx.get(\n        base_url,\n        params=dict(latitude=lat, longitude=lon, hourly=\"temperature_2m\"),\n    )\n    most_recent_temp = float(weather.json()[\"hourly\"][\"temperature_2m\"][0])\n    mark_it_down(most_recent_temp)\n\n\nif __name__ == \"__main__\":\n    fetch_weather(38.9, -77.0)\n```\n\nIn the remainder of this guide, this script will be referred to as `weather_flow.py`, but you can name yours whatever you'd like.\n\n#### Creating a `prefect.yaml` file\n\nNow we're ready to make a `prefect.yaml` file, which will be responsible for managing the deployments of this repository.\n**Navigate back to the root of your directory**, and run the following command to create a `prefect.yaml` file using Prefect's docker deployment recipe.\n\n```bash  theme={null}\nprefect init --recipe docker\n```\n\nYou'll receive a prompt to put in values for the image name and tag. Since we will be pushing the image to Google Artifact Registry, the name of your image should be prefixed with the path to the docker repository you created within the registry. For example: `us-docker.pkg.dev/<PROJECT-ID>/<REPOSITORY-NAME>/`. You'll want to replace `<PROJECT-ID>` with the ID of your project in GCP. This should match the ID of the project you used in first step of this guide. Here is an example of what this could look like:\n\n```bash  theme={null}\nimage_name: us-docker.pkg.dev/prefect-project/my-artifact-registry/gcp-weather-image\ntag: latest\n```\n\nAt this point, there will be a new `prefect.yaml` file available at the root of your project. The contents will look similar to the example below, however, we've added in a combination of YAML templating options and Prefect deployment actions to build out a simple CI/CD process. Feel free to copy the contents and paste them in your prefect.yaml:\n\n```yaml  theme={null}\n# Welcome to your prefect.yaml file! You can you this file for storing and managing\n# configuration for deploying your flows. We recommend committing this file to source\n# control along with your flow code.\n\n# Generic metadata about this project\nname: <WORKING-DIRECTORY>\nprefect-version: 3.0.0\n\n# build section allows you to manage and build docker image\nbuild:\n- prefect_docker.deployments.steps.build_docker_image:\n    id: build_image\n    requires: prefect-docker>=0.3.1\n    image_name: <PATH-TO-ARTIFACT-REGISTRY>/gcp-weather-image\n    tag: latest\n    dockerfile: auto\n    platform: linux/amd64\n\n# push section allows you to manage if and how this project is uploaded to remote locations\npush:\n- prefect_docker.deployments.steps.push_docker_image:\n    requires: prefect-docker>=0.3.1\n    image_name: '{{ build_image.image_name }}'\n    tag: '{{ build_image.tag }}'\n\n# pull section allows you to provide instructions for cloning this project in remote locations\npull:\n- prefect.deployments.steps.set_working_directory:\n    directory: /opt/prefect/<WORKING-DIRECTORY>\n\n# the deployments section allows you to provide configuration for deploying flows\ndeployments:\n- name: gcp-weather-deploy\n  version: null\n  tags: []\n  description: null\n  schedule: {}\n  flow_name: null\n  entrypoint: flows/weather_flow.py:fetch_weather\n  parameters:\n    lat: 14.5994\n    lon: 28.6731\n  work_pool:\n    name: my-cloud-run-pool\n    work_queue_name: default\n    job_variables:\n      image: '{{ build_image.image }}'\n```\n\n<Tip>\n  After copying the example above, don't forget to replace `<WORKING-DIRECTORY>` with the name of the directory where your flow folder and `prefect.yaml` live. You'll also need to replace `<PATH-TO-ARTIFACT-REGISTRY>` with the path to the Docker repository in your Google Artifact Registry.\n</Tip>\n\nTo get a better understanding of the different components of the `prefect.yaml` file above and what they do, feel free to read this next section. Otherwise, you can skip ahead to *Flow Deployment*.\n\nIn the `build` section of the `prefect.yaml` the following step is executed at deployment build time:\n\n1. `prefect_docker.deployments.steps.build_docker_image` : builds a Docker image automatically which uses the name and tag chosen previously.\n\n<Warning>\n  If you are using an ARM-based chip (such as an M1 or M2 Mac), you'll want to ensure that you add `platform: linux/amd64` to your `build_docker_image` step to ensure that your docker image uses an AMD architecture. For example:\n\n  ```yaml  theme={null}\n  - prefect_docker.deployments.steps.build_docker_image:\n  id: build_image\n  requires: prefect-docker>=0.3.1\n  image_name: us-docker.pkg.dev/prefect-project/my-docker-repository/gcp-weather-image\n  tag: latest\n  dockerfile: auto\n  platform: linux/amd64\n  ```\n</Warning>\n\nThe `push` section sends the Docker image to the Docker repository in your Google Artifact Registry, so that it can be easily accessed by the worker for flow run execution.\n\nThe `pull` section sets the working directory for the process prior to importing your flow.\n\nIn the `deployments` section of the `prefect.yaml` file above, you'll see that there is a deployment declaration named `gcp-weather-deploy`. Within the declaration, the entrypoint for the flow is specified along with some default parameters which will be passed to the flow at runtime. Last but not least, the name of the work pool that we created in step 2 of this guide is specified.\n\n#### Flow deployment\n\nOnce you're happy with the specifications in the `prefect.yaml` file, run the following command in the terminal to deploy your flow:\n\n```bash  theme={null}\nprefect deploy --name gcp-weather-deploy\n```\n\nOnce the flow is deployed to Prefect Cloud or your local Prefect Server, it's time to queue up a flow run!\n\n### Step 5. Flow execution\n\nFind your deployment in the UI, and hit the *Quick Run* button.\nYou have now successfully submitted a flow run to your Cloud Run worker!\nIf you used the flow script provided in this guide, check the *Artifacts* tab for the flow run once it completes.\nYou'll have a nice little weather report waiting for you there. Hope your day is a sunny one!\n\n### Recap and next steps\n\nCongratulations on completing this guide! Looking back on our journey, you have:\n\n1. Created a Google Cloud service account\n2. Created a Cloud Run work pool\n3. Deployed a Cloud Run worker\n4. Deployed a flow\n5. Executed a flow\n\nFor next steps, take a look at some of the other [work pools](/v3/how-to-guides/deployment_infra/serverless) Prefect has to offer.\n\nThe world is your oyster ðŸ¦ªâœ¨.",
  "content_length": 18613
}