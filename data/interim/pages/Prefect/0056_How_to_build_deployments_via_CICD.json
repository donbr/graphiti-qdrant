{
  "title": "How to build deployments via CI/CD",
  "source_url": "https://docs-3.prefect.io/v3/advanced/deploy-ci-cd",
  "content": "CI/CD resources for working with Prefect.\n\nexport const home = {\n  tf: \"https://registry.terraform.io/providers/PrefectHQ/prefect/latest/docs/guides/getting-started\",\n  cli: \"https://docs.prefect.io/v3/api-ref/cli/index\",\n  api: \"https://app.prefect.cloud/api/docs\",\n  helm: \"https://github.com/PrefectHQ/prefect-helm/tree/main/charts\"\n};\n\nexport const TF = ({name, href}) => <p>You can manage {name} with the <a href={href}>Terraform provider for Prefect</a>.</p>;\n\nMany organizations deploy Prefect workflows through their CI/CD process.\nEach organization has their own unique CI/CD setup, but a common pattern is to use CI/CD to manage\nPrefect [deployments](/v3/concepts/deployments).\nCombining Prefect's deployment features with CI/CD tools enables efficient management of flow code\nupdates, scheduling changes, and container builds.\nThis guide uses [GitHub Actions](https://docs.github.com/en/actions) to implement a CI/CD process,\nbut these concepts are generally applicable across many CI/CD tools.\n\nNote that Prefect's primary ways for creating deployments, a `.deploy` flow method or a `prefect.yaml`\nconfiguration file, are both designed for building and pushing images to a Docker registry.\n\n## Get started with GitHub Actions and Prefect\n\nIn this example, you'll write a GitHub Actions workflow that runs each time you push to your repository's\n`main` branch. This workflow builds and pushes a Docker image containing your flow code to Docker Hub, then deploys the flow to Prefect Cloud.\n\n### Repository secrets\n\nYour CI/CD process must be able to authenticate with Prefect to deploy flows.\n\nDeploy flows securely and non-interactively in your CI/CD process by saving your `PREFECT_API_URL` and\n`PREFECT_API_KEY` [as secrets in your repository's settings](https://docs.github.com/en/actions/security-guides/using-secrets-in-github-actions). This allows them to be accessed in your CI/CD runner's environment without exposing them in any scripts or configuration files.\n\nIn this scenario, deploying flows involves building and pushing Docker images, so add `DOCKER_USERNAME`\nand `DOCKER_PASSWORD` as secrets to your repository as well.\n\nCreate secrets for GitHub Actions in your repository under\n**Settings -> Secrets and variables -> Actions -> New repository secret**:\n\n<img src=\"https://mintcdn.com/prefect-bd373955/rm4-_dTLtkmSX6eG/v3/img/guides/github-secrets.png?fit=max&auto=format&n=rm4-_dTLtkmSX6eG&q=85&s=9c199882e6a271c5f2bc53e0b0e93c79\" alt=\"Creating a GitHub Actions secret\" data-og-width=\"1371\" width=\"1371\" data-og-height=\"913\" height=\"913\" data-path=\"v3/img/guides/github-secrets.png\" data-optimize=\"true\" data-opv=\"3\" srcset=\"https://mintcdn.com/prefect-bd373955/rm4-_dTLtkmSX6eG/v3/img/guides/github-secrets.png?w=280&fit=max&auto=format&n=rm4-_dTLtkmSX6eG&q=85&s=bddd9852db03e557328fc7ecd6a4c800 280w, https://mintcdn.com/prefect-bd373955/rm4-_dTLtkmSX6eG/v3/img/guides/github-secrets.png?w=560&fit=max&auto=format&n=rm4-_dTLtkmSX6eG&q=85&s=6d11d1041d5e4eb8fb3f628e3eedbafa 560w, https://mintcdn.com/prefect-bd373955/rm4-_dTLtkmSX6eG/v3/img/guides/github-secrets.png?w=840&fit=max&auto=format&n=rm4-_dTLtkmSX6eG&q=85&s=6c23a0008c532b9ba97b3ee31bd8f7ad 840w, https://mintcdn.com/prefect-bd373955/rm4-_dTLtkmSX6eG/v3/img/guides/github-secrets.png?w=1100&fit=max&auto=format&n=rm4-_dTLtkmSX6eG&q=85&s=eff31a6b7c3c2a6055955aca8ad6cab2 1100w, https://mintcdn.com/prefect-bd373955/rm4-_dTLtkmSX6eG/v3/img/guides/github-secrets.png?w=1650&fit=max&auto=format&n=rm4-_dTLtkmSX6eG&q=85&s=b78f26f760326592c5aea8c79cfa113f 1650w, https://mintcdn.com/prefect-bd373955/rm4-_dTLtkmSX6eG/v3/img/guides/github-secrets.png?w=2500&fit=max&auto=format&n=rm4-_dTLtkmSX6eG&q=85&s=dd3a00c3ac73adb0ea664140fd3fddc3 2500w\" />\n\n### Write a GitHub workflow\n\nTo deploy your flow through GitHub Actions, you need a workflow YAML file. GitHub looks for workflow\nYAML files in the `.github/workflows/` directory in the root of your repository. In their simplest form,\nGitHub workflow files are made up of triggers and jobs.\n\nThe `on:` trigger is set to run the workflow each time a push occurs on the `main` branch of the repository.\n\nThe `deploy` job is comprised of four `steps`:\n\n* **`Checkout`** clones your repository into the GitHub Actions runner so you can reference files or\n  run scripts from your repository in later steps.\n* **`Log in to Docker Hub`** authenticates to DockerHub so your image can be pushed to the Docker\n  registry in your DockerHub account. [docker/login-action](https://github.com/docker/login-action) is an\n  existing GitHub action maintained by Docker. `with:` passes values into the Action, similar to passing\n  parameters to a function.\n* **`Setup Python`** installs your selected version of Python.\n* **`Prefect Deploy`** installs the dependencies used in your flow, then deploys your flow. `env:` makes\n  the `PREFECT_API_KEY` and `PREFECT_API_URL` secrets from your repository available as environment variables during this step's execution.\n\nFor reference, the examples below live in their respective branches of\n[this repository](https://github.com/prefecthq/cicd-example).\n\n<Tabs>\n  <Tab title=\".deploy\">\n    ```\n    .\n    | -- .github/\n    |   |-- workflows/\n    |       |-- deploy-prefect-flow.yaml\n    |-- flow.py\n    |-- requirements.txt\n    ```\n\n    `flow.py`\n\n    ```python  theme={null}\n    from prefect import flow\n\n    @flow(log_prints=True)\n    def hello():\n      print(\"Hello!\")\n\n    if __name__ == \"__main__\":\n        hello.deploy(\n            name=\"my-deployment\",\n            work_pool_name=\"my-work-pool\",\n            image=\"my_registry/my_image:my_image_tag\",\n        )\n    ```\n\n    `.github/workflows/deploy-prefect-flow.yaml`\n\n    ```yaml  theme={null}\n    name: Deploy Prefect flow\n\n    on:\n      push:\n        branches:\n          - main\n\n    jobs:\n      deploy:\n        name: Deploy\n        runs-on: ubuntu-latest\n\n        steps:\n          - name: Checkout\n            uses: actions/checkout@v4\n\n          - name: Log in to Docker Hub\n            uses: docker/login-action@v3\n            with:\n              username: ${{ secrets.DOCKER_USERNAME }}\n              password: ${{ secrets.DOCKER_PASSWORD }}\n\n          - name: Setup Python\n            uses: actions/setup-python@v5\n            with:\n              python-version: \"3.12\"\n\n          - name: Prefect Deploy\n            env:\n              PREFECT_API_KEY: ${{ secrets.PREFECT_API_KEY }}\n              PREFECT_API_URL: ${{ secrets.PREFECT_API_URL }}\n            run: |\n              pip install -r requirements.txt\n              python flow.py\n    ```\n  </Tab>\n\n  <Tab title=\"prefect.yaml\">\n    ```\n    .\n    |-- .github/\n    |   |-- workflows/\n    |       |-- deploy-prefect-flow.yaml\n    |-- flow.py\n    |-- prefect.yaml\n    |-- requirements.txt\n    ```\n\n    `flow.py`\n\n    ```python  theme={null}\n    from prefect import flow\n\n    @flow(log_prints=True)\n    def hello():\n      print(\"Hello!\")\n    ```\n\n    `prefect.yaml`\n\n    ```yaml  theme={null}\n    name: cicd-example\n    prefect-version: 3.0.0\n\n    build:\n      - prefect_docker.deployments.steps.build_docker_image:\n          id: build-image\n          requires: prefect-docker>=0.3.1\n          image_name: my_registry/my_image\n          tag: my_image_tag\n          dockerfile: auto\n\n    push:\n      - prefect_docker.deployments.steps.push_docker_image:\n          requires: prefect-docker>=0.3.1\n          image_name: \"{{ build-image.image_name }}\"\n          tag: \"{{ build-image.tag }}\"\n\n    pull: null\n\n    deployments:\n      - name: my-deployment\n        entrypoint: flow.py:hello\n        work_pool:\n          name: my-work-pool\n          work_queue_name: default\n          job_variables:\n            image: \"{{ build-image.image }}\"\n    ```\n\n    `.github/workflows/deploy-prefect-flow.yaml`\n\n    ```yaml  theme={null}\n    name: Deploy Prefect flow\n\n    on:\n      push:\n        branches:\n          - main\n\n    jobs:\n      deploy:\n        name: Deploy\n        runs-on: ubuntu-latest\n\n        steps:\n          - name: Checkout\n            uses: actions/checkout@v4\n\n          - name: Log in to Docker Hub\n            uses: docker/login-action@v3\n            with:\n              username: ${{ secrets.DOCKER_USERNAME }}\n              password: ${{ secrets.DOCKER_PASSWORD }}\n\n          - name: Setup Python\n            uses: actions/setup-python@v5\n            with:\n              python-version: \"3.12\"\n\n          - name: Prefect Deploy\n            env:\n              PREFECT_API_KEY: ${{ secrets.PREFECT_API_KEY }}\n              PREFECT_API_URL: ${{ secrets.PREFECT_API_URL }}\n            run: |\n              pip install -r requirements.txt\n              prefect deploy -n my-deployment\n    ```\n  </Tab>\n</Tabs>\n\n### Run a GitHub workflow\n\nAfter pushing commits to your repository, GitHub automatically triggers a run of your workflow.\nMonitor the status of running and completed workflows from the **Actions** tab of your repository.\n\n<img src=\"https://mintcdn.com/prefect-bd373955/rm4-_dTLtkmSX6eG/v3/img/guides/github-actions-trigger.png?fit=max&auto=format&n=rm4-_dTLtkmSX6eG&q=85&s=4fd92d92c5163118467f66fd058d6c7e\" alt=\"A GitHub Action triggered via push\" data-og-width=\"1032\" width=\"1032\" data-og-height=\"575\" height=\"575\" data-path=\"v3/img/guides/github-actions-trigger.png\" data-optimize=\"true\" data-opv=\"3\" srcset=\"https://mintcdn.com/prefect-bd373955/rm4-_dTLtkmSX6eG/v3/img/guides/github-actions-trigger.png?w=280&fit=max&auto=format&n=rm4-_dTLtkmSX6eG&q=85&s=7bd6e6b168958f01d33b1a5148d4f684 280w, https://mintcdn.com/prefect-bd373955/rm4-_dTLtkmSX6eG/v3/img/guides/github-actions-trigger.png?w=560&fit=max&auto=format&n=rm4-_dTLtkmSX6eG&q=85&s=04e46192e4192e5a3f2668168c51bd80 560w, https://mintcdn.com/prefect-bd373955/rm4-_dTLtkmSX6eG/v3/img/guides/github-actions-trigger.png?w=840&fit=max&auto=format&n=rm4-_dTLtkmSX6eG&q=85&s=141771bde52862880279aa61ea6674b5 840w, https://mintcdn.com/prefect-bd373955/rm4-_dTLtkmSX6eG/v3/img/guides/github-actions-trigger.png?w=1100&fit=max&auto=format&n=rm4-_dTLtkmSX6eG&q=85&s=3280c601ce39a98d58a735a98cf31258 1100w, https://mintcdn.com/prefect-bd373955/rm4-_dTLtkmSX6eG/v3/img/guides/github-actions-trigger.png?w=1650&fit=max&auto=format&n=rm4-_dTLtkmSX6eG&q=85&s=2db36865dd44e09997f96e8f6c2804cc 1650w, https://mintcdn.com/prefect-bd373955/rm4-_dTLtkmSX6eG/v3/img/guides/github-actions-trigger.png?w=2500&fit=max&auto=format&n=rm4-_dTLtkmSX6eG&q=85&s=9a710f395b98db2a4a52575661a0c556 2500w\" />\n\nView the logs from each workflow step as they run. The `Prefect Deploy` step includes output about\nyour image build and push, and the creation/update of your deployment.\n\n```bash  theme={null}\nSuccessfully built image '***/cicd-example:latest'\n\nSuccessfully pushed image '***/cicd-example:latest'\n\nSuccessfully created/updated all deployments!\n\n                Deployments\n|-----------------------------------------|\n| Name                | Status    Details |\n|---------------------|---------|---------|\n| hello/my-deployment | applied |         |\n|-----------------------------------------|\n\n```\n\n## Advanced example\n\nIn more complex scenarios, CI/CD processes often need to accommodate several additional\nconsiderations to enable a smooth development workflow:\n\n* Making code available in different environments as it advances through stages of development\n* Handling independent deployment of distinct groupings of work, as in a monorepo\n* Efficiently using build time to avoid repeated work\n\nThis [example repository](https://github.com/prefecthq/cicd-example-workspaces) addresses each of these\nconsiderations with a combination of Prefect's and GitHub's capabilities.\n\n### Deploy to multiple workspaces\n\nThe deployment processes to run are automatically selected when changes are pushed, depending on\ntwo conditions:\n\n```yaml  theme={null}\non:\n  push:\n    branches:\n      - stg\n      - main\n    paths:\n      - \"project_1/**\"\n```\n\n* **`branches:`** - which branch has changed. This ultimately selects which Prefect workspace a\n  deployment is created or updated in. In this example, changes on the `stg` branch deploy flows to a\n  staging workspace, and changes on the `main` branch deploy flows to a production workspace.\n* **`paths:`** - which project folders' files have changed. Since each project folder contains its own flows,\n  dependencies, and `prefect.yaml`, it represents a complete set of logic and configuration that can deploy\n  independently. Each project in this repository gets its own GitHub Actions workflow YAML file.\n\nThe `prefect.yaml` file in each project folder depends on environment variables dictated by the\nselected job in each CI/CD workflow; enabling external code storage for Prefect deployments that is clearly\nseparated across projects and environments.\n\n```\n  .\n  |--- cicd-example-workspaces-prod  # production bucket\n  |   |--- project_1\n  |   |---project_2\n  |---cicd-example-workspaces-stg  # staging bucket\n      |--- project_1\n      |---project_2\n```\n\nDeployments in this example use S3 for code storage. So it's important that push steps place flow files\nin separate locations depending upon their respective environment and projectâ€”so no deployment overwrites another\ndeployment's files.\n\n### Caching build dependencies\n\nSince building Docker images and installing Python dependencies are essential parts of the deployment process,\nit's useful to rely on caching to skip repeated build steps.\n\nThe `setup-python` action offers [caching options](https://github.com/actions/setup-python#caching-packages-dependencies)\nso Python packages do not have to be downloaded on repeat workflow runs.\n\n```yaml  theme={null}\n- name: Setup Python\n  uses: actions/setup-python@v5\n  with:\n    python-version: \"3.12\"\n    cache: \"pip\"\n```\n\nThe `build-push-action` for building Docker images also offers\n[caching options for GitHub Actions](https://docs.docker.com/build/cache/backends/gha/).\nIf you are not using GitHub, other remote [cache backends](https://docs.docker.com/build/cache/backends/)\nare available as well.\n\n```yaml  theme={null}\n- name: Build and push\n  id: build-docker-image\n  env:\n      GITHUB_SHA: ${{ steps.get-commit-hash.outputs.COMMIT_HASH }}\n  uses: docker/build-push-action@v5\n  with:\n    context: ${{ env.PROJECT_NAME }}/\n    push: true\n    tags: ${{ secrets.DOCKER_USERNAME }}/${{ env.PROJECT_NAME }}:${{ env.GITHUB_SHA }}-stg\n    cache-from: type=gha\n    cache-to: type=gha,mode=max\n```\n\n```\nimporting cache manifest from gha:***\nDONE 0.1s\n\n[internal] load build context\ntransferring context: 70B done\nDONE 0.0s\n\n[2/3] COPY requirements.txt requirements.txt\nCACHED\n\n[3/3] RUN pip install -r requirements.txt\nCACHED\n```\n\n## Prefect GitHub Actions\n\nPrefect provides its own GitHub Actions for [authentication](https://github.com/PrefectHQ/actions-prefect-auth)\nand [deployment creation](https://github.com/PrefectHQ/actions-prefect-deploy).\nThese actions simplify deploying with CI/CD when using `prefect.yaml`,\nespecially in cases where a repository contains flows used in multiple deployments across multiple\nPrefect Cloud workspaces.\n\nHere's an example of integrating these actions into the workflow above:\n\n```yaml  theme={null}\nname: Deploy Prefect flow\n\non:\n  push:\n    branches:\n      - main\n\njobs:\n  deploy:\n    name: Deploy\n    runs-on: ubuntu-latest\n\n    steps:\n      - name: Checkout\n        uses: actions/checkout@v4\n\n      - name: Log in to Docker Hub\n        uses: docker/login-action@v3\n        with:\n          username: ${{ secrets.DOCKER_USERNAME }}\n          password: ${{ secrets.DOCKER_PASSWORD }}\n\n      - name: Setup Python\n        uses: actions/setup-python@v5\n        with:\n          python-version: \"3.12\"\n\n      - name: Prefect Auth\n        uses: PrefectHQ/actions-prefect-auth@v1\n        with:\n          prefect-api-key: ${{ secrets.PREFECT_API_KEY }}\n          prefect-workspace: ${{ secrets.PREFECT_WORKSPACE }}\n\n      - name: Run Prefect Deploy\n        uses: PrefectHQ/actions-prefect-deploy@v4\n        with:\n          deployment-names: my-deployment\n          requirements-file-paths: requirements.txt\n```\n\n## Authenticate to other Docker image registries\n\nThe `docker/login-action` GitHub Action supports pushing images to a wide variety of image registries.\n\nFor example, if you are storing Docker images in AWS Elastic Container Registry, you can add your ECR\nregistry URL to the `registry` key in the `with:` part of the action and use an `AWS_ACCESS_KEY_ID` and\n`AWS_SECRET_ACCESS_KEY` as your `username` and `password`.\n\n```yaml  theme={null}\n- name: Login to ECR\n  uses: docker/login-action@v3\n  with:\n    registry: <aws-account-number>.dkr.ecr.<region>.amazonaws.com\n    username: ${{ secrets.AWS_ACCESS_KEY_ID }}\n    password: ${{ secrets.AWS_SECRET_ACCESS_KEY }}\n```\n\n## Further reading\n\n<TF name=\"resources\" href={home.tf} />",
  "content_length": 16752
}